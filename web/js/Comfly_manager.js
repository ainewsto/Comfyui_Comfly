export const manageDependenciesButton={dependenciesPopup:null,dependencies:[],plugins:[],selectedVersions:{},dependencyVersionsCache:{},dependencyConflictsCache:null,initialRequirements:{},comfyUIVersions:[],createButton(){const e=document.createElement("button");return e.innerHTML='\n            <svg t="1719406096593" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="913" width="30" height="30">\n                <path d="M927.232 686.08L768 526.336A369.152 369.152 0 0 0 243.2 89.6a38.4 38.4 0 0 0-9.216 60.928L392.704 307.2 307.2 392.704l-158.72-158.72a38.912 38.912 0 0 0-32.768-10.752 38.4 38.4 0 0 0-28.16 19.968A369.152 369.152 0 0 0 526.336 768l159.232 159.232a170.496 170.496 0 0 0 241.664-241.152z m-54.272 186.88a96.256 96.256 0 0 1-132.608 0L563.2 696.32a38.4 38.4 0 0 0-40.96-8.704 292.352 292.352 0 0 1-385.536-358.4l145.92 144.896a38.4 38.4 0 0 0 54.272 0l137.216-137.216a38.4 38.4 0 0 0 0-54.272L328.704 136.704a292.352 292.352 0 0 1 358.4 385.536 38.4 38.4 0 0 0 8.704 40.96l176.64 176.64a94.208 94.208 0 0 1 0.512 133.12z" fill="#fffd01" p-id="914"></path>\n            </svg>',e.style.backgroundSize="cover",e.style.backgroundRepeat="no-repeat",e.style.backgroundPosition="center",e.style.padding="0px 0px",e.style.borderRadius="5px",e.style.margin="5px",e.style.backgroundColor="rgba(255, 253, 1, 0.0)",e.style.color="white",e.style.border="none",e.style.cursor="pointer",e.addEventListener("click",(async()=>{this.dependenciesPopup?(this.dependenciesPopup.remove(),this.dependenciesPopup=null):(await this.fetchPlugins(),this.openDependenciesPopup(),this.fetchDependencies())})),e},async renderPluginVersions(e,t,n){let s=document.getElementById("versionPopup");if(!s){s=document.createElement("div"),s.id="versionPopup",s.style.position="fixed",s.style.top="50%",s.style.left="50%",s.style.transform="translate(-50%, -50%)",s.style.width="900px",s.style.height="600px",s.style.padding="20px",s.style.background="#191919",s.style.borderRadius="5px",s.style.border="2px solid #fffd01",s.style.zIndex="9999",s.style.boxShadow="0 4px 6px rgba(0, 0, 0, 0.1)",s.style.color="#fff",s.style.display="flex",s.style.flexDirection="column";let t=document.createElement("h2");t.id="versionPopupTitle",t.textContent=`Select Version for ${e}`,t.style.marginBottom="20px",s.appendChild(t);let n=document.createElement("button");n.textContent="Ã—",n.style.position="absolute",n.style.right="10px",n.style.top="10px",n.style.background="transparent",n.style.border="none",n.style.fontSize="24px",n.style.cursor="pointer",n.style.color="#fff",n.addEventListener("click",(()=>{s.remove()})),s.appendChild(n),document.body.appendChild(s)}document.getElementById("versionPopupTitle").textContent=`Select Version for ${e}`;let o=document.getElementById("versionTableContainer");o?o.innerHTML="":(o=document.createElement("div"),o.id="versionTableContainer",o.style.flexGrow="1",o.style.overflowY="auto",s.appendChild(o));let l=document.createElement("table");l.style.width="100%",l.style.borderCollapse="collapse",l.style.fontSize="14px",l.style.fontFamily="Arial, sans-serif";let r=document.createElement("thead");r.style.position="sticky",r.style.top="0",r.style.backgroundColor="#222",r.style.zIndex="1";let i=document.createElement("tr");["ID","Commit Message","Date","Version"].forEach((e=>{let t=document.createElement("th");t.textContent=e,t.style.padding="10px",t.style.textAlign="left",t.style.borderBottom="2px solid #444",t.style.fontSize="16px","Date"===e&&(t.style.width="25%"),i.appendChild(t)})),r.appendChild(i),l.appendChild(r);let d=document.createElement("tbody");t.forEach((n=>{let o=document.createElement("tr"),l=document.createElement("td"),r=document.createElement("a");r.textContent=n.id,r.href=`https://github.com/${e}/commit/${n.id}`,r.target="_blank",r.style.color="#fff",r.style.textDecoration="none",r.addEventListener("mouseover",(()=>{r.style.color="#fffd01",r.style.cursor="pointer"})),r.addEventListener("mouseout",(()=>{r.style.color="#fff",r.style.cursor="default"})),l.appendChild(r),l.style.padding="10px",l.style.borderBottom="1px solid #444",o.appendChild(l);let i=document.createElement("td");i.textContent=n.message,i.style.padding="10px",i.style.borderBottom="1px solid #444",o.appendChild(i);let a=document.createElement("td");a.textContent=n.date,a.style.padding="10px",a.style.borderBottom="1px solid #444",a.style.color="#ffffff",o.appendChild(a);let c=document.createElement("td"),p=document.createElement("input");p.type="checkbox",p.style.accentColor="#fffd01",p.style.marginLeft="10px";const y=localStorage.getItem("selectedComfyUIVersion");p.checked=n.id===y;const u=JSON.parse(localStorage.getItem("selectedVersions"))||{};p.checked=n.id===u[e],p.addEventListener("change",(async o=>{if(o.target.checked){const o=await this.selectPluginVersion(e,n.id);this.selectedVersions[e]=n.id,localStorage.setItem("selectedVersions",JSON.stringify(this.selectedVersions));let l=document.createElement("div");l.classList.add("message"),o?(l.textContent=`Successfully switched to version ${n.id} of plugin ${e}`,l.style.backgroundColor="#fffd01"):(l.textContent=`Failed to switch version for plugin ${e}`,l.style.backgroundColor="#dc3545"),l.style.padding="10px",l.style.marginBottom="10px",l.style.color="#191919",l.style.borderRadius="4px",s.appendChild(l),setTimeout((()=>{l.remove()}),2e3),await this.fetchPlugins(),this.showPluginsTab(),this.renderPluginVersions(e,t,this.selectedVersions[e])}else delete this.selectedVersions[e],localStorage.setItem("selectedVersions",JSON.stringify(this.selectedVersions)),await this.fetchPlugins(),this.showPluginsTab(),this.renderPluginVersions(e,t,null)})),c.appendChild(p),c.style.padding="10px",c.style.borderBottom="1px solid #444",o.appendChild(c),d.appendChild(o)})),l.appendChild(d),o.appendChild(l),s.addEventListener("click",(e=>{e.stopPropagation()}))},async openDependenciesPopup(){this.initialRequirements=JSON.parse(localStorage.getItem("initialRequirements"))||{};let e=document.createElement("div");e.classList.add("comfly-manager-popup"),e.style.paddingBottom="50px",e.style.position="fixed",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.width="900px",e.style.height="600px",e.style.padding="20px",e.style.background="#191919",e.style.border="2px solid #fffd01",e.style.borderRadius="5px",e.style.zIndex="2000",e.style.boxShadow="0 4px 6px rgba(0, 0, 0, 0.1)",e.style.display="flex",e.style.flexDirection="column",e.style.color="#fff";let t=document.createElement("div");t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="space-between",t.style.marginBottom="20px";let n=document.createElement("h2");n.textContent="Comfly Manager",n.style.color="#fff",n.style.margin="0",t.appendChild(n);let s=document.createElement("div");s.style.display="flex",s.style.alignItems="center";let o=document.createElement("button");o.textContent="-",o.style.background="transparent",o.style.border="none",o.style.fontSize="24px",o.style.cursor="pointer",o.style.color="#fff",o.style.marginRight="10px",o.addEventListener("click",(()=>{if(e.classList.contains("minimized")){e.classList.remove("minimized"),e.style.width="900px",e.style.height="600px",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.padding="20px",e.style.borderRadius="5px",o.textContent="-";let s=e.children;for(let e=0;e<s.length;e++)s[e]===t||s[e].classList.contains("status-message")||(s[e].style.display="block");n.style.fontSize="24px",t.style.cursor="default";let l=e.querySelector(".minimized-status-message");l&&l.remove()}else{e.classList.add("minimized"),e.style.width="200px",e.style.height="30px",e.style.top="auto",e.style.bottom="60px",e.style.left="10px",e.style.padding="2px",e.style.borderRadius="17px",e.style.transform="none",o.textContent="+";let s=e.children;for(let e=0;e<s.length;e++)s[e]===t||s[e].classList.contains("status-message")||(s[e].style.display="none");n.style.fontSize="14px",t.style.cursor="move"}})),s.appendChild(o);let l=document.createElement("button");l.textContent="Ã—",l.style.background="transparent",l.style.border="none",l.style.fontSize="24px",l.style.cursor="pointer",l.style.color="#fff",l.addEventListener("click",(()=>{e.remove(),this.dependenciesPopup=null})),s.appendChild(l),t.appendChild(s),e.appendChild(t);let r=!1,i=0,d=0;t.addEventListener("mousedown",(t=>{e.classList.contains("minimized")&&(r=!0,i=t.clientX-e.getBoundingClientRect().left,d=e.getBoundingClientRect().bottom-t.clientY)})),document.addEventListener("mousemove",(t=>{r&&(e.style.left=t.clientX-i+"px",e.style.bottom=window.innerHeight-t.clientY-d+"px")})),document.addEventListener("mouseup",(()=>{r=!1}));let a=document.createElement("div");a.style.display="flex",a.style.marginBottom="20px";let c=document.createElement("button");c.textContent="Dependencies",c.style.padding="10px 20px",c.style.borderRadius="4px",c.style.backgroundColor="#fffd01",c.style.color="#191919",c.style.border="none",c.style.cursor="pointer",c.addEventListener("click",(()=>{this.showDependenciesTab(),this.setActiveTab(c)})),a.appendChild(c);let p=document.createElement("button");p.textContent="ComfyUI",p.style.padding="10px 20px",p.style.borderRadius="4px",p.style.backgroundColor="#444",p.style.color="#191919",p.style.border="none",p.style.cursor="pointer",p.addEventListener("click",(()=>{this.showComfyUITab(),this.setActiveTab(p)})),a.appendChild(p);let y=document.createElement("button");y.textContent="Plugins",y.style.padding="10px 20px",y.style.borderRadius="4px",y.style.backgroundColor="#444",y.style.color="#191919",y.style.border="none",y.style.cursor="pointer",y.addEventListener("click",(()=>{this.showPluginsTab(),this.setActiveTab(y)})),a.appendChild(y),e.appendChild(a);let u=document.createElement("div");u.id="notificationContainer",u.style.position="absolute",u.style.top="10px",u.style.left="50%",u.style.transform="translateX(-50%)",u.style.zIndex="9999",e.appendChild(u);let h=document.createElement("div");h.id="pluginsContainer",h.style.display="none";let g=document.createElement("div");g.style.flexGrow="1",g.style.overflowY="auto";let m=document.createElement("div");m.id="dependenciesContainer",g.appendChild(m);let f=document.createElement("div");if(f.id="comfyuiContainer",f.style.display="none",g.appendChild(f),g.appendChild(h),e.appendChild(g),document.body.appendChild(e),this.dependenciesPopup=e,0===this.comfyUIVersions.length)try{if(this.comfyUIVersions=await this.fetchComfyUIVersions(),localStorage.setItem("comfyUIVersions",JSON.stringify(this.comfyUIVersions)),this.comfyUIVersions.length>0&&!localStorage.getItem("selectedComfyUIVersion")){const e=this.comfyUIVersions[0].id;await this.selectComfyUIVersion(e)}}catch(e){console.error("Error fetching ComfyUI versions:",e)}this.showDependenciesTab(),this.setActiveTab(c),this.selectedVersions=JSON.parse(localStorage.getItem("selectedVersions"))||{}},setActiveTab(e){const t=e.parentElement.children;for(let n of t)n.style.backgroundColor=n===e?"#fffd01":"#444"},async fetchDependencies(){try{const e=await fetch("http://localhost:8080/get_dependencies");if(!e.ok)throw new Error("Error fetching dependencies");{let t=await e.json(),n=document.getElementById("dependenciesCount");n&&(n.textContent=t.length),this.renderDependencies(t,document.getElementById("dependenciesList")),this.dependencies=t,localStorage.setItem("dependencies",JSON.stringify(t));let s=document.getElementById("loadingMessage");s&&s.remove()}}catch(e){console.error("Error fetching dependencies:",e)}},async showDependenciesTab(){let e=document.getElementById("dependenciesContainer"),t=document.getElementById("comfyuiContainer"),n=document.getElementById("pluginsContainer");e.style.display="block",t.style.display="none",n.style.display="none",e.innerHTML="";let s=document.createElement("div");s.style.display="flex",s.style.alignItems="center",s.style.marginBottom="0px",s.style.position="sticky",s.style.top="0",s.style.backgroundColor="#191919",s.style.zIndex="1",s.style.padding="0px",s.style.marginLeft="-10px";let o=document.createElement("div");o.style.position="relative",o.style.marginRight="20px";let l=document.createElement("input");l.type="text",l.placeholder="Search dependencies...",l.style.padding="10px 44px 10px 10px",l.style.width="300px",l.style.border="1px solid #ccc",l.style.borderRadius="4px",l.addEventListener("input",(()=>{this.filterDependencies(l.value)})),o.appendChild(l);let r=document.createElement("button");r.innerHTML='<svg t="1719406809172" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="64362" style="width:45px;height:45px;margin-left:-35px;"><path d="M480 531.2V224c0-19.2 12.8-32 32-32s32 12.8 32 32v307.2l73.6-73.6c12.8-12.8 32-12.8 44.8 0 12.8 12.8 12.8 32 0 44.8l-128 128c-12.8 12.8-32 12.8-44.8 0l-128-128c-12.8-12.8-12.8-32 0-44.8 12.8-12.8 32-12.8 44.8 0l73.6 73.6zM160 576c0-19.2 12.8-32 32-32s32 12.8 32 32v160c0 19.2 12.8 32 32 32h512c19.2 0 32-12.8 32-32v-160c0-19.2 12.8-32 32-32s32 12.8 32 32v160c0 54.4-41.6 96-96 96H256c-54.4 0-96-41.6-96-96v-160z" p-id="64363" fill="#fffd01"></path></svg>',r.title="Install dependencies",r.style.padding="10px 20px",r.style.borderRadius="4px",r.style.backgroundColor="#fffd0100",r.style.color="#191919",r.style.border="none",r.style.cursor="pointer",r.addEventListener("click",(()=>this.installDependency(l.value)));let i=document.createElement("div");i.style.marginLeft="auto",i.style.display="flex",i.style.alignItems="center",i.style.backgroundColor="#fffd01",i.style.padding="6px 10px",i.style.borderRadius="4px";let d=document.createElement("span");d.textContent="Dependencies: ",d.style.marginRight="5px",d.style.color="#191919",i.appendChild(d);let a=document.createElement("span");a.id="dependenciesCount",a.textContent="0",a.style.color="#191919",i.appendChild(a);let c=document.createElement("span");c.style.marginLeft="10px",c.style.color="#191919",s.appendChild(c);let p=document.createElement("button");p.innerHTML='<svg t="1719406989927" class="icon" viewBox="0 0 1026 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="69837" style="width:31px;height:31px;"><path d="M950.857143 394.971429l-124.342857 438.857142c-7.314286 21.942857-36.571429 43.885714-58.514286 43.885715h-658.285714c-7.314286 0-14.628571 0-21.942857-7.314286 0-7.314286-7.314286-14.628571 0-21.942857l124.342857-438.857143c7.314286-21.942857 36.571429-43.885714 58.514285-43.885714h658.285715c7.314286 0 14.628571 0 14.628571 7.314285 7.314286 0 7.314286 7.314286 7.314286 21.942858zM73.142857 109.714286c0-21.942857 14.628571-36.571429 36.571429-36.571429h234.057143l65.828571 124.342857c0 14.628571 14.628571 21.942857 29.257143 21.942857h402.285714c21.942857 0 36.571429 14.628571 36.571429 36.571429V292.571429H270.628571C219.428571 292.571429 160.914286 336.457143 146.285714 394.971429L73.142857 643.657143V109.714286z m936.228572 219.428571c-14.628571-21.942857-36.571429-29.257143-58.514286-36.571428v-36.571429c0-58.514286-51.2-109.714286-109.714286-109.714286H460.8L394.971429 21.942857C394.971429 7.314286 380.342857 0 365.714286 0H109.714286C51.2 0 0 51.2 0 109.714286v731.428571c0 36.571429 21.942857 73.142857 43.885714 87.771429h7.314286c14.628571 14.628571 36.571429 21.942857 58.514286 21.942857h658.285714c58.514286 0 109.714286-43.885714 131.657143-102.4l124.342857-438.857143c7.314286-29.257143 0-58.514286-14.628571-80.457143z" p-id="69838" fill="#fffd01"></path></svg>',p.title="Open site-packages folder",p.style.padding="0",p.style.borderRadius="4px",p.style.backgroundColor="transparent",p.style.border="none",p.style.cursor="pointer",p.style.marginLeft="15px",p.style.fontSize="10px",p.addEventListener("click",(()=>this.openSitePackagesFolder()));let y=document.createElement("button");function u(e){let t=document.createElement("div");t.style.position="fixed",t.style.top="50%",t.style.left="50%",t.style.transform="translate(-50%, -50%)",t.style.width="600px",t.style.height="400px",t.style.overflowY="auto",t.style.padding="20px",t.style.background="#191919",t.style.borderRadius="5px",t.style.border="2px solid #fffd01",t.style.zIndex="9999",t.style.boxShadow="0 4px 6px rgba(0, 0, 0, 0.1)",t.style.color="#fff",t.style.fontSize="16px";let n=document.createElement("button");n.textContent="Ã—",n.style.position="absolute",n.style.right="10px",n.style.top="10px",n.style.background="transparent",n.style.border="none",n.style.fontSize="20px",n.style.cursor="pointer",n.style.color="#fff",n.addEventListener("click",(()=>{t.remove()})),t.appendChild(n);let s=document.createElement("h3");s.textContent="Dependency Conflicts",s.style.marginBottom="15px",t.appendChild(s);let o=document.createElement("div");o.style.whiteSpace="pre-wrap",o.style.backgroundColor="#3d3d3f",o.style.padding="10px",o.style.borderRadius="4px",o.style.height="300px",o.style.overflowY="auto",e.split("\n").forEach((e=>{let t=e.replace(/\s+/g," ").trim();if(t.includes("but you have")){let e=t.split("but you have"),n=e[0].trim(),s="but you have "+e[1].trim(),l=document.createElement("span");l.appendChild(document.createTextNode(n));let r=document.createElement("span");r.style.whiteSpace="nowrap",r.appendChild(document.createTextNode(s)),l.appendChild(r),o.appendChild(l)}else{let e=document.createElement("span");e.appendChild(document.createTextNode(t)),o.appendChild(e)}o.appendChild(document.createElement("br"))})),t.appendChild(o),document.body.appendChild(t)}y.innerHTML='\n            <svg t="1719407034802" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="71782" width="40" height="40">\n                <path d="M511.835 737.304c20.501 0.188 37.272-16.281 37.459-36.788 0.187-20.5-16.281-37.272-36.782-37.46-20.507-0.188-37.279 16.281-37.466 36.78-0.187 20.508 16.282 37.281 36.789 37.468" fill="#d81e06" p-id="71783"></path>\n                <path d="M919.942 772.474L576.303 177.275c-28.58-49.5-100.027-49.5-128.606 0L104.059 772.474c-28.58 49.502 7.145 111.376 64.302 111.376h687.277c57.159 0 92.882-61.874 64.304-111.376z m-750.764 36.419L512 215.108l342.823 593.785H169.178z" fill="#d81e06" p-id="71784"></path>\n                <path d="M530.935 405.739h-37.53c-10.098 0-18.36 8.262-18.36 18.36v171.256c0 10.098 8.262 18.36 18.36 18.36h37.53c10.098 0 18.36-8.262 18.36-18.36V424.1c0-10.098-8.262-18.361-18.36-18.361z" fill="#d81e06" p-id="71785"></path>\n            </svg>',y.title="Check Dependency Conflicts",y.style.padding="0",y.style.borderRadius="4px",y.style.backgroundColor="transparent",y.style.border="none",y.style.cursor="pointer",y.style.marginLeft="10px",y.addEventListener("click",(async function(){if(manageDependenciesButton.dependencyConflictsCache)u(manageDependenciesButton.dependencyConflictsCache);else{let t=document.createElement("div");t.id="conflictLoadingPopup",t.innerHTML="ðŸ”” Checking dependency conflicts...<br>Please wait patiently as there are many dependency files to check.",t.style.position="absolute",t.style.top="50%",t.style.left="50%",t.style.transform="translate(-50%, -50%)",t.style.padding="10px",t.style.textAlign="center",t.style.backgroundColor="rgba(255, 0, 0, 0.6)",t.style.color="#fff",t.style.borderRadius="5px",t.style.lineHeight="1.5",t.style.height="auto",t.style.width="700px",t.style.zIndex="9999",e.appendChild(t);try{const n=await fetch("http://localhost:8080/check_dependency_conflicts",{method:"POST"});t.parentNode===e&&e.removeChild(t);const s=await n.text();manageDependenciesButton.dependencyConflictsCache=s,u(s)}catch(n){t.parentNode===e&&e.removeChild(t),console.error("Error checking dependency conflicts:",n)}}})),s.appendChild(o),s.appendChild(r),s.appendChild(i),s.appendChild(p),s.appendChild(y),e.appendChild(s);let h=document.createElement("div");h.id="dependenciesList",h.style.maxHeight="calc(100% - 120px)",h.style.overflowY="auto",e.appendChild(h);let g=document.createElement("div");g.id="loadingMessage",g.innerHTML="ðŸ”” Checking dependency conflicts...<br>Please wait patiently as there are many dependency files to check.",g.style.position="absolute",g.style.top="50%",g.style.left="50%",g.style.transform="translate(-50%, -50%)",g.style.padding="10px",g.style.textAlign="center",g.style.backgroundColor="rgba(255, 0, 0, 0.6)",g.style.color="#fff",g.style.borderRadius="5px",g.style.lineHeight="1.5",g.style.height="auto",g.style.width="700px",e.appendChild(g);const m=localStorage.getItem("dependencies");if(m){this.dependencies=JSON.parse(m),this.renderDependencies(this.dependencies,document.getElementById("dependenciesList")),document.getElementById("dependenciesCount").textContent=this.dependencies.length;let e=document.getElementById("loadingMessage");e&&e.remove()}else{await this.fetchDependencies();let e=document.getElementById("loadingMessage");e&&e.remove()}},async installDependencyVersion(e,t){try{let n=document.querySelector("#dependenciesContainer .message");n&&n.remove();let s=document.createElement("div");s.classList.add("message"),s.textContent=`Installing dependency: ${e}==${t}`,s.style.padding="10px",s.style.marginBottom="10px",s.style.backgroundColor="#fffd01",s.style.color="#191919",s.style.borderRadius="4px",document.getElementById("notificationContainer").appendChild(s);const o=await fetch(`http://localhost:8080/install_dependency_version?name=${e}&version=${t}`,{method:"POST"}),l=await o.json();o.ok?(s.textContent=`Dependency installed successfully: ${e}==${t}`,s.style.backgroundColor="#45dd68"):(s.textContent=`Dependency installed successfully: ${e}==${t}`,s.style.backgroundColor="#45dd68",console.error("Installation error:"),console.error(l.error)),setTimeout((()=>{s.remove()}),2e3),await this.fetchDependencies(),this.renderDependencies(this.dependencies,document.getElementById("dependenciesList"))}catch(e){console.error("Error installing dependency:",e)}},async renderDependencies(e,t){if(t){if(t.innerHTML="",0===e.length){let e=document.createElement("div");return e.textContent="No dependencies found.",e.style.padding="10px",e.style.textAlign="center",void t.appendChild(e)}e.forEach((e=>{let n=document.createElement("div");n.textContent=e,n.style.padding="12px",n.style.borderBottom="1px solid #444",n.style.display="flex",n.style.justifyContent="space-between",n.style.alignItems="center",n.style.backgroundColor="transparent",n.style.color="#fff";let s=document.createElement("div"),o=document.createElement("button");o.textContent="Install",o.style.padding="6px 12px",o.style.borderRadius="4px",o.style.backgroundColor="#fffd01",o.style.color="#191919",o.style.border="none",o.style.cursor="pointer",o.addEventListener("click",(async()=>{let t=e.split("==")[0],n=await this.getDependencyVersions(t);this.showDependencyVersionsPopup(t,n)})),o.style.marginRight="10px",s.appendChild(o);let l=document.createElement("button");l.textContent="Uninstall",l.style.padding="6px 12px",l.style.borderRadius="4px",l.style.backgroundColor="#dc3545",l.style.color="#fff",l.style.border="none",l.style.cursor="pointer",l.addEventListener("click",(()=>this.manageDependency(e.split("==")[0],"uninstall"))),s.appendChild(l),n.appendChild(s),t.appendChild(n)}))}else console.error("dependenciesList container not found")},async getDependencyVersions(e){if(this.dependencyVersionsCache[e])return this.dependencyVersionsCache[e];try{let t=document.createElement("div");t.id="loadingPopup",t.innerHTML="ðŸ”” Getting versions for dependency...<br>Please wait patiently as there are many versions to load.",t.style.position="absolute",t.style.top="50%",t.style.left="50%",t.style.transform="translate(-50%, -50%)",t.style.padding="10px",t.style.textAlign="center",t.style.backgroundColor="rgba(255, 0, 0, 0.6)",t.style.color="#fff",t.style.borderRadius="5px",t.style.lineHeight="1.5",t.style.height="auto",t.style.width="700px",t.style.zIndex="9999",document.body.appendChild(t);const n=await fetch(`http://localhost:8080/get_dependency_versions?name=${e}`);if(document.body.removeChild(t),n.ok){const t=(await n.json()).map((e=>e.split("==")[1]));return this.dependencyVersionsCache[e]=t,t}throw console.error("Error fetching dependency versions. Status:",n.status),new Error("Error fetching dependency versions")}catch(e){return console.error("Error fetching dependency versions:",e),[]}},async openModuleVersionPopup(){let e=document.createElement("div");e.style.position="fixed",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.width="400px",e.style.maxHeight="400px",e.style.overflowY="auto",e.style.padding="20px",e.style.background="#191919",e.style.borderRadius="5px",e.style.border="2px solid #fffd01",e.style.zIndex="9999",e.style.boxShadow="0 4px 6px rgba(0, 0, 0, 0.1)",e.style.color="#fff";let t=document.createElement("button");t.textContent="Ã—",t.style.position="absolute",t.style.right="10px",t.style.top="10px",t.style.background="transparent",t.style.border="none",t.style.fontSize="20px",t.style.cursor="pointer",t.style.color="#fff",t.addEventListener("click",(()=>{e.remove()})),e.appendChild(t);let n=document.createElement("h3");n.textContent="Search Module Version",n.style.marginBottom="10px",e.appendChild(n);let s=document.createElement("div");s.style.marginBottom="10px";let o=document.createElement("label");o.textContent="Module Path:",o.style.display="block",o.style.marginBottom="5px",s.appendChild(o);let l=document.createElement("input");l.type="text",l.style.width="calc(100% - 12px)",l.style.padding="5px",l.style.borderRadius="4px",l.style.border="1px solid #ccc",l.addEventListener("keypress",(async e=>{if("Enter"===e.key){let e=l.value.trim();if(e)if(e.includes("==")){let[t,n]=e.split("=="),s=await this.fetchDependencyVersions(t),o=await this.checkModuleVersion(t,n,s);r.textContent=o}else{let t=await this.getModuleVersion(e);r.textContent=t}}})),s.appendChild(l),e.appendChild(s);let r=document.createElement("div");r.style.maxHeight="200px",r.style.overflowY="auto",r.style.backgroundColor="#3d3d3f",r.style.padding="10px",r.style.borderRadius="4px",r.style.width="calc(100% - 20px)",e.appendChild(r),document.body.appendChild(e)},async fetchDependencyVersions(e){try{const t=await fetch(`http://localhost:8080/get_dependency_versions?name=${e}`);if(t.ok){const e=await t.json();return e.map((e=>e.split("==")[1]))}throw console.error("Error fetching dependency versions. Status:",t.status),new Error("Error fetching dependency versions")}catch(e){return console.error("Error fetching dependency versions:",e),[]}},checkModuleVersion:async(e,t,n)=>n.includes(t)?`The version ${t} exists for module ${e}.`:`The version ${t} does not exist for module ${e}.`,async getModuleVersion(e){try{const t=await fetch(`http://localhost:8080/get_module_version?module_path=${encodeURIComponent(e)}`);if(t.ok){return await t.text()}throw new Error("Error fetching module version")}catch(e){return console.error("Error fetching module version:",e),"Error fetching module version"}},async showDependencyVersionsPopup(e,t){const n=this.dependencyVersionsCache[e];let s;n?t=n:(s=document.createElement("div"),s.id="loadingPopup",s.innerHTML="ðŸ”” Getting versions for dependency...<br>Please wait patiently as there are many versions to load.",s.style.position="absolute",s.style.top="50%",s.style.left="50%",s.style.transform="translate(-50%, -50%)",s.style.padding="10px",s.style.textAlign="center",s.style.backgroundColor="rgba(255, 0, 0, 0.6)",s.style.color="#fff",s.style.borderRadius="5px",s.style.lineHeight="1.5",s.style.height="auto",s.style.width="700px",s.style.zIndex="9999",document.body.appendChild(s),this.dependencyVersionsCache[e]=t);let o=document.createElement("div");o.style.position="fixed",o.style.top="50%",o.style.left="50%",o.style.transform="translate(-50%, -50%)",o.style.width="400px",o.style.height="300px",o.style.overflowY="auto",o.style.padding="20px",o.style.background="#191919",o.style.borderRadius="5px",o.style.border="2px solid #fffd01",o.style.zIndex="9999",o.style.boxShadow="0 4px 6px rgba(0, 0, 0, 0.1)",o.style.color="#fff";let l=document.createElement("button");l.textContent="Ã—",l.style.position="absolute",l.style.right="10px",l.style.top="10px",l.style.background="transparent",l.style.border="none",l.style.fontSize="20px",l.style.cursor="pointer",l.style.color="#fff",l.addEventListener("click",(()=>{o.remove()})),o.appendChild(l);let r=document.createElement("h3");r.textContent=`Versions for ${e}`,r.style.marginBottom="10px",o.appendChild(r);let i=document.createElement("div");i.style.maxHeight="200px",i.style.overflowY="auto",i.style.backgroundColor="#3d3d3f",i.style.padding="5px",i.style.borderRadius="4px",o.appendChild(i);let d=null;function a(e){let t=e.target;i.querySelectorAll(".line").forEach((e=>e.classList.remove("highlight"))),t.classList.add("highlight"),d=t.getAttribute("data-version")}t.forEach((t=>{let n=document.createElement("div");n.classList.add("line"),n.textContent=`${e}==${t}`,n.setAttribute("data-version",t),n.addEventListener("click",a),n.style.color="#ffffff",n.style.fontSize="16px",i.appendChild(n)}));let c=document.createElement("style");c.innerHTML="\n            .line {\n                padding: 5px;\n                cursor: pointer;\n            }\n            .highlight {\n                background-color: #fffd016e;\n            }\n        ",o.appendChild(c);let p=document.createElement("button");p.textContent="Install",p.style.marginTop="10px",p.style.padding="5px 10px",p.style.borderRadius="4px",p.style.backgroundColor="#fffd01",p.style.color="#191919",p.style.border="none",p.style.cursor="pointer",p.addEventListener("click",(async()=>{d&&await this.installDependencyVersion(e,d)})),o.appendChild(p),s&&document.body.removeChild(s),this.dependencyVersionsPopup=o,document.body.appendChild(o)},async openSitePackagesFolder(){try{if(!(await fetch("http://localhost:8080/open_site_packages_folder",{method:"POST"})).ok)throw new Error("Error opening site-packages folder");console.log("Opened site-packages folder")}catch(e){console.error("Error opening site-packages folder:",e)}},filterDependencies(e){let t=this.dependencies.filter((t=>t.toLowerCase().includes(e.toLowerCase()))),n=document.getElementById("dependenciesList");this.renderDependencies(t,n),document.getElementById("dependenciesCount").textContent=t.length},async installDependency(e){if(e)try{let t=document.querySelector("#dependenciesContainer .message");t&&t.remove();let n=document.createElement("div");n.classList.add("message"),n.textContent=`Installing dependency: ${e}`,n.style.padding="10px",n.style.marginBottom="10px",n.style.backgroundColor="#fffd01",n.style.color="#191919",n.style.borderRadius="4px",document.getElementById("notificationContainer").appendChild(n);const s=await fetch(`http://localhost:8080/install_dependency?name=${e}`,{method:"POST"}),o=await s.json();s.ok?(n.textContent=`Dependency installed successfully: ${e}`,n.style.backgroundColor="#45dd68"):(n.textContent=`Error installing dependency: ${e}`,n.style.backgroundColor="#dc3545",console.error("Installation error:"),console.error(o.error)),setTimeout((()=>{n.remove()}),2e3),await this.fetchDependencies(),this.showDependenciesTab()}catch(e){console.error("Error installing dependency:",e)}},async manageDependency(e,t){if("uninstall"===t){if(!confirm(`Are you sure you want to uninstall dependency: ${e}?`))return}try{let n=document.querySelector("#dependenciesContainer .message");n&&n.remove();let s=document.createElement("div");s.classList.add("message"),s.textContent=`${"uninstall"===t?"Uninstalling":"Managing"} dependency: ${e}`,s.style.padding="10px",s.style.marginBottom="10px",s.style.backgroundColor="#fffd01",s.style.color="#191919",s.style.borderRadius="4px",document.getElementById("notificationContainer").appendChild(s);if(!(await fetch(`http://localhost:8080/manage_dependency?name=${e}&action=${t}`,{method:"POST"})).ok)throw s.textContent=`Error ${"uninstall"===t?"uninstalling":"managing"} dependency: ${e}`,s.style.backgroundColor="#dc3545",new Error(`Error ${t}ing dependency`);console.log(`${t} dependency: ${e}`),s.textContent=`Dependency ${"uninstall"===t?"uninstalled":"managed"} successfully: ${e}`,s.style.backgroundColor="#fffd01",await this.fetchDependencies(),this.showDependenciesTab(),setTimeout((()=>{s.remove()}),2e3)}catch(e){console.error(`Error ${t}ing dependency:`,e)}},async showComfyUITab(){let e=document.getElementById("dependenciesContainer"),t=document.getElementById("comfyuiContainer"),n=document.getElementById("pluginsContainer");e.style.display="none",t.style.display="block",n.style.display="none",t.innerHTML="";let s=document.createElement("button");s.innerHTML='\n            <svg t="1719407115924" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="74856" width="31" height="31">\n                <path d="M577.6 825.6c-102.4 20.8-212.8-8-291.2-86.4-116.8-116.8-124.8-299.2-24-424v59.2c0 17.6 14.4 32 32 32s32-14.4 32-32v-128c0-9.6-3.2-17.6-9.6-22.4-6.4-6.4-14.4-9.6-22.4-9.6h-128c-17.6 0-32 14.4-32 32s14.4 32 32 32h44.8C91.2 427.2 102.4 644.8 240 784c96 96 228.8 129.6 352 104 4.8-1.6 11.2-4.8 14.4-8 12.8-12.8 12.8-32 0-44.8-6.4-9.6-19.2-12.8-28.8-9.6zM859.2 747.2H816c116.8-150.4 107.2-368-32-507.2-89.6-89.6-211.2-124.8-328-108.8-8 0-14.4 3.2-20.8 9.6-12.8 12.8-12.8 32 0 44.8 8 8 19.2 11.2 30.4 8 96-14.4 198.4 16 272 89.6 116.8 116.8 124.8 299.2 24 424v-59.2c0-17.6-14.4-32-32-32s-32 14.4-32 32v128c0 9.6 3.2 17.6 9.6 22.4 6.4 6.4 14.4 9.6 22.4 9.6h128c17.6 0 32-14.4 32-32s-12.8-28.8-30.4-28.8z" fill="#fffd01" p-id="74857"></path>\n            </svg>',s.title="Refresh comfyui",s.style.position="absolute",s.style.top="85px",s.style.right="20px",s.style.padding="9px 10px",s.style.borderRadius="4px",s.style.backgroundColor="#fffd0100",s.style.color="#191919",s.style.border="none",s.style.cursor="pointer",s.addEventListener("click",(async()=>{await this.updateComfyUIVersions()})),t.appendChild(s);let o=document.createElement("div");o.style.overflowY="auto",o.style.maxHeight="460px",o.style.marginBottom="10px",o.style.position="relative";let l=document.createElement("div");l.style.position="absolute",l.style.top="10px",l.style.right="10px",l.style.fontSize="14px",l.style.color="#fff",o.appendChild(l);try{let e=await this.fetchCurrentComfyUIVersion();localStorage.getItem("selectedComfyUIVersion");l.textContent=`Used ID: ${e}`}catch(e){console.error("Error fetching current ComfyUI version:",e),l.textContent="Unable to fetch current version"}let r=document.createElement("table");r.style.width="100%",r.style.height="100%",r.style.borderCollapse="collapse";let i=document.createElement("thead");i.style.position="sticky",i.style.top="0",i.style.backgroundColor="#222",i.style.zIndex="1";let d=document.createElement("tr");["ID","Commit Message","Date","Version"].forEach((e=>{let t=document.createElement("th");t.textContent=e,t.style.padding="10px",t.style.textAlign="left",t.style.borderBottom="2px solid #444",t.style.fontSize="14px",d.appendChild(t)})),i.appendChild(d),r.appendChild(i);let a=document.createElement("tbody");r.appendChild(a),o.appendChild(r),t.appendChild(o);const c=localStorage.getItem("comfyUIVersions");if(c)this.comfyUIVersions=JSON.parse(c);else try{this.comfyUIVersions=await this.fetchComfyUIVersions(),localStorage.setItem("comfyUIVersions",JSON.stringify(this.comfyUIVersions))}catch(e){console.error("Error fetching ComfyUI versions:",e),this.comfyUIVersions=[]}const p=localStorage.getItem("selectedComfyUIVersion");if(this.renderComfyUIVersions(this.comfyUIVersions,a,p),!p&&this.comfyUIVersions.length>0){const e=this.comfyUIVersions[0].id;await this.selectComfyUIVersion(e)}},async updateComfyUIVersions(){try{this.showStatusMessage("Updating ComfyUI versions..."),localStorage.removeItem("comfyUIVersions"),localStorage.removeItem("currentComfyUIVersion"),this.comfyUIVersions=await this.fetchComfyUIVersions(),localStorage.setItem("comfyUIVersions",JSON.stringify(this.comfyUIVersions));let e=await this.fetchCurrentComfyUIVersion(),t=document.querySelector("#comfyuiContainer div[style*='position: absolute']");t&&(t.textContent=`Used ID: ${e}`),this.renderComfyUIVersions(this.comfyUIVersions,document.querySelector("#comfyuiContainer tbody")),this.showStatusMessage(`Successfully switched to version ${versionId}`,"success",2e3,this.dependenciesPopup)}catch(e){console.error("Error updating ComfyUI versions:",e),this.showStatusMessage("Error updating ComfyUI versions. Please try again.","error")}},async fetchComfyUIVersions(){const e=localStorage.getItem("comfyUIVersions");if(e)return JSON.parse(e);try{let e=document.createElement("div");e.id="loadingPopup",e.innerHTML="ðŸ”” Getting versions for ComfyUI...<br>Please wait patiently as there are many versions to load.",e.style.position="absolute",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.padding="10px",e.style.textAlign="center",e.style.backgroundColor="rgba(255, 0, 0, 0.6)",e.style.color="#fff",e.style.borderRadius="5px",e.style.lineHeight="1.5",e.style.height="auto",e.style.width="700px",e.style.zIndex="9999",document.body.appendChild(e);const t=await fetch("http://localhost:8080/get_comfyui_versions");if(document.body.removeChild(e),t.ok){let e=await t.json();return localStorage.setItem("comfyUIVersions",JSON.stringify(e)),e}throw new Error("Error fetching ComfyUI versions")}catch(e){return console.error("Error fetching ComfyUI versions:",e),[]}},async fetchCurrentComfyUIVersion(){const e=localStorage.getItem("currentComfyUIVersion");if(e)return e;try{const e=await fetch("http://localhost:8080/get_current_comfyui_version");if(e.ok){let t=await e.text();return localStorage.setItem("currentComfyUIVersion",t),t}throw new Error("Error fetching current ComfyUI version")}catch(e){return console.error("Error fetching current ComfyUI version:",e),""}},renderComfyUIVersions(e,t,n){if(t.innerHTML="",!Array.isArray(e)||0===e.length){let e=document.createElement("div");return e.textContent="No ComfyUI versions found.",e.style.padding="10px",e.style.textAlign="center",void t.appendChild(e)}e.forEach((e=>{let s=document.createElement("tr"),o=document.createElement("td"),l=document.createElement("a");l.textContent=e.id,l.href=`https://github.com/comfyanonymous/ComfyUI/commit/${e.id}`,l.target="_blank",l.style.color="#fff",l.style.textDecoration="none",l.addEventListener("mouseover",(()=>{l.style.color="#fffd01",l.style.cursor="pointer"})),l.addEventListener("mouseout",(()=>{l.style.color="#fff",l.style.cursor="default"})),o.appendChild(l),o.style.padding="10px",o.style.borderBottom="1px solid #444",s.appendChild(o);let r=document.createElement("td");r.textContent=e.message,r.style.padding="10px",r.style.borderBottom="1px solid #444",s.appendChild(r);let i=document.createElement("td");i.textContent=new Date(e.date).toLocaleString(),i.style.padding="10px",i.style.borderBottom="1px solid #444",s.appendChild(i);let d=document.createElement("td"),a=document.createElement("input");a.type="checkbox",a.style.accentColor="#fffd01",a.style.marginLeft="10px";const c=localStorage.getItem("selectedComfyUIVersion")||null;a.checked=e.id===c,a.addEventListener("change",(async t=>{if(e.id===n&&(a.checked=!0),t.target.checked){document.querySelectorAll('input[type="checkbox"]').forEach((e=>{e!==t.target&&(e.checked=!1)}));try{await this.selectComfyUIVersion(e.id)}catch(e){t.target.checked=!1}}else t.preventDefault(),this.showStatusMessage("Please select a version","warning")})),d.appendChild(a),d.style.padding="10px",d.style.borderBottom="1px solid #444",s.appendChild(d),t.appendChild(s)}))},async selectComfyUIVersion(e){try{const t=await fetch(`http://localhost:8080/select_comfyui_version?version_id=${e}`,{method:"POST"});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);console.log(`Selected ComfyUI version: ${e}`),localStorage.setItem("selectedComfyUIVersion",e),this.selectedComfyUIVersion=e}catch(e){throw console.error("Error selecting ComfyUI version:",e),e}},showStatusMessage(e,t="success",n=2e3,s=null,o=null){if(!s&&!(s=document.querySelector(".comfly-manager-popup")))return void console.error("Comfly Manager popup not found");let l=s.querySelector(".status-message");l&&l.remove();let r=document.createElement("div");return r.classList.add("status-message"),r.textContent=e,r.style.padding="10px",r.style.margin="0",r.style.color="#191919",r.style.borderRadius="15px",r.style.textAlign="center",r.style.position="absolute",r.style.zIndex="9999",r.style.boxShadow="0 2px 10px rgba(0,0,0,0.2)",s.classList.contains("minimized")?(r.classList.add("minimized-status-message"),r.style.bottom="calc(100% + 5px)",r.style.left="0",r.style.width="90%",r.style.transform="none",r.style.whiteSpace="nowrap",r.style.overflow="hidden",r.style.textOverflow="ellipsis"):(r.style.bottom="10px",r.style.left="50%",r.style.transform="translateX(-50%)",r.style.width="calc(100% - 40px)"),"success"===t?r.style.backgroundColor="#45dd68":"error"===t?(r.style.backgroundColor="#dc3545",r.style.color="#fff"):"warning"===t&&(r.style.backgroundColor="#fffd01"),s.appendChild(r),!1===n||s.classList.contains("minimized")||setTimeout((()=>{r.remove(),o&&o()}),n),r},async restartComfyUI(){try{if(!(await fetch("http://localhost:8080/restart_comfyui",{method:"POST"})).ok)throw new Error("Error restarting ComfyUI");console.log("ComfyUI restarted successfully")}catch(e){console.error("Error restarting ComfyUI:",e)}},async showPluginsTab(){let e=document.getElementById("dependenciesContainer"),t=document.getElementById("comfyuiContainer"),n=document.getElementById("pluginsContainer");e.style.display="none",t.style.display="none",n.style.display="block",n.innerHTML="";let s=document.createElement("div");s.style.position="sticky",s.style.top="0",s.style.backgroundColor="#191919",s.style.zIndex="1000",s.style.padding="0px",s.style.boxShadow="0 2px 4px rgba(0,0,0,0.1)";let o=document.createElement("div");o.style.display="flex",o.style.alignItems="center",o.style.marginBottom="10px";let l=document.createElement("div");l.style.position="relative",l.style.marginRight="20px",l.style.flex="1";let r=document.createElement("input");r.type="text",r.placeholder="Search plugins...",r.style.padding="10px 30px 10px 10px",r.style.width="100%",r.style.border="1px solid #ccc",r.style.borderRadius="4px",r.addEventListener("input",(()=>{this.filterPlugins(r.value)})),l.appendChild(r);let i=document.createElement("i");i.className="fas fa-search",i.style.position="absolute",i.style.right="10px",i.style.top="50%",i.style.transform="translateY(-50%)",i.style.color="#999",l.appendChild(i);let d=document.createElement("button");d.innerHTML='<svg t="1719406809172" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="64362" style="width:45px;height:45px;margin-left:8px;margin-right:197px;"><path d="M480 531.2V224c0-19.2 12.8-32 32-32s32 12.8 32 32v307.2l73.6-73.6c12.8-12.8 32-12.8 44.8 0 12.8 12.8 12.8 32 0 44.8l-128 128c-12.8 12.8-32 12.8-44.8 0l-128-128c-12.8-12.8-12.8-32 0-44.8 12.8-12.8 32-12.8 44.8 0l73.6 73.6zM160 576c0-19.2 12.8-32 32-32s32 12.8 32 32v160c0 19.2 12.8 32 32 32h512c19.2 0 32-12.8 32-32v-160c0-19.2 12.8-32 32-32s32 12.8 32 32v160c0 54.4-41.6 96-96 96H256c-54.4 0-96-41.6-96-96v-160z" p-id="64363" fill="#fffd01"></path></svg>',d.title="Install plugin",d.style.padding="10px 20px",d.style.borderRadius="4px",d.style.backgroundColor="#fffd0100",d.style.color="#191919",d.style.border="none",d.style.cursor="pointer",d.style.marginRight="10px",d.addEventListener("click",(async()=>{let e=r.value.trim();e&&(await this.installPlugin(e),r.value="")}));let a=document.createElement("button");a.innerHTML='\n        <svg t="1719407150025" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="76145" width="30" height="30">\n            <path d="M359.375238 470.064762a40.96 40.96 0 1 0-58.026667 58.026667l146.285715 146.285714a39.009524 39.009524 0 0 0 55.100952 0l255.512381-255.512381a39.009524 39.009524 0 0 0 0-55.100952l-3.413333-3.413334a39.009524 39.009524 0 0 0-55.100953 0l-220.891428 229.180953zM868.449524 585.142857a356.449524 356.449524 0 0 1-712.899048 0V208.213333L512 82.407619l356.449524 125.805714zM512 0L73.142857 146.285714v438.857143a438.857143 438.857143 0 0 0 877.714286 0V146.285714z" fill="#fffd01" p-id="76146"></path>\n        </svg>',a.title="Safety Feature",a.style.padding="8px 1px",a.style.borderRadius="4px",a.style.backgroundColor="#28a74500",a.style.color="#fff",a.style.border="none",a.style.cursor="pointer",a.style.marginRight="10px",a.addEventListener("click",(()=>{window.open("https://www.virustotal.com/gui/home/upload","_blank","width=800,height=900,resizable=yes,menubar=no,location=no,status=no")}));let c=document.createElement("div");c.style.display="flex",c.style.alignItems="center",c.style.backgroundColor="#fffd01",c.style.padding="5px 10px",c.style.borderRadius="4px";let p=document.createElement("span");p.textContent="Plugins: ",p.style.marginRight="5px",p.style.color="#191919",c.appendChild(p);let y=document.createElement("span");y.id="pluginsCount",y.textContent="0",y.style.color="#191919",c.appendChild(y);let u=document.createElement("button");u.innerHTML='\n        <svg t="1719637400376" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="10279" width="30" height="30" style="margin-left:10px;margin-right:-17px;">\n            <path d="M873.629538 1.102769h-727.04A145.408 145.408 0 0 0 1.024 146.510769v727.118769c0 80.344615 65.063385 145.486769 145.408 145.48677h727.118769c80.344615 0 145.486769-65.142154 145.486769-145.48677v-727.04c0-80.344615-65.142154-145.486769-145.486769-145.486769h0.078769z m72.861539 872.763077a72.467692 72.467692 0 0 1-72.310154 72.625231H146.747077a72.467692 72.467692 0 0 1-51.593846-21.267692 72.152615 72.152615 0 0 1-21.425231-51.357539V146.589538c0-40.251077 32.689231-72.861538 72.940308-72.861538h727.04c40.172308 0 72.782769 32.610462 72.782769 72.782769v727.355077z m-118.075077-545.634461H537.521231a36.312615 36.312615 0 1 0 0 72.704h290.894769a36.312615 36.312615 0 1 0 0-72.704z m0 291.052307H537.521231a36.312615 36.312615 0 1 0 0 72.625231h290.894769a36.312615 36.312615 0 1 0 0-72.625231zM319.330462 528.384a127.291077 127.291077 0 1 0 0 254.503385 127.291077 127.291077 0 0 0 0-254.424616v-0.078769z m38.596923 165.888a54.587077 54.587077 0 1 1-77.193847-77.193846 54.587077 54.587077 0 0 1 77.193847 77.193846z m44.819692-427.953231l-119.729231 119.729231-47.104-46.946462a36.312615 36.312615 0 1 0-51.357538 51.357539l72.704 72.704c14.178462 14.178462 37.179077 14.178462 51.357538 0l145.486769-145.408a36.312615 36.312615 0 0 0-51.357538-51.436308z" fill="#fffd01" p-id="10280"></path>\n        </svg>',u.title="Check for Updates",u.style.padding="0px 17px",u.style.borderRadius="4px",u.style.backgroundColor="#28a74500",u.style.color="#fff",u.style.border="none",u.style.cursor="pointer",u.style.marginRight="0px",u.addEventListener("click",(async()=>{await this.checkPluginUpdates()}));let h=document.createElement("button");h.innerHTML='\n        <svg t="1719407115924" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="74856" width="35" height="35">\n            <path d="M577.6 825.6c-102.4 20.8-212.8-8-291.2-86.4-116.8-116.8-124.8-299.2-24-424v59.2c0 17.6 14.4 32 32 32s32-14.4 32-32v-128c0-9.6-3.2-17.6-9.6-22.4-6.4-6.4-14.4-9.6-22.4-9.6h-128c-17.6 0-32 14.4-32 32s14.4 32 32 32h44.8C91.2 427.2 102.4 644.8 240 784c96 96 228.8 129.6 352 104 4.8-1.6 11.2-4.8 14.4-8 12.8-12.8 12.8-32 0-44.8-6.4-9.6-19.2-12.8-28.8-9.6zM859.2 747.2H816c116.8-150.4 107.2-368-32-507.2-89.6-89.6-211.2-124.8-328-108.8-8 0-14.4 3.2-20.8 9.6-12.8 12.8-12.8 32 0 44.8 8 8 19.2 11.2 30.4 8 96-14.4 198.4 16 272 89.6 116.8 116.8 124.8 299.2 24 424v-59.2c0-17.6-14.4-32-32-32s-32 14.4-32 32v128c0 9.6 3.2 17.6 9.6 22.4 6.4 6.4 14.4 9.6 22.4 9.6h128c17.6 0 32-14.4 32-32s-12.8-28.8-30.4-28.8z" fill="#fffd01" p-id="74857"></path>\n        </svg>',h.title="Update All",h.style.padding="1px 14px",h.style.borderRadius="4px",h.style.backgroundColor="#28a74500",h.style.color="#fff",h.style.border="none",h.style.cursor="pointer",h.style.marginRight="-3px",h.addEventListener("click",(async()=>{await this.updateAllPlugins()})),o.appendChild(l),o.appendChild(d),o.appendChild(u),o.appendChild(h),o.appendChild(a),o.appendChild(c),s.appendChild(o),n.appendChild(s);let g=document.createElement("div");g.style.marginTop="10px",n.appendChild(g);let m=document.createElement("table");m.style.width="100%",m.style.borderCollapse="collapse";let f=document.createElement("thead"),x=document.createElement("tr");["Plugin Name","Enabled","Folder","Actions"].forEach((e=>{let t=document.createElement("th");t.textContent=e,t.style.padding="10px",t.style.textAlign="left",t.style.borderBottom="2px solid #444",t.style.fontSize="14px",x.appendChild(t)})),f.appendChild(x),m.appendChild(f);let C=document.createElement("tbody");C.id="pluginsList",m.appendChild(C),g.appendChild(m);const b=localStorage.getItem("plugins");b?(this.plugins=JSON.parse(b),this.renderPlugins(this.plugins,C),y.textContent=this.plugins.length):(await this.fetchPlugins(),this.renderPlugins(this.plugins,C),y.textContent=this.plugins.length)},async checkPluginUpdates(){let e=this.showStatusMessage("Checking for updates...","warning",!1,this.dependenciesPopup);const t=this.plugins.map((async e=>{if(e.url){const t=await fetch(`http://localhost:8080/get_plugin_versions?plugin_name=${e.name}`);if(t.ok){const n=await t.json();if(n.length>0){const t=n[0].id,s=e.version;e.hasNewVersion=t!==s}}}}));await Promise.all(t),this.plugins.forEach((e=>{localStorage.setItem(`plugin_${e.name}_hasNewVersion`,JSON.stringify(e.hasNewVersion))})),e.remove(),this.showStatusMessage("Check completed.","success",2e3,this.dependenciesPopup,(()=>{this.renderPlugins(this.plugins,document.getElementById("pluginsList"))}))},async fetchPlugins(){try{const e=await fetch("http://localhost:8080/get_plugins");if(!e.ok)throw new Error("Error fetching plugins");this.plugins=await e.json(),localStorage.setItem("plugins",JSON.stringify(this.plugins))}catch(e){console.error("Error fetching plugins:",e)}},async renderPlugins(e,t){if(t.innerHTML="",0===e.length){let e=document.createElement("div");return e.textContent="No plugins found.",e.style.padding="10px",e.style.textAlign="center",void t.appendChild(e)}e.forEach((async e=>{let n=document.createElement("tr"),s=document.createElement("td");if(e.url){let t=document.createElement("a");t.textContent=e.name,t.href=e.url,t.target="_blank",t.style.color="#fff",t.style.textDecoration="none",t.addEventListener("mouseover",(()=>{t.style.color="#fffd01",t.style.cursor="pointer"})),t.addEventListener("mouseout",(()=>{t.style.color="#fff",t.style.cursor="default"})),s.appendChild(t)}else s.textContent=e.name;s.style.padding="10px",s.style.borderBottom="1px solid #444",s.style.width="35%",s.style.wordBreak="break-word",n.appendChild(s);let o=document.createElement("td");if(o.style.padding="10px",o.style.borderBottom="1px solid #444",o.style.width="10%",o.style.textAlign="left",void 0!==e.enabled){let t=document.createElement("input");t.type="checkbox",t.style.accentColor="#fffd01",t.checked=e.enabled,t.addEventListener("change",(async()=>{e.enabled=t.checked,await this.togglePlugin(e.name,e.enabled)})),o.appendChild(t)}else o.textContent="Unknown";n.appendChild(o);let l=document.createElement("td"),r=document.createElement("a");r.textContent="Open Folder",r.href="#",r.style.color="#fff",r.style.textDecoration="none",r.addEventListener("mouseover",(()=>{r.style.color="#fffd01",r.style.cursor="pointer"})),r.addEventListener("mouseout",(()=>{r.style.color="#fff",r.style.cursor="default"})),r.addEventListener("click",(async()=>{await this.openPluginFolder(e.name)})),l.appendChild(r),l.style.padding="10px",l.style.borderBottom="1px solid #444",l.style.width="20%",l.style.textAlign="left",n.appendChild(l);let i=document.createElement("td");if(e.url){let t=document.createElement("button");t.textContent="Update",t.style.marginRight="5px",t.style.padding="6px 16px",t.style.borderRadius="4px";const n=localStorage.getItem(`plugin_${e.name}_hasNewVersion`);t.style.backgroundColor="true"===n?"#ff0000":"#fffd01",t.style.color="#191919",t.style.border="none",t.style.cursor="pointer",t.addEventListener("click",(async()=>{try{await this.updatePlugin(e.name),e.hasNewVersion=!1,t.style.backgroundColor="#fffd01"}catch(t){console.error(`Error updating plugin: ${e.name}`,t)}})),i.appendChild(t);let s=document.createElement("button");s.textContent="Switch",s.style.marginRight="5px",s.style.padding="6px 16px",s.style.borderRadius="4px",s.style.backgroundColor="#fffd01",s.style.color="#191919",s.style.border="none",s.style.cursor="pointer",s.addEventListener("click",(async()=>{await this.switchPluginVersion(e.name)})),i.appendChild(s)}else{let e=document.createElement("button");e.textContent="Not git clone",e.style.padding="6px 39px",e.style.borderRadius="4px",e.style.backgroundColor="#6c757d",e.style.color="#fff",e.style.border="none",e.style.cursor="default",e.style.marginRight="5px",i.appendChild(e)}let d=document.createElement("button");d.textContent="View",d.style.marginRight="5px",d.style.padding="6px 15px",d.style.borderRadius="4px",d.style.backgroundColor="#3d3d3f",d.style.color="#fff",d.style.border="none",d.style.cursor="pointer",d.addEventListener("click",(async()=>{await this.viewPluginRequirements(e.name)})),i.appendChild(d),i.style.padding="10px",i.style.borderBottom="1px solid #444",i.style.width="25%",i.style.textAlign="left",n.appendChild(i),e.hasNewVersion&&(s.style.color="#dc3545"),t.appendChild(n)}))},async updateAllPlugins(){const e=this.plugins.filter((e=>e.url&&e.hasNewVersion));if(0!==e.length){this.showStatusMessage("Updating plugins...","success",!1);for(let t of e)try{await this.updatePlugin(t.name),t.hasNewVersion=!1,localStorage.setItem(`plugin_${t.name}_hasNewVersion`,JSON.stringify(!1)),this.showStatusMessage(`Successfully updated plugin: ${t.name}`,"success",2e3)}catch(e){console.error(`Error updating plugin: ${t.name}`,e),t.hasNewVersion=!0,localStorage.setItem(`plugin_${t.name}_hasNewVersion`,JSON.stringify(!0)),this.showStatusMessage(`Error updating plugin: ${t.name}: ${e.message}`,"error",2e3)}await this.checkPluginUpdates(),this.renderPlugins(this.plugins,document.getElementById("pluginsList")),this.showStatusMessage("Update completed.","success",2e3,this.dependenciesPopup)}else this.showStatusMessage("No plugins need to be updated.","success",2e3,this.dependenciesPopup)},async togglePlugin(e,t){try{if(!(await fetch(`http://localhost:8080/toggle_plugin?plugin_name=${e}&enabled=${t}`,{method:"POST"})).ok)throw new Error(`Error ${t?"enabling":"disabling"} plugin`);{console.log(`${t?"Enabled":"Disabled"} plugin: ${e}`);const n=this.plugins.findIndex((t=>t.name===e));-1!==n&&(this.plugins[n].enabled=t,localStorage.setItem("plugins",JSON.stringify(this.plugins))),this.renderPlugins(this.plugins,document.getElementById("pluginsList"))}}catch(e){console.error(`Error ${t?"enabling":"disabling"} plugin:`,e)}},async openPluginFolder(e){try{const t=this.plugins.findIndex((t=>t.name===e)),n=this.plugins[t].enabled?e:`${e}.disabled`,s=await fetch(`http://localhost:8080/open_plugin_folder?plugin_name=${encodeURIComponent(n)}`,{method:"POST"});if(!s.ok)throw console.error(`Error opening plugin folder for ${e}`),console.error(`HTTP error! status: ${s.status}`),new Error(`HTTP error! status: ${s.status}`);console.log(`Opened folder for plugin: ${e}`)}catch(e){console.error("Error opening plugin folder:",e)}},filterPlugins(e){let t=this.plugins.filter((t=>t.name.toLowerCase().includes(e.toLowerCase()))),n=document.getElementById("pluginsList");this.renderPlugins(t,n),document.getElementById("pluginsCount").textContent=t.length},async installPlugin(e){if(e)try{let t=e.split("/").pop().replace(".git","");if(this.plugins.find((e=>e.name===t))&&!confirm(`Plugin ${t} already exists. Do you want to overwrite it?`))return void console.log(`Plugin ${t} installation cancelled by user`);let n=document.createElement("div");n.classList.add("message"),n.textContent=`Installing plugin from: ${e}`,n.style.padding="10px",n.style.marginBottom="10px",n.style.backgroundColor="#fffd01",n.style.color="#191919",n.style.borderRadius="4px",document.getElementById("pluginsContainer").prepend(n);const s=await fetch(`http://localhost:8080/install_plugin?git_url=${encodeURIComponent(e)}&plugin_name=${t}&overwrite=${!!this.plugins.find((e=>e.name===t))}`,{method:"POST"});if(!s.ok){const t=await s.text();throw n.innerHTML=`Error installing plugin from: ${e}<br><pre>${t}</pre>`,n.style.backgroundColor="#dc3545",console.error("Installation error:"),console.error(t),new Error("Error installing plugin")}console.log(`Installed plugin from: ${e}`),n.textContent=`Plugin installed successfully from: ${e}`,n.style.backgroundColor="#45dd68",setTimeout((()=>{n.style.display="none"}),2e3),await this.fetchPlugins(),this.renderPlugins(this.plugins,document.getElementById("pluginsList")),document.getElementById("pluginsCount").textContent=this.plugins.length}catch(e){console.error("Error installing plugin:",e)}},async updatePlugin(e){let t=null;try{t=this.showStatusMessage(`Updating plugin: ${e}`,"warning",!1);const n=await fetch(`http://localhost:8080/get_plugin_default_branch?plugin_name=${e}`);if(n.ok){const s=await n.text(),o=await fetch(`http://localhost:8080/checkout_plugin_branch?plugin_name=${e}&branch=${s}`,{method:"POST"});if(o.ok){const n=await fetch(`http://localhost:8080/update_plugin?plugin_name=${e}&overwrite=true`,{method:"POST"});if(n.ok){const n=this.plugins.find((t=>t.name===e));n&&(n.version="latest",localStorage.setItem("plugins",JSON.stringify(this.plugins)));const s=await fetch(`http://localhost:8080/get_plugin_versions?plugin_name=${e}`);if(s.ok){const t=await s.json();if(t.length>0){const n=t[0].id;await this.selectPluginVersion(e,n)}}t.remove(),this.showStatusMessage(`Successfully updated plugin: ${e}`,"success",2e3)}else t.remove(),this.showStatusMessage(`Error updating plugin: ${e}. HTTP error! status: ${n.status}`,"error",2e3)}else t.remove(),this.showStatusMessage(`Error updating plugin: ${e}. HTTP error! status: ${o.status}`,"error",2e3)}else t.remove(),this.showStatusMessage(`Error updating plugin: ${e}. HTTP error! status: ${n.status}`,"error",2e3)}catch(n){console.error("Error updating plugin:",n),t&&t.remove(),this.showStatusMessage(`Error updating plugin: ${e}. ${n.message}`,"error",2e3)}},async switchPluginVersion(e){try{const t=await fetch(`http://localhost:8080/get_plugin_versions?plugin_name=${e}`);if(!t.ok)throw console.error(`Error fetching plugin versions for ${e}`),console.error(`HTTP error! status: ${t.status}`),new Error(`HTTP error! status: ${t.status}`);{const n=await t.json(),s=this.selectedVersions[e]||null;this.renderPluginVersions(e,n,s)}}catch(e){console.error("Error fetching plugin versions:",e)}},async getCurrentPluginVersion(e){try{const t=await fetch(`http://localhost:8080/get_current_plugin_version?plugin_name=${e}`);if(t.ok){return await t.text()}throw new Error("Error fetching current plugin version")}catch(e){return console.error("Error fetching current plugin version:",e),""}},async selectPluginVersion(e,t){try{if((await fetch(`http://localhost:8080/select_plugin_version?plugin_name=${e}&version=${t}`,{method:"POST"})).ok){console.log(`Switched to version ${t} for plugin: ${e}`),this.selectedVersions[e]=t,localStorage.setItem("selectedVersions",JSON.stringify(this.selectedVersions));const n=this.plugins.findIndex((t=>t.name===e));return-1!==n&&(this.plugins[n].version=t,localStorage.setItem("plugins",JSON.stringify(this.plugins))),this.renderPlugins(this.plugins,document.getElementById("pluginsList")),!0}throw new Error("Error switching plugin version")}catch(e){return console.error("Error switching plugin version:",e),!1}},async viewPluginRequirements(e){try{const t=await fetch(`http://localhost:8080/view_plugin_requirements?plugin_name=${e}`);if(t.ok){const n=await t.text();this.renderPluginRequirements(e,n)}else{const e=await t.json();console.error("Error fetching plugin requirements:",e.error),alert(`Error: ${e.error}`)}}catch(e){console.error("Error fetching plugin requirements:",e),alert(`Error: ${e.message}`)}},async installPluginRequirements(e,t){try{let n=document.createElement("div");n.classList.add("message"),n.textContent=`Installing requirements for plugin: ${e}`,n.style.padding="10px",n.style.marginBottom="10px",n.style.backgroundColor="#fffd01",n.style.color="#191919",n.style.borderRadius="4px",document.getElementById("notificationContainer").appendChild(n),t.value="";const s=await fetch(`http://localhost:8080/install_plugin_requirements?plugin_name=${e}`,{method:"POST"}),o=s.body.getReader(),l=new TextDecoder("utf-8");for(;;){const{value:e,done:n}=await o.read();if(n)break;const s=l.decode(e);console.log(s),t.value+=s,t.scrollTop=t.scrollHeight}s.ok?(n.textContent=`Requirements installed successfully for plugin: ${e}`,n.style.backgroundColor="#45dd68",this.initialRequirements[e]=t.value,localStorage.setItem("initialRequirements",JSON.stringify(this.initialRequirements))):(n.textContent=`Error installing requirements for plugin: ${e}`,n.style.backgroundColor="#dc3545"),setTimeout((()=>{n.remove()}),2e3)}catch(e){console.error("Error installing plugin requirements:",e)}},renderPluginRequirements(e,t){let n=document.createElement("div");n.style.position="fixed",n.style.top="50%",n.style.left="50%",n.style.transform="translate(-50%, -50%)",n.style.width="450px",n.style.maxHeight="500px",n.style.overflowY="auto",n.style.padding="20px",n.style.background="#191919",n.style.borderRadius="5px",n.style.border="2px solid #fffd01",n.style.zIndex="9999",n.style.boxShadow="0 4px 6px rgba(0, 0, 0, 0.1)",n.style.color="#fff";let s=document.createElement("button");s.textContent="Ã—",s.style.position="absolute",s.style.right="10px",s.style.top="10px",s.style.background="transparent",s.style.border="none",s.style.fontSize="20px",s.style.cursor="pointer",s.style.color="#fff",s.addEventListener("click",(()=>{n.remove()})),n.appendChild(s);let o=document.createElement("h3");o.textContent=`Requirements for ${e}`,o.style.marginBottom="10px",n.appendChild(o);let l=document.createElement("textarea");l.value=t?t.replace(/\\n/g,"\n").replace(/"/g,""):"No requirements found.";let r="";this.initialRequirements&&this.initialRequirements[e]&&(r=this.initialRequirements[e]),l.style.width="100%",l.style.height="150px",l.style.padding="5px",l.style.borderRadius="4px",l.style.backgroundColor="#3d3d3f",l.style.color="#fff",l.readOnly=!0,n.appendChild(l);let i=document.createElement("button");i.textContent="Edit",i.style.marginTop="10px",i.style.padding="5px 10px",i.style.borderRadius="4px",i.style.backgroundColor="#fffd01",i.style.color="#191919",i.style.border="none",i.style.cursor="pointer",i.addEventListener("click",(()=>{l.readOnly=!1,l.focus()})),n.appendChild(i);let d=document.createElement("button");d.textContent="Save",d.style.marginLeft="10px",d.style.padding="5px 10px",d.style.borderRadius="4px",d.style.backgroundColor="#fffd01",d.style.color="#191919",d.style.border="none",d.style.cursor="pointer",d.addEventListener("click",(async()=>{await this.savePluginRequirements(e,l.value)})),n.appendChild(d);let a=document.createElement("button");a.textContent="Install",a.style.marginLeft="10px",a.style.padding="5px 10px",a.style.borderRadius="4px",a.style.backgroundColor="#3d3d3f",a.style.color="#fff",a.style.border="none",a.style.cursor="pointer",a.addEventListener("click",(async()=>{await this.installPluginRequirements(e,c)})),n.appendChild(a);let c=document.createElement("textarea");c.style.width="100%",c.style.height="150px",c.style.padding="5px",c.style.marginTop="13px",c.style.borderRadius="4px",c.style.backgroundColor="#3d3d3f",c.style.color="#fff",c.style.readOnly=!0,c.style.overflowY="scroll",n.appendChild(c);const p=this.initialRequirements[e]||"";c.value=p,document.body.appendChild(n)},async savePluginRequirements(e,t){try{const n=await fetch(`http://localhost:8080/edit_plugin_requirements?plugin_name=${e}`,{method:"POST",body:t});if(n.ok)console.log(`Saved requirements for plugin: ${e}`),await this.fetchPlugins(),this.showPluginsTab();else{const e=await n.json();console.error("Error saving plugin requirements:",e.error),alert(`Error: ${e.error}`)}}catch(e){console.error("Error saving plugin requirements:",e),alert(`Error: ${e.message}`)}},async editPluginRequirements(e,t){try{const n=await fetch(`http://localhost:8080/edit_plugin_requirements?plugin_name=${e}`,{method:"POST",body:t});if(n.ok)console.log(`Edited requirements for plugin: ${e}`),await this.fetchPlugins(),this.showPluginsTab();else{const e=await n.json();console.error("Error editing plugin requirements:",e.error),alert(`Error: ${e.error}`)}}catch(e){console.error("Error editing plugin requirements:",e),alert(`Error: ${e.message}`)}}};