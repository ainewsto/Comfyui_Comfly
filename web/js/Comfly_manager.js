export const manageDependenciesButton={dependenciesPopup:null,dependencies:[],plugins:[],selectedVersions:{},dependencyVersionsCache:{},dependencyConflictsCache:null,initialRequirements:{},comfyUIVersions:[],createButton(){const e=document.createElement("button");return e.innerHTML='\n            <svg t="1719406096593" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="913" width="30" height="30">\n                <path d="M927.232 686.08L768 526.336A369.152 369.152 0 0 0 243.2 89.6a38.4 38.4 0 0 0-9.216 60.928L392.704 307.2 307.2 392.704l-158.72-158.72a38.912 38.912 0 0 0-32.768-10.752 38.4 38.4 0 0 0-28.16 19.968A369.152 369.152 0 0 0 526.336 768l159.232 159.232a170.496 170.496 0 0 0 241.664-241.152z m-54.272 186.88a96.256 96.256 0 0 1-132.608 0L563.2 696.32a38.4 38.4 0 0 0-40.96-8.704 292.352 292.352 0 0 1-385.536-358.4l145.92 144.896a38.4 38.4 0 0 0 54.272 0l137.216-137.216a38.4 38.4 0 0 0 0-54.272L328.704 136.704a292.352 292.352 0 0 1 358.4 385.536 38.4 38.4 0 0 0 8.704 40.96l176.64 176.64a94.208 94.208 0 0 1 0.512 133.12z" fill="#fffd01" p-id="914"></path>\n            </svg>',e.style.backgroundSize="cover",e.style.backgroundRepeat="no-repeat",e.style.backgroundPosition="center",e.style.padding="0px 0px",e.style.borderRadius="5px",e.style.margin="5px",e.style.backgroundColor="rgba(255, 253, 1, 0.0)",e.style.color="white",e.style.border="none",e.style.cursor="pointer",e.addEventListener("click",(async()=>{if(this.dependenciesPopup)this.dependenciesPopup.remove(),this.dependenciesPopup=null;else{this.openDependenciesPopup();const e=localStorage.getItem("comfyUIVersions"),t=localStorage.getItem("currentComfyUIVersion");if(!e||!t)try{const[e,t]=await Promise.all([this.fetchComfyUIVersions(),this.fetchCurrentComfyUIVersion()]);this.comfyUIVersions=e,localStorage.setItem("comfyUIVersions",JSON.stringify(this.comfyUIVersions)),localStorage.setItem("currentComfyUIVersion",t),this.comfyUIVersions.some((e=>e.id===t))&&await this.selectComfyUIVersion(t)}catch(e){console.error("Error fetching ComfyUI versions:",e)}await this.fetchDependencies(),await this.fetchPlugins()}})),e},async renderPluginVersions(e,t,n,o){let s=document.getElementById("versionPopup");if(!s){s=document.createElement("div"),s.id="versionPopup",s.style.position="fixed",s.style.top="50%",s.style.left="50%",s.style.transform="translate(-50%, -50%)",s.style.width="900px",s.style.height="600px",s.style.padding="20px",s.style.background="#191919",s.style.borderRadius="5px",s.style.border="2px solid #fffd01",s.style.zIndex="9999",s.style.boxShadow="0 4px 6px rgba(0, 0, 0, 0.1)",s.style.color="#fff",s.style.display="flex",s.style.flexDirection="column";let t=document.createElement("h2");t.id="versionPopupTitle",t.textContent=`Select Version for ${e}`,t.style.marginBottom="20px",s.appendChild(t);let n=document.createElement("button");n.textContent="Ã—",n.style.position="absolute",n.style.right="10px",n.style.top="10px",n.style.background="transparent",n.style.border="none",n.style.fontSize="24px",n.style.cursor="pointer",n.style.color="#fff",n.addEventListener("click",(()=>{s.remove()})),s.appendChild(n),document.body.appendChild(s)}document.getElementById("versionPopupTitle").textContent=`Select Version for ${e}`;let l=document.getElementById("versionTableContainer");if(l?l.innerHTML="":(l=document.createElement("div"),l.id="versionTableContainer",l.style.flexGrow="1",l.style.overflowY="auto",s.appendChild(l)),!Array.isArray(n)||0===n.length){let e=document.createElement("div");return e.textContent="No versions found.",e.style.padding="10px",e.style.textAlign="center",void l.appendChild(e)}let r=document.createElement("table");r.style.width="100%",r.style.borderCollapse="collapse",r.style.fontSize="14px",r.style.fontFamily="Arial, sans-serif";let i=document.createElement("thead");i.style.position="sticky",i.style.top="0",i.style.backgroundColor="#222",i.style.zIndex="1";let a=document.createElement("tr");["ID","Commit Message","Date","Version"].forEach((e=>{let t=document.createElement("th");t.textContent=e,t.style.padding="10px",t.style.textAlign="left",t.style.borderBottom="2px solid #444",t.style.fontSize="16px","Date"===e&&(t.style.width="25%"),a.appendChild(t)})),i.appendChild(a),r.appendChild(i);let d=document.createElement("tbody");n.forEach((l=>{let r=document.createElement("tr");r.setAttribute("data-plugin",e);let i=document.createElement("td"),a=document.createElement("a");a.textContent=l.id.substring(0,7),a.href=`https://github.com/${t}/${e}/commit/${l.id}`,a.target="_blank",a.style.color="#fff",a.style.textDecoration="none",a.addEventListener("mouseover",(()=>{a.style.color="#fffd01",a.style.cursor="pointer"})),a.addEventListener("mouseout",(()=>{a.style.color="#fff",a.style.cursor="default"})),i.appendChild(a),i.style.padding="10px",i.style.borderBottom="1px solid #444",r.appendChild(i);let c=document.createElement("td");c.textContent=l.message,c.style.padding="10px",c.style.borderBottom="1px solid #444",r.appendChild(c);let p=document.createElement("td");p.textContent=l.date,p.style.padding="10px",p.style.borderBottom="1px solid #444",p.style.color="#ffffff",r.appendChild(p);let u=document.createElement("td"),y=document.createElement("input");y.type="checkbox",y.style.accentColor="#fffd01",y.style.marginLeft="10px",y.checked=l.id===o,y.addEventListener("change",(async o=>{if(o.target.checked){const o=await this.selectPluginVersion(e,l.id);this.selectedVersions[e]=l.id,localStorage.setItem("selectedVersions",JSON.stringify(this.selectedVersions));let r=document.createElement("div");r.classList.add("message"),o?(r.textContent=`Successfully switched to version ${l.id} of plugin ${e}`,r.style.backgroundColor="#fffd01"):(r.textContent=`Failed to switch version for plugin ${e}`,r.style.backgroundColor="#dc3545"),r.style.padding="10px",r.style.marginBottom="10px",r.style.color="#191919",r.style.borderRadius="4px",s.appendChild(r),setTimeout((()=>{r.remove()}),2e3),await this.fetchPlugins(),this.renderPlugins(this.plugins,document.getElementById("pluginsList")),this.renderPluginVersions(e,t,n,this.selectedVersions[e])}else delete this.selectedVersions[e],localStorage.setItem("selectedVersions",JSON.stringify(this.selectedVersions)),await this.fetchPlugins(),this.renderPlugins(this.plugins,document.getElementById("pluginsList")),this.renderPluginVersions(e,t,n,null)})),u.appendChild(y),u.style.padding="10px",u.style.borderBottom="1px solid #444",r.appendChild(u),d.appendChild(r)})),r.appendChild(d),l.appendChild(r),s.addEventListener("click",(e=>{e.stopPropagation()}))},async openDependenciesPopup(){this.initialRequirements=JSON.parse(localStorage.getItem("initialRequirements"))||{};let e=document.createElement("div");e.classList.add("comfly-manager-popup"),e.style.paddingBottom="50px",e.style.position="fixed",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.width="900px",e.style.height="600px",e.style.padding="20px",e.style.background="#191919",e.style.border="2px solid #fffd01",e.style.borderRadius="5px",e.style.zIndex="2000",e.style.boxShadow="0 4px 6px rgba(0, 0, 0, 0.1)",e.style.display="flex",e.style.flexDirection="column",e.style.color="#fff";let t=document.createElement("div");t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="space-between",t.style.marginBottom="20px";let n=document.createElement("h2");n.textContent="Comfly Manager",n.style.color="#fff",n.style.margin="0",t.appendChild(n);let o=document.createElement("div");o.style.display="flex",o.style.alignItems="center";let s=document.createElement("button");s.textContent="-",s.style.background="transparent",s.style.border="none",s.style.fontSize="24px",s.style.cursor="pointer",s.style.color="#fff",s.style.marginRight="10px",s.addEventListener("click",(()=>{if(e.classList.contains("minimized")){e.classList.remove("minimized"),e.style.width="900px",e.style.height="600px",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.padding="20px",e.style.borderRadius="5px",s.textContent="-";let o=e.children;for(let e=0;e<o.length;e++)o[e]===t||o[e].classList.contains("status-message")||(o[e].style.display="block");n.style.fontSize="24px",t.style.cursor="default";let l=e.querySelector(".minimized-status-message");l&&l.remove()}else{e.classList.add("minimized"),e.style.width="200px",e.style.height="30px",e.style.top="auto",e.style.bottom="60px",e.style.left="10px",e.style.padding="2px",e.style.borderRadius="17px",e.style.transform="none",s.textContent="+";let o=e.children;for(let e=0;e<o.length;e++)o[e]===t||o[e].classList.contains("status-message")||(o[e].style.display="none");n.style.fontSize="14px",t.style.cursor="move"}})),o.appendChild(s);let l=document.createElement("button");l.textContent="Ã—",l.style.background="transparent",l.style.border="none",l.style.fontSize="24px",l.style.cursor="pointer",l.style.color="#fff",l.addEventListener("click",(()=>{e.remove(),this.dependenciesPopup=null})),o.appendChild(l),t.appendChild(o),e.appendChild(t);let r=!1,i=0,a=0;t.addEventListener("mousedown",(t=>{e.classList.contains("minimized")&&(r=!0,i=t.clientX-e.getBoundingClientRect().left,a=e.getBoundingClientRect().bottom-t.clientY)})),document.addEventListener("mousemove",(t=>{r&&(e.style.left=t.clientX-i+"px",e.style.bottom=window.innerHeight-t.clientY-a+"px")})),document.addEventListener("mouseup",(()=>{r=!1}));let d=document.createElement("div");d.style.display="flex",d.style.marginBottom="20px";let c=document.createElement("button");c.textContent="Dependencies",c.style.padding="10px 20px",c.style.borderRadius="4px",c.style.backgroundColor="#fffd01",c.style.color="#191919",c.style.border="none",c.style.cursor="pointer",c.addEventListener("click",(()=>{this.showDependenciesTab(),this.setActiveTab(c)})),d.appendChild(c);let p=document.createElement("button");p.textContent="ComfyUI",p.style.padding="10px 20px",p.style.borderRadius="4px",p.style.backgroundColor="#444",p.style.color="#191919",p.style.border="none",p.style.cursor="pointer",p.addEventListener("click",(()=>{this.showComfyUITab(),this.setActiveTab(p)})),d.appendChild(p);let u=document.createElement("button");u.textContent="Plugins",u.style.padding="10px 20px",u.style.borderRadius="4px",u.style.backgroundColor="#444",u.style.color="#191919",u.style.border="none",u.style.cursor="pointer",u.addEventListener("click",(()=>{this.showPluginsTab(),this.setActiveTab(u)})),d.appendChild(u),e.appendChild(d);let y=document.createElement("div");y.id="notificationContainer",y.style.position="absolute",y.style.top="10px",y.style.left="50%",y.style.transform="translateX(-50%)",y.style.zIndex="9999",e.appendChild(y);let h=document.createElement("div");h.id="pluginsContainer",h.style.display="none";let g=document.createElement("div");g.style.flexGrow="1",g.style.overflowY="auto";let m=document.createElement("div");m.id="dependenciesContainer",g.appendChild(m);let f=document.createElement("div");f.id="comfyuiContainer",f.style.display="none",g.appendChild(f),g.appendChild(h),e.appendChild(g),document.body.appendChild(e),this.dependenciesPopup=e,this.showDependenciesTab(),this.setActiveTab(c),this.selectedVersions=JSON.parse(localStorage.getItem("selectedVersions"))||{},this.currentComfyUIVersion=localStorage.getItem("currentComfyUIVersion")||null,this.currentComfyUIBranch=localStorage.getItem("currentComfyUIBranch")||null;const x=localStorage.getItem("plugins");if(x){this.plugins=JSON.parse(x);for(let e of this.plugins)if("directory"===e.type){const t=localStorage.getItem(`plugin_${e.name}_default_branch`);t&&(e.branch=JSON.parse(t))}loadingMessage.remove()}else await this.fetchPlugins(),loadingMessage.remove()},async fetchPluginDefaultBranches(e){for(let t of e)if("directory"===t.type&&!t.branch)try{if(this.pluginDefaultBranchCache.has(t.name))t.branch=this.pluginDefaultBranchCache.get(t.name);else{const e=await fetch(`http://localhost:8080/get_plugin_default_branch?plugin_name=${encodeURIComponent(t.name)}`);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);{const n=await e.json();t.branch=n,this.pluginDefaultBranchCache.set(t.name,n),localStorage.setItem(`plugin_${t.name}_default_branch`,JSON.stringify(n))}}}catch(e){console.error(`Error getting default branch for plugin ${t.name}:`,e),t.branch={default_branch:"unknown"}}},setActiveTab(e){const t=e.parentElement.children;for(let n of t)n.style.backgroundColor=n===e?"#fffd01":"#444"},async fetchDependencies(){try{const e=await fetch("http://localhost:8080/get_dependencies");if(!e.ok)throw new Error("Error fetching dependencies");{let t=await e.json(),n=document.getElementById("dependenciesCount");n&&(n.textContent=t.length),this.renderDependencies(t,document.getElementById("dependenciesList")),this.dependencies=t,localStorage.setItem("dependencies",JSON.stringify(t));let o=document.getElementById("loadingMessage");o&&o.remove()}}catch(e){console.error("Error fetching dependencies:",e)}},async showDependenciesTab(){let e=document.getElementById("dependenciesContainer"),t=document.getElementById("comfyuiContainer"),n=document.getElementById("pluginsContainer");e.style.display="block",t.style.display="none",n.style.display="none",e.innerHTML="";let o=document.createElement("div");o.style.display="flex",o.style.alignItems="center",o.style.marginBottom="0px",o.style.position="sticky",o.style.top="0",o.style.backgroundColor="#191919",o.style.zIndex="1",o.style.padding="0px",o.style.marginLeft="-10px";let s=document.createElement("div");s.style.position="relative",s.style.marginRight="20px";let l=document.createElement("input");l.type="text",l.placeholder="Search dependencies...",l.style.padding="10px 44px 10px 10px",l.style.width="302px",l.style.border="1px solid #ccc",l.style.borderRadius="4px",l.addEventListener("input",(()=>{this.filterDependencies(l.value)})),s.appendChild(l);let r=document.createElement("button");r.innerHTML='<svg t="1719406809172" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="64362" style="width:45px;height:45px;margin-left:-35px;"><path d="M480 531.2V224c0-19.2 12.8-32 32-32s32 12.8 32 32v307.2l73.6-73.6c12.8-12.8 32-12.8 44.8 0 12.8 12.8 12.8 32 0 44.8l-128 128c-12.8 12.8-32 12.8-44.8 0l-128-128c-12.8-12.8-12.8-32 0-44.8 12.8-12.8 32-12.8 44.8 0l73.6 73.6zM160 576c0-19.2 12.8-32 32-32s32 12.8 32 32v160c0 19.2 12.8 32 32 32h512c19.2 0 32-12.8 32-32v-160c0-19.2 12.8-32 32-32s32 12.8 32 32v160c0 54.4-41.6 96-96 96H256c-54.4 0-96-41.6-96-96v-160z" p-id="64363" fill="#fffd01"></path></svg>',r.title="Install dependencies",r.style.padding="10px 20px",r.style.borderRadius="4px",r.style.backgroundColor="#fffd0100",r.style.color="#191919",r.style.border="none",r.style.cursor="pointer",r.addEventListener("click",(()=>this.installDependency(l.value)));let i=document.createElement("div");i.style.marginLeft="auto",i.style.display="flex",i.style.alignItems="center",i.style.backgroundColor="#fffd01",i.style.padding="6px 10px",i.style.borderRadius="4px";let a=document.createElement("span");a.textContent="Dependencies: ",a.style.marginRight="5px",a.style.color="#191919",i.appendChild(a);let d=document.createElement("span");d.id="dependenciesCount",d.textContent="0",d.style.color="#191919",i.appendChild(d);let c=document.createElement("span");c.style.marginLeft="10px",c.style.color="#191919",o.appendChild(c);let p=document.createElement("button");p.innerHTML='<svg t="1719406989927" class="icon" viewBox="0 0 1026 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="69837" style="width:31px;height:31px;"><path d="M950.857143 394.971429l-124.342857 438.857142c-7.314286 21.942857-36.571429 43.885714-58.514286 43.885715h-658.285714c-7.314286 0-14.628571 0-21.942857-7.314286 0-7.314286-7.314286-14.628571 0-21.942857l124.342857-438.857143c7.314286-21.942857 36.571429-43.885714 58.514285-43.885714h658.285715c7.314286 0 14.628571 0 14.628571 7.314285 7.314286 0 7.314286 7.314286 7.314286 21.942858zM73.142857 109.714286c0-21.942857 14.628571-36.571429 36.571429-36.571429h234.057143l65.828571 124.342857c0 14.628571 14.628571 21.942857 29.257143 21.942857h402.285714c21.942857 0 36.571429 14.628571 36.571429 36.571429V292.571429H270.628571C219.428571 292.571429 160.914286 336.457143 146.285714 394.971429L73.142857 643.657143V109.714286z m936.228572 219.428571c-14.628571-21.942857-36.571429-29.257143-58.514286-36.571428v-36.571429c0-58.514286-51.2-109.714286-109.714286-109.714286H460.8L394.971429 21.942857C394.971429 7.314286 380.342857 0 365.714286 0H109.714286C51.2 0 0 51.2 0 109.714286v731.428571c0 36.571429 21.942857 73.142857 43.885714 87.771429h7.314286c14.628571 14.628571 36.571429 21.942857 58.514286 21.942857h658.285714c58.514286 0 109.714286-43.885714 131.657143-102.4l124.342857-438.857143c7.314286-29.257143 0-58.514286-14.628571-80.457143z" p-id="69838" fill="#fffd01"></path></svg>',p.title="Open site-packages folder",p.style.padding="0",p.style.borderRadius="4px",p.style.backgroundColor="transparent",p.style.border="none",p.style.cursor="pointer",p.style.marginLeft="15px",p.style.fontSize="10px",p.addEventListener("click",(()=>this.openSitePackagesFolder()));let u=document.createElement("button");function y(e){let t=document.createElement("div");t.style.position="fixed",t.style.top="50%",t.style.left="50%",t.style.transform="translate(-50%, -50%)",t.style.width="600px",t.style.height="400px",t.style.overflowY="auto",t.style.padding="20px",t.style.background="#191919",t.style.borderRadius="5px",t.style.border="2px solid #fffd01",t.style.zIndex="9999",t.style.boxShadow="0 4px 6px rgba(0, 0, 0, 0.1)",t.style.color="#fff",t.style.fontSize="16px";let n=document.createElement("button");n.textContent="Ã—",n.style.position="absolute",n.style.right="10px",n.style.top="10px",n.style.background="transparent",n.style.border="none",n.style.fontSize="20px",n.style.cursor="pointer",n.style.color="#fff",n.addEventListener("click",(()=>{t.remove()})),t.appendChild(n);let o=document.createElement("h3");o.textContent="Dependency Conflicts",o.style.marginBottom="15px",t.appendChild(o);let s=document.createElement("div");s.style.whiteSpace="pre-wrap",s.style.backgroundColor="#3d3d3f",s.style.padding="10px",s.style.borderRadius="4px",s.style.height="300px",s.style.overflowY="auto",e.split("\n").forEach((e=>{let t=e.replace(/\s+/g," ").trim();if(t.includes("but you have")){let e=t.split("but you have"),n=e[0].trim(),o="but you have "+e[1].trim(),l=document.createElement("span");l.appendChild(document.createTextNode(n));let r=document.createElement("span");r.style.whiteSpace="nowrap",r.appendChild(document.createTextNode(o)),l.appendChild(r),s.appendChild(l)}else{let e=document.createElement("span");e.appendChild(document.createTextNode(t)),s.appendChild(e)}s.appendChild(document.createElement("br"))})),t.appendChild(s),document.body.appendChild(t)}u.innerHTML='\n            <svg t="1719407034802" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="71782" width="40" height="40">\n                <path d="M511.835 737.304c20.501 0.188 37.272-16.281 37.459-36.788 0.187-20.5-16.281-37.272-36.782-37.46-20.507-0.188-37.279 16.281-37.466 36.78-0.187 20.508 16.282 37.281 36.789 37.468" fill="#d81e06" p-id="71783"></path>\n                <path d="M919.942 772.474L576.303 177.275c-28.58-49.5-100.027-49.5-128.606 0L104.059 772.474c-28.58 49.502 7.145 111.376 64.302 111.376h687.277c57.159 0 92.882-61.874 64.304-111.376z m-750.764 36.419L512 215.108l342.823 593.785H169.178z" fill="#d81e06" p-id="71784"></path>\n                <path d="M530.935 405.739h-37.53c-10.098 0-18.36 8.262-18.36 18.36v171.256c0 10.098 8.262 18.36 18.36 18.36h37.53c10.098 0 18.36-8.262 18.36-18.36V424.1c0-10.098-8.262-18.361-18.36-18.361z" fill="#d81e06" p-id="71785"></path>\n            </svg>',u.title="Check Dependency Conflicts",u.style.padding="0",u.style.borderRadius="4px",u.style.backgroundColor="transparent",u.style.border="none",u.style.cursor="pointer",u.style.marginLeft="10px",u.addEventListener("click",(async function(){if(manageDependenciesButton.dependencyConflictsCache)y(manageDependenciesButton.dependencyConflictsCache);else{let t=document.createElement("div");t.id="conflictLoadingPopup",t.innerHTML="ðŸ”” Checking dependency conflicts...<br>Please wait patiently as there are many dependency files to check.",t.style.position="absolute",t.style.top="50%",t.style.left="50%",t.style.transform="translate(-50%, -50%)",t.style.padding="10px",t.style.textAlign="center",t.style.backgroundColor="rgba(255, 0, 0, 0.6)",t.style.color="#fff",t.style.borderRadius="5px",t.style.lineHeight="1.5",t.style.height="auto",t.style.width="700px",t.style.zIndex="9999",e.appendChild(t);try{const n=await fetch("http://localhost:8080/check_dependency_conflicts",{method:"POST"});t.parentNode===e&&e.removeChild(t);const o=await n.text();manageDependenciesButton.dependencyConflictsCache=o,y(o)}catch(n){t.parentNode===e&&e.removeChild(t),console.error("Error checking dependency conflicts:",n)}}})),o.appendChild(s),o.appendChild(r),o.appendChild(i),o.appendChild(p),o.appendChild(u),e.appendChild(o);let h=document.createElement("div");h.id="dependenciesList",h.style.maxHeight="calc(100% - 120px)",h.style.overflowY="auto",e.appendChild(h);let g=document.createElement("div");g.id="loadingMessage",g.innerHTML="ðŸ”” Dependencies are loading...<br>Please wait patiently as there are many dependency files to load.",g.style.position="absolute",g.style.top="50%",g.style.left="50%",g.style.transform="translate(-50%, -50%)",g.style.padding="10px",g.style.textAlign="center",g.style.backgroundColor="rgba(255, 0, 0, 0.6)",g.style.color="#fff",g.style.borderRadius="5px",g.style.lineHeight="1.5",g.style.height="auto",g.style.width="700px",e.appendChild(g);const m=localStorage.getItem("dependencies");if(m){this.dependencies=JSON.parse(m),this.renderDependencies(this.dependencies,document.getElementById("dependenciesList")),document.getElementById("dependenciesCount").textContent=this.dependencies.length;let e=document.getElementById("loadingMessage");e&&e.remove()}else await this.fetchDependencies()},async installDependencyVersion(e,t){try{let n=document.querySelector("#dependenciesContainer .message");n&&n.remove();let o=document.createElement("div");o.classList.add("message"),o.textContent=`Installing dependency: ${e}==${t}`,o.style.padding="10px",o.style.marginBottom="10px",o.style.backgroundColor="#fffd01",o.style.color="#191919",o.style.borderRadius="4px",document.getElementById("notificationContainer").appendChild(o);const s=await fetch(`http://localhost:8080/install_dependency_version?name=${e}&version=${t}`,{method:"POST"}),l=await s.json();s.ok?(o.textContent=`Dependency installed successfully: ${e}==${t}`,o.style.backgroundColor="#45dd68"):(o.textContent=`Dependency installed successfully: ${e}==${t}`,o.style.backgroundColor="#45dd68",console.error("Installation error:"),console.error(l.error)),setTimeout((()=>{o.remove()}),2e3),await this.fetchDependencies(),this.renderDependencies(this.dependencies,document.getElementById("dependenciesList"))}catch(e){console.error("Error installing dependency:",e)}},async renderDependencies(e,t){if(t){if(t.innerHTML="",0===e.length){let e=document.createElement("div");return e.textContent="No dependencies found.",e.style.padding="10px",e.style.textAlign="center",void t.appendChild(e)}e.forEach((e=>{let n=document.createElement("div");n.textContent=e,n.style.padding="12px",n.style.borderBottom="1px solid #444",n.style.display="flex",n.style.justifyContent="space-between",n.style.alignItems="center",n.style.backgroundColor="transparent",n.style.color="#fff";let o=document.createElement("div"),s=document.createElement("button");s.textContent="Install",s.style.padding="6px 12px",s.style.borderRadius="4px",s.style.backgroundColor="#fffd01",s.style.color="#191919",s.style.border="none",s.style.cursor="pointer",s.addEventListener("click",(async()=>{let t=e.split("==")[0],n=await this.getDependencyVersions(t);this.showDependencyVersionsPopup(t,n)})),s.style.marginRight="10px",o.appendChild(s);let l=document.createElement("button");l.textContent="Uninstall",l.style.padding="6px 12px",l.style.borderRadius="4px",l.style.backgroundColor="#dc3545",l.style.color="#fff",l.style.border="none",l.style.cursor="pointer",l.addEventListener("click",(()=>this.manageDependency(e.split("==")[0],"uninstall"))),o.appendChild(l),n.appendChild(o),t.appendChild(n)}))}else console.error("dependenciesList container not found")},async getDependencyVersions(e){if(this.dependencyVersionsCache[e])return this.dependencyVersionsCache[e];try{let t=document.createElement("div");t.id="loadingPopup",t.innerHTML="ðŸ”” Getting versions for dependency...<br>Please wait patiently as there are many versions to load.",t.style.position="absolute",t.style.top="50%",t.style.left="50%",t.style.transform="translate(-50%, -50%)",t.style.padding="10px",t.style.textAlign="center",t.style.backgroundColor="rgba(255, 0, 0, 0.6)",t.style.color="#fff",t.style.borderRadius="5px",t.style.lineHeight="1.5",t.style.height="auto",t.style.width="700px",t.style.zIndex="9999",document.body.appendChild(t);const n=await fetch(`http://localhost:8080/get_dependency_versions?name=${e}`);if(document.body.removeChild(t),n.ok){const t=(await n.json()).map((e=>e.split("==")[1]));return this.dependencyVersionsCache[e]=t,t}throw console.error("Error fetching dependency versions. Status:",n.status),new Error("Error fetching dependency versions")}catch(e){return console.error("Error fetching dependency versions:",e),[]}},async openModuleVersionPopup(){let e=document.createElement("div");e.style.position="fixed",e.style.top="50%",e.style.left="50%",e.style.transform="translate(-50%, -50%)",e.style.width="400px",e.style.maxHeight="400px",e.style.overflowY="auto",e.style.padding="20px",e.style.background="#191919",e.style.borderRadius="5px",e.style.border="2px solid #fffd01",e.style.zIndex="9999",e.style.boxShadow="0 4px 6px rgba(0, 0, 0, 0.1)",e.style.color="#fff";let t=document.createElement("button");t.textContent="Ã—",t.style.position="absolute",t.style.right="10px",t.style.top="10px",t.style.background="transparent",t.style.border="none",t.style.fontSize="20px",t.style.cursor="pointer",t.style.color="#fff",t.addEventListener("click",(()=>{e.remove()})),e.appendChild(t);let n=document.createElement("h3");n.textContent="Search Module Version",n.style.marginBottom="10px",e.appendChild(n);let o=document.createElement("div");o.style.marginBottom="10px";let s=document.createElement("label");s.textContent="Module Path:",s.style.display="block",s.style.marginBottom="5px",o.appendChild(s);let l=document.createElement("input");l.type="text",l.style.width="calc(100% - 12px)",l.style.padding="5px",l.style.borderRadius="4px",l.style.border="1px solid #ccc",l.addEventListener("keypress",(async e=>{if("Enter"===e.key){let e=l.value.trim();if(e)if(e.includes("==")){let[t,n]=e.split("=="),o=await this.fetchDependencyVersions(t),s=await this.checkModuleVersion(t,n,o);r.textContent=s}else{let t=await this.getModuleVersion(e);r.textContent=t}}})),o.appendChild(l),e.appendChild(o);let r=document.createElement("div");r.style.maxHeight="200px",r.style.overflowY="auto",r.style.backgroundColor="#3d3d3f",r.style.padding="10px",r.style.borderRadius="4px",r.style.width="calc(100% - 20px)",e.appendChild(r),document.body.appendChild(e)},async fetchDependencyVersions(e){try{const t=await fetch(`http://localhost:8080/get_dependency_versions?name=${e}`);if(t.ok){const e=await t.json();return e.map((e=>e.split("==")[1]))}throw console.error("Error fetching dependency versions. Status:",t.status),new Error("Error fetching dependency versions")}catch(e){return console.error("Error fetching dependency versions:",e),[]}},checkModuleVersion:async(e,t,n)=>n.includes(t)?`The version ${t} exists for module ${e}.`:`The version ${t} does not exist for module ${e}.`,async getModuleVersion(e){try{const t=await fetch(`http://localhost:8080/get_module_version?module_path=${encodeURIComponent(e)}`);if(t.ok){return await t.text()}throw new Error("Error fetching module version")}catch(e){return console.error("Error fetching module version:",e),"Error fetching module version"}},async showDependencyVersionsPopup(e,t){const n=this.dependencyVersionsCache[e];let o;n?t=n:(o=document.createElement("div"),o.id="loadingPopup",o.innerHTML="ðŸ”” Getting versions for dependency...<br>Please wait patiently as there are many versions to load.",o.style.position="absolute",o.style.top="50%",o.style.left="50%",o.style.transform="translate(-50%, -50%)",o.style.padding="10px",o.style.textAlign="center",o.style.backgroundColor="rgba(255, 0, 0, 0.6)",o.style.color="#fff",o.style.borderRadius="5px",o.style.lineHeight="1.5",o.style.height="auto",o.style.width="700px",o.style.zIndex="9999",document.body.appendChild(o),this.dependencyVersionsCache[e]=t);let s=document.createElement("div");s.style.position="fixed",s.style.top="50%",s.style.left="50%",s.style.transform="translate(-50%, -50%)",s.style.width="400px",s.style.height="300px",s.style.overflowY="auto",s.style.padding="20px",s.style.background="#191919",s.style.borderRadius="5px",s.style.border="2px solid #fffd01",s.style.zIndex="9999",s.style.boxShadow="0 4px 6px rgba(0, 0, 0, 0.1)",s.style.color="#fff";let l=document.createElement("button");l.textContent="Ã—",l.style.position="absolute",l.style.right="10px",l.style.top="10px",l.style.background="transparent",l.style.border="none",l.style.fontSize="20px",l.style.cursor="pointer",l.style.color="#fff",l.addEventListener("click",(()=>{s.remove()})),s.appendChild(l);let r=document.createElement("h3");r.textContent=`Versions for ${e}`,r.style.marginBottom="10px",s.appendChild(r);let i=document.createElement("div");i.style.maxHeight="169px",i.style.overflowY="auto",i.style.backgroundColor="#3d3d3f",i.style.padding="5px",i.style.borderRadius="4px",s.appendChild(i);let a=null;function d(e){let t=e.target;i.querySelectorAll(".line").forEach((e=>e.classList.remove("highlight"))),t.classList.add("highlight"),a=t.getAttribute("data-version")}t.forEach((t=>{let n=document.createElement("div");n.classList.add("line"),n.textContent=`${e}==${t}`,n.setAttribute("data-version",t),n.addEventListener("click",d),n.style.color="#ffffff",n.style.fontSize="16px",i.appendChild(n)}));let c=document.createElement("style");c.innerHTML="\n            .line {\n                padding: 5px;\n                cursor: pointer;\n            }\n            .highlight {\n                background-color: #fffd016e;\n            }\n        ",s.appendChild(c);let p=document.createElement("button");p.textContent="Install",p.style.marginTop="10px",p.style.padding="5px 10px",p.style.borderRadius="4px",p.style.backgroundColor="#fffd01",p.style.color="#191919",p.style.border="none",p.style.cursor="pointer",p.addEventListener("click",(async()=>{a&&await this.installDependencyVersion(e,a)})),s.appendChild(p),o&&document.body.removeChild(o),this.dependencyVersionsPopup=s,document.body.appendChild(s)},async openSitePackagesFolder(){try{if(!(await fetch("http://localhost:8080/open_site_packages_folder",{method:"POST"})).ok)throw new Error("Error opening site-packages folder");console.log("Opened site-packages folder")}catch(e){console.error("Error opening site-packages folder:",e)}},filterDependencies(e){let t=this.dependencies.filter((t=>t.toLowerCase().includes(e.toLowerCase()))),n=document.getElementById("dependenciesList");this.renderDependencies(t,n),document.getElementById("dependenciesCount").textContent=t.length},async installDependency(e){if(e)try{let t=document.querySelector("#dependenciesContainer .message");t&&t.remove();let n=document.createElement("div");n.classList.add("message"),n.textContent=`Installing dependency: ${e}`,n.style.padding="10px",n.style.marginBottom="10px",n.style.backgroundColor="#fffd01",n.style.color="#191919",n.style.borderRadius="4px",document.getElementById("notificationContainer").appendChild(n);const o=await fetch(`http://localhost:8080/install_dependency?name=${e}`,{method:"POST"}),s=await o.json();o.ok?(n.textContent=`Dependency installed successfully: ${e}`,n.style.backgroundColor="#45dd68"):(n.textContent=`Error installing dependency: ${e}`,n.style.backgroundColor="#dc3545",console.error("Installation error:"),console.error(s.error)),setTimeout((()=>{n.remove()}),2e3),await this.fetchDependencies(),this.showDependenciesTab()}catch(e){console.error("Error installing dependency:",e)}},async manageDependency(e,t){if("uninstall"===t){if(!confirm(`Are you sure you want to uninstall dependency: ${e}?`))return}try{let n=document.querySelector("#dependenciesContainer .message");n&&n.remove();let o=document.createElement("div");o.classList.add("message"),o.textContent=`${"uninstall"===t?"Uninstalling":"Managing"} dependency: ${e}`,o.style.padding="10px",o.style.marginBottom="10px",o.style.backgroundColor="#fffd01",o.style.color="#191919",o.style.borderRadius="4px",document.getElementById("notificationContainer").appendChild(o);if(!(await fetch(`http://localhost:8080/manage_dependency?name=${e}&action=${t}`,{method:"POST"})).ok)throw o.textContent=`Error ${"uninstall"===t?"uninstalling":"managing"} dependency: ${e}`,o.style.backgroundColor="#dc3545",new Error(`Error ${t}ing dependency`);console.log(`${t} dependency: ${e}`),o.textContent=`Dependency ${"uninstall"===t?"uninstalled":"managed"} successfully: ${e}`,o.style.backgroundColor="#fffd01",await this.fetchDependencies(),this.showDependenciesTab(),setTimeout((()=>{o.remove()}),2e3)}catch(e){console.error(`Error ${t}ing dependency:`,e)}},async showComfyUITab(){let e=document.getElementById("dependenciesContainer"),t=document.getElementById("comfyuiContainer"),n=document.getElementById("pluginsContainer");localStorage.getItem("selectedComfyUIVersion");e.style.display="none",t.style.display="block",n.style.display="none",t.innerHTML="";let o=document.createElement("div");o.style.position="absolute",o.style.top="95px",o.style.left="740px",o.style.fontSize="16px",o.style.color="#fff",t.appendChild(o);try{let e=await this.fetchCurrentComfyUIBranch();if("Detached"===e){let e=document.createElement("a");e.textContent="Detached",e.style.color="#fffd01",e.style.cursor="pointer",e.addEventListener("click",(async()=>{await this.fixComfyUIDetachedBranch()})),o.appendChild(e)}else o.textContent=`Branch: ${e}`}catch(e){console.error("Error fetching current ComfyUI branch:",e),o.textContent="Unable to fetch current branch"}let s=document.createElement("button");s.innerHTML='\n            <svg t="1719407115924" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="74856" width="38" height="38">\n                <path d="M577.6 825.6c-102.4 20.8-212.8-8-291.2-86.4-116.8-116.8-124.8-299.2-24-424v59.2c0 17.6 14.4 32 32 32s32-14.4 32-32v-128c0-9.6-3.2-17.6-9.6-22.4-6.4-6.4-14.4-9.6-22.4-9.6h-128c-17.6 0-32 14.4-32 32s14.4 32 32 32h44.8C91.2 427.2 102.4 644.8 240 784c96 96 228.8 129.6 352 104 4.8-1.6 11.2-4.8 14.4-8 12.8-12.8 12.8-32 0-44.8-6.4-9.6-19.2-12.8-28.8-9.6zM859.2 747.2H816c116.8-150.4 107.2-368-32-507.2-89.6-89.6-211.2-124.8-328-108.8-8 0-14.4 3.2-20.8 9.6-12.8 12.8-12.8 32 0 44.8 8 8 19.2 11.2 30.4 8 96-14.4 198.4 16 272 89.6 116.8 116.8 124.8 299.2 24 424v-59.2c0-17.6-14.4-32-32-32s-32 14.4-32 32v128c0 9.6 3.2 17.6 9.6 22.4 6.4 6.4 14.4 9.6 22.4 9.6h128c17.6 0 32-14.4 32-32s-12.8-28.8-30.4-28.8z" fill="#fffd01" p-id="74857"></path>\n            </svg>',s.title="Refresh comfyui",s.style.position="absolute",s.style.top="85px",s.style.right="160px",s.style.borderRadius="4px",s.style.backgroundColor="#fffd0100",s.style.color="#191919",s.style.border="none",s.style.cursor="pointer",s.addEventListener("click",(async()=>{await this.updateComfyUIVersions()})),t.appendChild(s);let l=document.createElement("div");l.style.overflowY="auto",l.style.maxHeight="450px",l.style.marginBottom="0px",l.style.position="relative";let r=document.createElement("div");r.style.position="absolute",r.style.top="10px",r.style.right="10px",r.style.fontSize="14px",r.style.color="#fff",l.appendChild(r);try{let e=await this.fetchCurrentComfyUIVersion();localStorage.getItem("selectedComfyUIVersion");r.textContent=`Used ID: ${e}`}catch(e){console.error("Error fetching current ComfyUI version:",e),r.textContent="Unable to fetch current version"}let i=document.createElement("table");i.style.width="100%",i.style.height="100%",i.style.borderCollapse="collapse";let a=document.createElement("thead");a.style.position="sticky",a.style.top="0",a.style.backgroundColor="#222",a.style.zIndex="1";let d=document.createElement("tr");["ID","Commit Message","Date","Version"].forEach((e=>{let t=document.createElement("th");t.textContent=e,t.style.padding="10px",t.style.textAlign="left",t.style.borderBottom="2px solid #444",t.style.fontSize="14px",d.appendChild(t)})),a.appendChild(d),i.appendChild(a);let c=document.createElement("tbody");i.appendChild(c),l.appendChild(i),t.appendChild(l);const p=localStorage.getItem("comfyUIVersions");if(p)this.comfyUIVersions=JSON.parse(p);else try{this.comfyUIVersions=await this.fetchComfyUIVersions(),localStorage.setItem("comfyUIVersions",JSON.stringify(this.comfyUIVersions))}catch(e){console.error("Error fetching ComfyUI versions:",e),this.comfyUIVersions=[]}let u=localStorage.getItem("currentComfyUIVersion");u||(u=await this.fetchCurrentComfyUIVersion(),localStorage.setItem("currentComfyUIVersion",u)),this.renderComfyUIVersions(this.comfyUIVersions,c,u)},async fetchCurrentComfyUIBranch(){const e=localStorage.getItem("currentComfyUIBranch");if(e)return e;try{const e=await fetch("http://localhost:8080/get_current_comfyui_branch");if(e.ok){let t=await e.text();return t.startsWith("version-")&&(t="main"),localStorage.setItem("currentComfyUIBranch",t),t}throw new Error("Error fetching current ComfyUI branch")}catch(e){return console.error("Error fetching current ComfyUI branch:",e),"main"}},async fixComfyUIDetachedBranch(){try{if(!(await fetch("http://localhost:8080/fix_comfyui_detached_branch",{method:"POST"})).ok)throw new Error("Error fixing ComfyUI detached branch");console.log("Fixed ComfyUI detached branch"),await this.updateComfyUIVersions(),localStorage.removeItem("currentComfyUIBranch"),await this.fetchCurrentComfyUIBranch()}catch(e){console.error("Error fixing ComfyUI detached branch:",e)}},async updateComfyUIVersions(){try{this.showStatusMessage("Updating ComfyUI versions..."),localStorage.removeItem("comfyUIVersions"),localStorage.removeItem("currentComfyUIVersion"),localStorage.removeItem("currentComfyUIBranch"),this.comfyUIVersions=await this.fetchComfyUIVersions(),localStorage.setItem("comfyUIVersions",JSON.stringify(this.comfyUIVersions));await this.fetchCurrentComfyUIVersion();let e=document.querySelector("#comfyuiContainer div[style*='position: absolute']");e&&(e.textContent=`Branch: ${await this.fetchCurrentComfyUIBranch()}`),this.renderComfyUIVersions(this.comfyUIVersions,document.querySelector("#comfyuiContainer tbody")),this.showStatusMessage("ComfyUI versions updated successfully","success",2e3,this.dependenciesPopup)}catch(e){console.error("Error updating ComfyUI versions:",e),this.showStatusMessage("Error updating ComfyUI versions. Please try again.","error")}},async fetchComfyUIVersions(){const e=localStorage.getItem("comfyUIVersions");if(e)return JSON.parse(e);try{const e=await fetch("http://localhost:8080/get_comfyui_versions");if(e.ok){let t=await e.json();return localStorage.setItem("comfyUIVersions",JSON.stringify(t)),t}throw new Error("Error fetching ComfyUI versions")}catch(e){return console.error("Error fetching ComfyUI versions:",e),[]}},async fetchCurrentComfyUIVersion(){const e=localStorage.getItem("currentComfyUIVersion");if(e)return e;try{const e=await fetch("http://localhost:8080/get_current_comfyui_version");if(e.ok){let t=await e.text();return localStorage.setItem("currentComfyUIVersion",t),t}throw new Error("Error fetching current ComfyUI version")}catch(e){return console.error("Error fetching current ComfyUI version:",e),""}},renderComfyUIVersions(e,t,n){if(t.innerHTML="",!Array.isArray(e)||0===e.length){let e=document.createElement("div");return e.textContent="No ComfyUI versions found.",e.style.padding="10px",e.style.textAlign="center",void t.appendChild(e)}e.forEach((e=>{let o=document.createElement("tr"),s=document.createElement("td"),l=document.createElement("a");l.textContent=e.id,l.href=`https://github.com/comfyanonymous/ComfyUI/commit/${e.id}`,l.target="_blank",l.style.color="#fff",l.style.textDecoration="none",l.addEventListener("mouseover",(()=>{l.style.color="#fffd01",l.style.cursor="pointer"})),l.addEventListener("mouseout",(()=>{l.style.color="#fff",l.style.cursor="default"})),s.appendChild(l),s.style.padding="10px",s.style.borderBottom="1px solid #444",o.appendChild(s);let r=document.createElement("td");r.textContent=e.message,r.style.padding="10px",r.style.borderBottom="1px solid #444",o.appendChild(r);let i=document.createElement("td");i.textContent=new Date(e.date).toLocaleString(),i.style.padding="10px",i.style.borderBottom="1px solid #444",o.appendChild(i);let a=document.createElement("td"),d=document.createElement("input");d.type="checkbox",d.style.accentColor="#fffd01",d.style.marginLeft="10px";const c=localStorage.getItem("selectedComfyUIVersion")||null;d.checked=e.id===c,d.addEventListener("change",(async t=>{if(e.id===n&&(d.checked=!0),t.target.checked){document.querySelectorAll('input[type="checkbox"]').forEach((e=>{e!==t.target&&(e.checked=!1)}));try{await this.selectComfyUIVersion(e.id)}catch(e){t.target.checked=!1}}else t.preventDefault(),this.showStatusMessage("Please select a version","warning")})),a.appendChild(d),a.style.padding="10px",a.style.borderBottom="1px solid #444",o.appendChild(a),t.appendChild(o)}))},async selectComfyUIVersion(e){try{this.showStatusMessage("Switching ComfyUI version...","warning",!1);const t=await fetch(`http://localhost:8080/select_comfyui_version?version_id=${e}`,{method:"POST"}),n=await t.json();if(!t.ok)throw new Error(n.error||`HTTP error! status: ${t.status}`);console.log(`Selected ComfyUI version: ${e}, Branch: ${n.branch}`),localStorage.setItem("selectedComfyUIVersion",e),localStorage.setItem("currentComfyUIVersion",e),this.selectedComfyUIVersion=e;let o=document.querySelector("#comfyuiContainer div[style*='position: absolute']");o&&(o.textContent=`Current Version: ${e} (${n.branch})`),this.comfyUIVersions&&this.comfyUIVersionsElement?this.renderComfyUIVersions(this.comfyUIVersions,this.comfyUIVersionsElement,e):console.error("ComfyUI versions not loaded or comfyUIVersionsElement not found"),await this.fetchCurrentComfyUIVersion(),this.showStatusMessage(`Successfully switched to version ${e} on branch ${n.branch}. Please restart ComfyUI for changes to take effect.`,"success",5e3)}catch(e){throw console.error("Error selecting ComfyUI version:",e),this.showStatusMessage(`Failed to switch version: ${e.message}`,"error",5e3),e}},showStatusMessage(e,t="success",n=2e3,o=null,s=null){if(!o&&!(o=document.querySelector(".comfly-manager-popup")))return void console.error("Comfly Manager popup not found");let l=o.querySelector(".status-message");l&&l.remove();let r=document.createElement("div");return r.classList.add("status-message"),r.textContent=e,r.style.padding="10px",r.style.margin="0",r.style.color="#191919",r.style.borderRadius="15px",r.style.textAlign="center",r.style.position="absolute",r.style.zIndex="9999",r.style.boxShadow="0 2px 10px rgba(0,0,0,0.2)",o.classList.contains("minimized")?(r.classList.add("minimized-status-message"),r.style.bottom="calc(100% + 5px)",r.style.left="0",r.style.width="90%",r.style.transform="none",r.style.whiteSpace="nowrap",r.style.overflow="hidden",r.style.textOverflow="ellipsis"):(r.style.bottom="10px",r.style.left="50%",r.style.transform="translateX(-50%)",r.style.width="calc(100% - 40px)"),"success"===t?r.style.backgroundColor="#45dd68":"error"===t?(r.style.backgroundColor="#dc3545",r.style.color="#fff"):"warning"===t&&(r.style.backgroundColor="#fffd01"),o.appendChild(r),!1===n||o.classList.contains("minimized")||setTimeout((()=>{r.remove(),s&&s()}),n),r},async restartComfyUI(){try{if(!(await fetch("http://localhost:8080/restart_comfyui",{method:"POST"})).ok)throw new Error("Error restarting ComfyUI");console.log("ComfyUI restarted successfully")}catch(e){console.error("Error restarting ComfyUI:",e)}},async showPluginsTab(){let e=document.getElementById("dependenciesContainer"),t=document.getElementById("comfyuiContainer"),n=document.getElementById("pluginsContainer");e.style.display="none",t.style.display="none",n.style.display="block",n.innerHTML="";let o=document.createElement("div");o.style.position="sticky",o.style.top="0",o.style.backgroundColor="#191919",o.style.zIndex="1000",o.style.padding="0px",o.style.boxShadow="0 2px 4px rgba(0,0,0,0.1)";let s=document.createElement("div");s.style.display="flex",s.style.alignItems="center",s.style.marginBottom="10px";let l=document.createElement("div");l.style.position="relative",l.style.marginRight="20px",l.style.flex="1";let r=document.createElement("input");r.type="text",r.placeholder="Search plugins...",r.style.padding="10px 30px 10px 10px",r.style.width="117%",r.style.border="1px solid #ccc",r.style.borderRadius="4px",r.addEventListener("input",(()=>{this.filterPlugins(r.value)})),l.appendChild(r);let i=document.createElement("i");i.className="fas fa-search",i.style.position="absolute",i.style.right="10px",i.style.top="50%",i.style.transform="translateY(-50%)",i.style.color="#999",l.appendChild(i);let a=document.createElement("button");a.innerHTML='<svg t="1719406809172" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="64362" style="width:45px;height:45px;margin-left:8px;margin-right:189px;"><path d="M480 531.2V224c0-19.2 12.8-32 32-32s32 12.8 32 32v307.2l73.6-73.6c12.8-12.8 32-12.8 44.8 0 12.8 12.8 12.8 32 0 44.8l-128 128c-12.8 12.8-32 12.8-44.8 0l-128-128c-12.8-12.8-12.8-32 0-44.8 12.8-12.8 32-12.8 44.8 0l73.6 73.6zM160 576c0-19.2 12.8-32 32-32s32 12.8 32 32v160c0 19.2 12.8 32 32 32h512c19.2 0 32-12.8 32-32v-160c0-19.2 12.8-32 32-32s32 12.8 32 32v160c0 54.4-41.6 96-96 96H256c-54.4 0-96-41.6-96-96v-160z" p-id="64363" fill="#fffd01"></path></svg>',a.title="Install plugin",a.style.padding="10px 20px",a.style.borderRadius="4px",a.style.backgroundColor="#fffd0100",a.style.color="#191919",a.style.border="none",a.style.cursor="pointer",a.style.marginRight="-12px",a.addEventListener("click",(async()=>{let e=r.value.trim();e&&(await this.installPlugin(e),r.value="")}));let d=document.createElement("button");d.innerHTML='\n        <svg t="1719407150025" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="76145" width="30" height="30">\n            <path d="M359.375238 470.064762a40.96 40.96 0 1 0-58.026667 58.026667l146.285715 146.285714a39.009524 39.009524 0 0 0 55.100952 0l255.512381-255.512381a39.009524 39.009524 0 0 0 0-55.100952l-3.413333-3.413334a39.009524 39.009524 0 0 0-55.100953 0l-220.891428 229.180953zM868.449524 585.142857a356.449524 356.449524 0 0 1-712.899048 0V208.213333L512 82.407619l356.449524 125.805714zM512 0L73.142857 146.285714v438.857143a438.857143 438.857143 0 0 0 877.714286 0V146.285714z" fill="#fffd01" p-id="76146"></path>\n        </svg>',d.title="Safety Feature",d.style.padding="8px 1px",d.style.borderRadius="4px",d.style.backgroundColor="#28a74500",d.style.color="#fff",d.style.border="none",d.style.cursor="pointer",d.style.marginRight="10px",d.addEventListener("click",(()=>{window.open("https://www.virustotal.com/gui/home/upload","_blank","width=800,height=900,resizable=yes,menubar=no,location=no,status=no")}));let c=document.createElement("div");c.style.display="flex",c.style.alignItems="center",c.style.backgroundColor="#fffd01",c.style.padding="5px 10px",c.style.borderRadius="4px";let p=document.createElement("span");p.textContent="Plugins: ",p.style.marginRight="5px",p.style.color="#191919",c.appendChild(p);let u=document.createElement("span");u.id="pluginsCount",u.textContent="0",u.style.color="#191919",c.appendChild(u);let y=document.createElement("button");y.innerHTML='\n        <svg t="1722006080769" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="18050" width="35" height="35">\n            <path d="M706.56 563.2c117.76-10.24 215.04-107.52 215.04-230.4 0-20.48-5.12-40.96-10.24-61.44-5.12-15.36-20.48-20.48-30.72-15.36-5.12-5.12-10.24 0-10.24 0l-46.08 46.08c-25.6 25.6-76.8 25.6-102.4 0-30.72-30.72-30.72-76.8 0-102.4L768 153.6c5.12-5.12 10.24-15.36 5.12-25.6 0-10.24-10.24-15.36-15.36-20.48-25.6 0-46.08-5.12-66.56-5.12C563.2 102.4 460.8 204.8 460.8 332.8c0 10.24 0 25.6 5.12 35.84l-30.72 30.72-148.48-148.48c15.36-30.72 10.24-61.44-15.36-87.04l-51.2-56.32c-10.24-5.12-25.6-5.12-35.84 0L107.52 184.32c-5.12 10.24-5.12 25.6 0 35.84l56.32 56.32c15.36 15.36 35.84 20.48 56.32 20.48 10.24 0 20.48-5.12 30.72-5.12l143.36 143.36-250.88 225.28c-25.6 25.6-40.96 66.56-40.96 107.52s15.36 81.92 46.08 107.52c25.6 30.72 66.56 46.08 107.52 46.08s81.92-15.36 107.52-46.08l174.08-189.44 204.8 204.8c25.6 20.48 51.2 30.72 76.8 30.72s51.2-10.24 71.68-30.72c20.48-20.48 30.72-46.08 30.72-71.68 0-25.6-10.24-51.2-30.72-71.68L706.56 563.2zM235.52 235.52c-10.24 10.24-25.6 10.24-35.84 0l-35.84-35.84 35.84-35.84 35.84 35.84c10.24 10.24 10.24 25.6 0 35.84z m92.16 604.16c-40.96 40.96-107.52 40.96-143.36 0-20.48-20.48-30.72-46.08-30.72-71.68 0-25.6 10.24-51.2 30.72-71.68L512 399.36v-5.12-61.44C512 235.52 593.92 153.6 691.2 153.6l-10.24 10.24c-51.2 51.2-51.2 128 0 179.2 25.6 25.6 56.32 35.84 87.04 35.84 35.84 0 66.56-15.36 87.04-35.84l15.36-10.24c0 97.28-81.92 179.2-179.2 179.2-15.36 0-25.6 0-40.96-5.12h-5.12-5.12-5.12-5.12l-302.08 332.8z m527.36 15.36c-20.48 20.48-51.2 20.48-71.68 0l-199.68-199.68 71.68-71.68 199.68 199.68c10.24 10.24 15.36 20.48 15.36 35.84 0 15.36-5.12 25.6-15.36 35.84zM256 716.8c-30.72 0-51.2 20.48-51.2 51.2s20.48 51.2 51.2 51.2 51.2-20.48 51.2-51.2-20.48-51.2-51.2-51.2z" fill="#d81e06" p-id="18051"></path>\n        </svg>',y.title="Fix All Detached Branches",y.style.padding="0px 0px",y.style.borderRadius="4px",y.style.backgroundColor="#28a74500",y.style.color="#fff",y.style.border="none",y.style.cursor="pointer",y.style.marginRight="-11px",y.addEventListener("click",(async()=>{await this.fixAllDetachedBranches()}));let h=document.createElement("button");h.innerHTML='\n        <svg t="1719637400376" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="10279" width="30" height="30" style="margin-left:10px;margin-right:-17px;">\n            <path d="M873.629538 1.102769h-727.04A145.408 145.408 0 0 0 1.024 146.510769v727.118769c0 80.344615 65.063385 145.486769 145.408 145.48677h727.118769c80.344615 0 145.486769-65.142154 145.486769-145.48677v-727.04c0-80.344615-65.142154-145.486769-145.486769-145.486769h0.078769z m72.861539 872.763077a72.467692 72.467692 0 0 1-72.310154 72.625231H146.747077a72.467692 72.467692 0 0 1-51.593846-21.267692 72.152615 72.152615 0 0 1-21.425231-51.357539V146.589538c0-40.251077 32.689231-72.861538 72.940308-72.861538h727.04c40.172308 0 72.782769 32.610462 72.782769 72.782769v727.355077z m-118.075077-545.634461H537.521231a36.312615 36.312615 0 1 0 0 72.704h290.894769a36.312615 36.312615 0 1 0 0-72.704z m0 291.052307H537.521231a36.312615 36.312615 0 1 0 0 72.625231h290.894769a36.312615 36.312615 0 1 0 0-72.625231zM319.330462 528.384a127.291077 127.291077 0 1 0 0 254.503385 127.291077 127.291077 0 0 0 0-254.424616v-0.078769z m38.596923 165.888a54.587077 54.587077 0 1 1-77.193847-77.193846 54.587077 54.587077 0 0 1 77.193847 77.193846z m44.819692-427.953231l-119.729231 119.729231-47.104-46.946462a36.312615 36.312615 0 1 0-51.357538 51.357539l72.704 72.704c14.178462 14.178462 37.179077 14.178462 51.357538 0l145.486769-145.408a36.312615 36.312615 0 0 0-51.357538-51.436308z" fill="#fffd01" p-id="10280"></path>\n        </svg>',h.title="Check for Updates",h.style.padding="0px 17px",h.style.borderRadius="4px",h.style.backgroundColor="#28a74500",h.style.color="#fff",h.style.border="none",h.style.cursor="pointer",h.style.marginRight="0px",h.addEventListener("click",(async()=>{await this.checkPluginUpdates()})),s.appendChild(h),s.insertBefore(y,h);let g=document.createElement("button");g.innerHTML='\n        <svg t="1719407115924" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="74856" width="35" height="35">\n            <path d="M577.6 825.6c-102.4 20.8-212.8-8-291.2-86.4-116.8-116.8-124.8-299.2-24-424v59.2c0 17.6 14.4 32 32 32s32-14.4 32-32v-128c0-9.6-3.2-17.6-9.6-22.4-6.4-6.4-14.4-9.6-22.4-9.6h-128c-17.6 0-32 14.4-32 32s14.4 32 32 32h44.8C91.2 427.2 102.4 644.8 240 784c96 96 228.8 129.6 352 104 4.8-1.6 11.2-4.8 14.4-8 12.8-12.8 12.8-32 0-44.8-6.4-9.6-19.2-12.8-28.8-9.6zM859.2 747.2H816c116.8-150.4 107.2-368-32-507.2-89.6-89.6-211.2-124.8-328-108.8-8 0-14.4 3.2-20.8 9.6-12.8 12.8-12.8 32 0 44.8 8 8 19.2 11.2 30.4 8 96-14.4 198.4 16 272 89.6 116.8 116.8 124.8 299.2 24 424v-59.2c0-17.6-14.4-32-32-32s-32 14.4-32 32v128c0 9.6 3.2 17.6 9.6 22.4 6.4 6.4 14.4 9.6 22.4 9.6h128c17.6 0 32-14.4 32-32s-12.8-28.8-30.4-28.8z" fill="#fffd01" p-id="74857"></path>\n        </svg>',g.title="Update All",g.style.padding="1px 14px",g.style.borderRadius="4px",g.style.backgroundColor="#28a74500",g.style.color="#fff",g.style.border="none",g.style.cursor="pointer",g.style.marginRight="-3px",g.addEventListener("click",(async()=>{await this.updateAllPlugins()})),s.appendChild(l),s.appendChild(a),s.appendChild(y),s.appendChild(h),s.appendChild(g),s.appendChild(d),s.appendChild(c),o.appendChild(s),n.appendChild(o);let m=document.createElement("div");m.style.marginTop="10px",n.appendChild(m);let f=document.createElement("table");f.style.width="100%",f.style.borderCollapse="collapse";let x=document.createElement("thead"),C=document.createElement("tr");["Plugin Name","Branch","Enabled","Folder","Actions"].forEach((e=>{let t=document.createElement("th");t.textContent=e,t.style.padding="10px",t.style.textAlign="left",t.style.borderBottom="2px solid #444",t.style.fontSize="14px",C.appendChild(t)})),x.appendChild(C),f.appendChild(x);let b=document.createElement("tbody");b.id="pluginsList",f.appendChild(b),m.appendChild(f);const w=localStorage.getItem("plugins");w?(this.plugins=JSON.parse(w),this.renderPlugins(this.plugins,b),u.textContent=this.plugins.length):(this.renderPlugins([],b),u.textContent="0")},async fixAllDetachedBranches(){let e=this.showStatusMessage("Fixing all detached branches...","warning",!1,this.dependenciesPopup);const t=this.plugins.map((async e=>{"Detached"===e.branch.default_branch&&await this.fixDetachedBranch(e.name)}));await Promise.all(t),await this.fetchPlugins(),this.renderPlugins(this.plugins,document.getElementById("pluginsList")),e.remove(),this.showStatusMessage("All detached branches fixed.","success",2e3,this.dependenciesPopup)},async checkPluginUpdates(){let e=this.showStatusMessage("Checking for updates...","warning",!1,this.dependenciesPopup);const t=this.plugins.map((async e=>{if(e.url){const t=await fetch(`http://localhost:8080/get_plugin_versions?plugin_name=${e.name}`);if(t.ok){const n=await t.json();if(n.length>0){if(n[0].id!==e.version){e.hasNewVersion=!0,localStorage.setItem(`plugin_${e.name}_hasNewVersion`,"true");const t=document.querySelector(`tr[data-plugin="${e.name}"] .update-button`);t&&(t.style.backgroundColor="#ff0000")}else{e.hasNewVersion=!1,localStorage.setItem(`plugin_${e.name}_hasNewVersion`,"false");const t=document.querySelector(`tr[data-plugin="${e.name}"] .update-button`);t&&(t.style.backgroundColor="#fffd01")}}}}}));await Promise.all(t),e.remove(),this.showStatusMessage("Check completed.","success",2e3,this.dependenciesPopup)},async fetchPlugins(){try{const e=localStorage.getItem("plugins");if(e)this.plugins=JSON.parse(e);else{const e=await fetch("http://localhost:8080/get_plugins");if(!e.ok)throw new Error("Error fetching plugins");this.plugins=await e.json(),localStorage.setItem("plugins",JSON.stringify(this.plugins))}for(let e of this.plugins)if("directory"===e.type){const t=localStorage.getItem(`plugin_${e.name}_default_branch`);if(t)e.defaultBranch=JSON.parse(t);else try{const t=await fetch(`http://localhost:8080/get_plugin_default_branch?plugin_name=${encodeURIComponent(e.name)}`);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);{const n=await t.json();e.defaultBranch=n.default_branch,localStorage.setItem(`plugin_${e.name}_default_branch`,JSON.stringify(n.default_branch))}}catch(t){console.error(`Error getting default branch for plugin ${e.name}:`,t),e.defaultBranch="unknown"}}else e.defaultBranch="";localStorage.setItem("plugins",JSON.stringify(this.plugins))}catch(e){console.error("Error fetching plugins:",e)}},async renderPlugins(e,t){if(t.innerHTML="",0===e.length){let e=document.createElement("div");return e.textContent="No plugins found.",e.style.padding="10px",e.style.textAlign="center",void t.appendChild(e)}e.forEach((async e=>{let n=document.createElement("tr");n.setAttribute("data-plugin",e.name);let o=document.createElement("td");if(e.url){let t=document.createElement("a");t.textContent=e.name,t.href=e.url,t.target="_blank",t.style.color="#fff",t.style.textDecoration="none",t.addEventListener("mouseover",(()=>{t.style.color="#fffd01",t.style.cursor="pointer"})),t.addEventListener("mouseout",(()=>{t.style.color="#fff",t.style.cursor="default"})),o.appendChild(t)}else o.textContent=e.name;o.style.padding="10px",o.style.borderBottom="1px solid #444",o.style.width="35%",o.style.wordBreak="break-word",n.appendChild(o);let s=document.createElement("td");if("main"!==e.branch&&"master"!==e.branch){let t=document.createElement("a");t.textContent=e.branch,t.style.color="#fffd01",t.style.cursor="pointer",t.addEventListener("click",(async()=>{await this.fixPluginBranch(e.name)})),s.appendChild(t)}else s.textContent=e.branch;s.style.padding="10px",s.style.borderBottom="1px solid #444",n.appendChild(s);let l=document.createElement("td");if(l.style.padding="10px",l.style.borderBottom="1px solid #444",l.style.width="10%",l.style.textAlign="left",void 0!==e.enabled){let t=document.createElement("input");t.type="checkbox",t.style.accentColor="#fffd01",t.checked=e.enabled,t.addEventListener("change",(async()=>{e.enabled=t.checked,await this.togglePlugin(e.name,e.enabled)})),l.appendChild(t)}else l.textContent="Unknown";n.appendChild(l);let r=document.createElement("td"),i=document.createElement("a");i.textContent="Open Folder",i.href="#",i.style.color="#fff",i.style.textDecoration="none",i.addEventListener("mouseover",(()=>{i.style.color="#fffd01",i.style.cursor="pointer"})),i.addEventListener("mouseout",(()=>{i.style.color="#fff",i.style.cursor="default"})),i.addEventListener("click",(async()=>{await this.openPluginFolder(e.name)})),r.appendChild(i),r.style.padding="10px",r.style.borderBottom="1px solid #444",r.style.width="15%",r.style.textAlign="left",n.appendChild(r);let a=document.createElement("td");if(e.url){let t=document.createElement("button");t.classList.add("update-button"),t.textContent="Update",t.style.marginRight="5px",t.style.padding="6px 10px",t.style.borderRadius="4px";const n="true"===localStorage.getItem(`plugin_${e.name}_hasNewVersion`);t.style.backgroundColor=n?"#ff0000":"#fffd01",t.style.color="#191919",t.style.border="none",t.style.cursor="pointer",t.addEventListener("click",(async()=>{try{await this.updatePlugin(e.name),e.hasNewVersion=!1,localStorage.setItem(`plugin_${e.name}_hasNewVersion`,"false"),t.style.backgroundColor="#fffd01"}catch(t){console.error(`Error updating plugin: ${e.name}`,t)}})),a.appendChild(t);let o=document.createElement("button");o.textContent="Switch",o.style.marginRight="5px",o.style.padding="6px 10px",o.style.borderRadius="4px",o.style.backgroundColor="#fffd01",o.style.color="#191919",o.style.border="none",o.style.cursor="pointer",o.addEventListener("click",(async()=>{await this.switchPluginVersion(e.name)})),a.appendChild(o)}else{let e=document.createElement("button");e.textContent="Not git clone",e.style.padding="6px 26px",e.style.borderRadius="4px",e.style.backgroundColor="#6c757d",e.style.color="#fff",e.style.border="none",e.style.cursor="default",e.style.marginRight="5px",a.appendChild(e)}let d=document.createElement("button");d.textContent="View",d.style.marginRight="5px",d.style.padding="6px 10px",d.style.borderRadius="4px",d.style.backgroundColor="#3d3d3f",d.style.color="#fff",d.style.border="none",d.style.cursor="pointer",d.addEventListener("click",(async()=>{await this.viewPluginRequirements(e.name)})),a.appendChild(d),a.style.padding="10px",a.style.borderBottom="1px solid #444",a.style.width="25%",a.style.textAlign="left",n.appendChild(a),e.hasNewVersion&&(o.style.color="#dc3545"),t.appendChild(n)}))},async fixDetachedBranch(e){console.log("fixDetachedBranch called with",e);try{console.log("Fetching default branch");const t=await fetch(`http://localhost:8080/get_plugin_default_branch?plugin_name=${encodeURIComponent(e)}`);if(console.log("Default branch response received",t),t.ok){const n=await t.json();console.log("Default branch:",n);try{const t=await fetch(`http://localhost:8080/checkout_plugin_branch?plugin_name=${encodeURIComponent(e)}`,{method:"POST"});if(t.ok){console.log("Checkout success");const t=await fetch(`http://localhost:8080/get_plugin_default_branch?plugin_name=${encodeURIComponent(e)}`);if(t.ok){const n=await t.json();console.log("Updated default branch:",n);const o=this.plugins.find((t=>t.name===e));if(o){o.branch=n,localStorage.setItem("plugins",JSON.stringify(this.plugins));const t=document.querySelector(`tr[data-plugin="${e}"]`);if(t){const e=t.children[1];e.textContent=n.default_branch,e.style.color="#fff"}console.log("Plugin status updated")}this.showStatusMessage(`Successfully switched plugin ${e} to default branch`,"success",2e3,this.dependenciesPopup)}else console.error("Failed to get updated default branch"),this.showStatusMessage(`Error getting updated default branch for plugin ${e}. HTTP error! status: ${t.status}`,"error",2e3,this.dependenciesPopup)}else console.error("Checkout failed"),this.showStatusMessage(`Error switching plugin ${e} to default branch. HTTP error! status: ${t.status}`,"error",2e3,this.dependenciesPopup)}catch(t){console.error("Error during checkout:",t),this.showStatusMessage(`Error switching plugin ${e} to default branch. ${t.message}`,"error",2e3,this.dependenciesPopup)}}else console.error("Get default branch failed"),this.showStatusMessage(`Error getting default branch for plugin ${e}. HTTP error! status: ${t.status}`,"error",2e3,this.dependenciesPopup)}catch(t){console.error(`Error fixing detached branch for plugin ${e}:`,t),this.showStatusMessage(`Error fixing detached branch for plugin ${e}. ${t.message}`,"error",2e3,this.dependenciesPopup)}},async updateAllPlugins(){const e=this.plugins.filter((e=>e.url&&e.hasNewVersion));if(0!==e.length){this.showStatusMessage("Updating plugins...","success",!1);for(let t of e)try{await this.updatePlugin(t.name),t.hasNewVersion=!1,localStorage.setItem(`plugin_${t.name}_hasNewVersion`,JSON.stringify(!1));const e=document.querySelector(`tr[data-plugin="${t.name}"] .update-button`);e&&(e.style.backgroundColor="#fffd01"),this.showStatusMessage(`Successfully updated plugin: ${t.name}`,"success",2e3)}catch(e){console.error(`Error updating plugin: ${t.name}`,e),t.hasNewVersion=!0,localStorage.setItem(`plugin_${t.name}_hasNewVersion`,JSON.stringify(!0)),this.showStatusMessage(`Error updating plugin: ${t.name}: ${e.message}`,"error",2e3)}await this.checkPluginUpdates(),this.renderPlugins(this.plugins,document.getElementById("pluginsList")),this.showStatusMessage("Update completed.","success",2e3,this.dependenciesPopup)}else this.showStatusMessage("No plugins need to be updated.","success",2e3,this.dependenciesPopup)},async togglePlugin(e,t){try{if(!(await fetch(`http://localhost:8080/toggle_plugin?plugin_name=${e}&enabled=${t}`,{method:"POST"})).ok)throw new Error(`Error ${t?"enabling":"disabling"} plugin`);{console.log(`${t?"Enabled":"Disabled"} plugin: ${e}`);const n=this.plugins.findIndex((t=>t.name===e));-1!==n&&(this.plugins[n].enabled=t,localStorage.setItem("plugins",JSON.stringify(this.plugins))),this.renderPlugins(this.plugins,document.getElementById("pluginsList"))}}catch(e){console.error(`Error ${t?"enabling":"disabling"} plugin:`,e)}},async openPluginFolder(e){try{const t=this.plugins.findIndex((t=>t.name===e)),n=this.plugins[t].enabled?e:`${e}.disabled`,o=await fetch(`http://localhost:8080/open_plugin_folder?plugin_name=${encodeURIComponent(n)}`,{method:"POST"});if(!o.ok)throw console.error(`Error opening plugin folder for ${e}`),console.error(`HTTP error! status: ${o.status}`),new Error(`HTTP error! status: ${o.status}`);console.log(`Opened folder for plugin: ${e}`)}catch(e){console.error("Error opening plugin folder:",e)}},filterPlugins(e){let t=this.plugins.filter((t=>t.name.toLowerCase().includes(e.toLowerCase()))),n=document.getElementById("pluginsList");this.renderPlugins(t,n),document.getElementById("pluginsCount").textContent=t.length},async installPlugin(e){if(e)try{let t=e.split("/").pop().replace(".git","");if(this.plugins.find((e=>e.name===t))&&!confirm(`Plugin ${t} already exists. Do you want to overwrite it?`))return void console.log(`Plugin ${t} installation cancelled by user`);let n=document.createElement("div");n.classList.add("message"),n.textContent=`Installing plugin from: ${e}`,n.style.padding="10px",n.style.marginBottom="10px",n.style.backgroundColor="#fffd01",n.style.color="#191919",n.style.borderRadius="4px",document.getElementById("pluginsContainer").prepend(n);const o=await fetch(`http://localhost:8080/install_plugin?git_url=${encodeURIComponent(e)}&plugin_name=${t}&overwrite=${!!this.plugins.find((e=>e.name===t))}`,{method:"POST"});if(!o.ok){const t=await o.text();throw n.innerHTML=`Error installing plugin from: ${e}<br><pre>${t}</pre>`,n.style.backgroundColor="#dc3545",console.error("Installation error:"),console.error(t),new Error("Error installing plugin")}{console.log(`Installed plugin from: ${e}`),n.textContent=`Plugin installed successfully from: ${e}`,n.style.backgroundColor="#45dd68",setTimeout((()=>{n.style.display="none"}),2e3);const o=await this.getPluginDetails(t);this.plugins.push(o),localStorage.setItem("plugins",JSON.stringify(this.plugins)),this.renderNewPlugin(o,document.getElementById("pluginsList")),document.getElementById("pluginsCount").textContent=this.plugins.length}}catch(e){console.error("Error installing plugin:",e)}},async getPluginDetails(e){try{const t=await fetch(`http://localhost:8080/get_plugin_details?plugin_name=${encodeURIComponent(e)}`);if(t.ok)return await t.json();throw new Error(`HTTP error! status: ${t.status}`)}catch(t){return console.error(`Error getting details for plugin ${e}:`,t),null}},renderNewPlugin(e,t){let n=document.createElement("tr");n.setAttribute("data-plugin",e.name);let o=document.createElement("td");if(e.url){let t=document.createElement("a");t.textContent=e.name,t.href=e.url,t.target="_blank",t.style.color="#fff",t.style.textDecoration="none",t.addEventListener("mouseover",(()=>{t.style.color="#fffd01",t.style.cursor="pointer"})),t.addEventListener("mouseout",(()=>{t.style.color="#fff",t.style.cursor="default"})),o.appendChild(t)}else o.textContent=e.name;o.style.padding="10px",o.style.borderBottom="1px solid #444",o.style.width="35%",o.style.wordBreak="break-word",n.appendChild(o);let s=document.createElement("td");if("main"!==e.branch&&"master"!==e.branch){let t=document.createElement("a");t.textContent=e.branch,t.style.color="#fffd01",t.style.cursor="pointer",t.addEventListener("click",(async()=>{await this.fixPluginBranch(e.name)})),s.appendChild(t)}else s.textContent=e.branch;s.style.padding="10px",s.style.borderBottom="1px solid #444",n.appendChild(s);let l=document.createElement("td");if(l.style.padding="10px",l.style.borderBottom="1px solid #444",l.style.width="10%",l.style.textAlign="left",void 0!==e.enabled){let t=document.createElement("input");t.type="checkbox",t.style.accentColor="#fffd01",t.checked=e.enabled,t.addEventListener("change",(async()=>{e.enabled=t.checked,await this.togglePlugin(e.name,e.enabled)})),l.appendChild(t)}else l.textContent="Unknown";n.appendChild(l);let r=document.createElement("td"),i=document.createElement("a");i.textContent="Open Folder",i.href="#",i.style.color="#fff",i.style.textDecoration="none",i.addEventListener("mouseover",(()=>{i.style.color="#fffd01",i.style.cursor="pointer"})),i.addEventListener("mouseout",(()=>{i.style.color="#fff",i.style.cursor="default"})),i.addEventListener("click",(async()=>{await this.openPluginFolder(e.name)})),r.appendChild(i),r.style.padding="10px",r.style.borderBottom="1px solid #444",r.style.width="15%",r.style.textAlign="left",n.appendChild(r);let a=document.createElement("td");if(e.url){let t=document.createElement("button");t.classList.add("update-button"),t.textContent="Update",t.style.marginRight="5px",t.style.padding="6px 10px",t.style.borderRadius="4px";const n="true"===localStorage.getItem(`plugin_${e.name}_hasNewVersion`);t.style.backgroundColor=n?"#ff0000":"#fffd01",t.style.color="#191919",t.style.border="none",t.style.cursor="pointer",t.addEventListener("click",(async()=>{try{await this.updatePlugin(e.name),e.hasNewVersion=!1,localStorage.setItem(`plugin_${e.name}_hasNewVersion`,"false"),t.style.backgroundColor="#fffd01"}catch(t){console.error(`Error updating plugin: ${e.name}`,t)}})),a.appendChild(t);let o=document.createElement("button");o.textContent="Switch",o.style.marginRight="5px",o.style.padding="6px 10px",o.style.borderRadius="4px",o.style.backgroundColor="#fffd01",o.style.color="#191919",o.style.border="none",o.style.cursor="pointer",o.addEventListener("click",(async()=>{await this.switchPluginVersion(e.name)})),a.appendChild(o)}else{let e=document.createElement("button");e.textContent="Not git clone",e.style.padding="6px 26px",e.style.borderRadius="4px",e.style.backgroundColor="#6c757d",e.style.color="#fff",e.style.border="none",e.style.cursor="default",e.style.marginRight="5px",a.appendChild(e)}let d=document.createElement("button");d.textContent="View",d.style.marginRight="5px",d.style.padding="6px 15px",d.style.borderRadius="4px",d.style.backgroundColor="#3d3d3f",d.style.color="#fff",d.style.border="none",d.style.cursor="pointer",d.addEventListener("click",(async()=>{await this.viewPluginRequirements(e.name)})),a.appendChild(d),a.style.padding="10px",a.style.borderBottom="1px solid #444",a.style.width="25%",a.style.textAlign="left",n.appendChild(a),e.hasNewVersion&&(o.style.color="#dc3545"),t.appendChild(n)},async fixPluginBranch(e){try{const t=await fetch(`http://localhost:8080/fix_plugin_branch?plugin_name=${encodeURIComponent(e)}`,{method:"POST"});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);this.showStatusMessage(`Successfully fixed branch for plugin: ${e}`,"success",2e3),await this.fetchPlugins(),this.renderPlugins(this.plugins,document.getElementById("pluginsList"))}catch(t){console.error(`Error fixing branch for plugin ${e}:`,t),this.showStatusMessage(`Error fixing branch for plugin ${e}: ${t.message}`,"error",2e3)}},async updatePlugin(e){let t=null;try{t=this.showStatusMessage(`Updating plugin: ${e}`,"warning",!1);const n=await fetch(`http://localhost:8080/get_plugin_default_branch?plugin_name=${encodeURIComponent(e)}`);if(!n.ok)throw new Error(`Error getting default branch for plugin: ${e}. HTTP error! status: ${n.status}`);{const o=await n.text();if(o&&"Detached"!==o){const t=await fetch(`http://localhost:8080/checkout_plugin_branch?plugin_name=${encodeURIComponent(e)}&branch=${encodeURIComponent(o)}`,{method:"POST"});if(!t.ok)throw new Error(`Error switching to default branch for plugin: ${e}. HTTP error! status: ${t.status}`)}const s=await fetch(`http://localhost:8080/update_plugin?plugin_name=${encodeURIComponent(e)}&overwrite=true`,{method:"POST"});if(!s.ok)throw new Error(`Error updating plugin: ${e}. HTTP error! status: ${s.status}`);{localStorage.removeItem("plugins"),await this.fetchPlugins();const n=this.plugins.find((t=>t.name===e));n&&(n.version="latest",localStorage.setItem("plugins",JSON.stringify(this.plugins))),t.remove(),this.showStatusMessage(`Successfully updated plugin: ${e}`,"success",2e3)}}}catch(n){console.error("Error updating plugin:",n),t&&t.remove(),this.showStatusMessage(`Error updating plugin: ${e}. ${n.message}`,"error",2e3)}},async switchPluginVersion(e){try{const t=await fetch(`http://localhost:8080/get_plugin_versions?plugin_name=${e}`);if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);{const n=await t.json(),o=n.versions,s=n.author,l=this.selectedVersions[e]||null;await this.renderPluginVersions(e,s,o,l)}}catch(t){console.error("Error fetching plugin versions:",t),this.showStatusMessage(`Error fetching versions for plugin ${e}: ${t.message}`,"error",2e3)}},async getCurrentPluginVersion(e){try{const t=await fetch(`http://localhost:8080/get_current_plugin_version?plugin_name=${e}`);if(t.ok){return await t.text()}throw new Error("Error fetching current plugin version")}catch(e){return console.error("Error fetching current plugin version:",e),""}},async selectPluginVersion(e,t){try{const n=await fetch(`http://localhost:8080/select_plugin_version?plugin_name=${e}&version=${t}`,{method:"POST"});if(n.ok){const o=await n.json();if(o.success){console.log(`Switched to version ${t} for plugin: ${e}`),this.selectedVersions[e]=t,localStorage.setItem("selectedVersions",JSON.stringify(this.selectedVersions));const n=this.plugins.findIndex((t=>t.name===e));return-1!==n&&(this.plugins[n].version=t,localStorage.setItem("plugins",JSON.stringify(this.plugins))),await this.fetchPlugins(),this.renderPlugins(this.plugins,document.getElementById("pluginsList")),this.showStatusMessage(`Successfully switched to version ${t} for plugin: ${e}`,"success",2e3),!0}throw new Error(o.message||"Failed to switch plugin version")}throw new Error("Error switching plugin version")}catch(t){return console.error("Error switching plugin version:",t),this.showStatusMessage(`Error switching version for plugin ${e}: ${t.message}`,"error",2e3),!1}},async viewPluginRequirements(e){try{const t=await fetch(`http://localhost:8080/view_plugin_requirements?plugin_name=${e}`);if(t.ok){const n=await t.text();this.renderPluginRequirements(e,n)}else{const e=await t.json();console.error("Error fetching plugin requirements:",e.error),alert(`Error: ${e.error}`)}}catch(e){console.error("Error fetching plugin requirements:",e),alert(`Error: ${e.message}`)}},async installPluginRequirements(e,t){try{let n=document.createElement("div");n.classList.add("message"),n.textContent=`Installing requirements for plugin: ${e}`,n.style.padding="10px",n.style.marginBottom="10px",n.style.backgroundColor="#fffd01",n.style.color="#191919",n.style.borderRadius="4px",document.getElementById("notificationContainer").appendChild(n),t.value="";const o=await fetch(`http://localhost:8080/install_plugin_requirements?plugin_name=${encodeURIComponent(e)}`,{method:"POST"}),s=o.body.getReader(),l=new TextDecoder("utf-8");for(;;){const{value:e,done:n}=await s.read();if(n)break;const o=l.decode(e);console.log(o),t.value+=o,t.scrollTop=t.scrollHeight}o.ok?(n.textContent=`Requirements installed successfully for plugin: ${e}`,n.style.backgroundColor="#45dd68",this.initialRequirements[e]=t.value,localStorage.setItem("initialRequirements",JSON.stringify(this.initialRequirements))):(n.textContent=`Error installing requirements for plugin: ${e}`,n.style.backgroundColor="#dc3545"),setTimeout((()=>{n.remove()}),2e3)}catch(e){console.error("Error installing plugin requirements:",e)}},renderPluginRequirements(e,t){let n=document.createElement("div");n.style.position="fixed",n.style.top="50%",n.style.left="50%",n.style.transform="translate(-50%, -50%)",n.style.width="450px",n.style.maxHeight="500px",n.style.overflowY="auto",n.style.padding="20px",n.style.background="#191919",n.style.borderRadius="5px",n.style.border="2px solid #fffd01",n.style.zIndex="9999",n.style.boxShadow="0 4px 6px rgba(0, 0, 0, 0.1)",n.style.color="#fff";let o=document.createElement("button");o.textContent="Ã—",o.style.position="absolute",o.style.right="10px",o.style.top="10px",o.style.background="transparent",o.style.border="none",o.style.fontSize="20px",o.style.cursor="pointer",o.style.color="#fff",o.addEventListener("click",(()=>{n.remove()})),n.appendChild(o);let s=document.createElement("h3");s.textContent=`Requirements for ${e}`,s.style.marginBottom="10px",n.appendChild(s);let l=document.createElement("textarea");l.value=t?t.replace(/\\n/g,"\n").replace(/"/g,""):"No requirements found.";let r="";this.initialRequirements&&this.initialRequirements[e]&&(r=this.initialRequirements[e]),l.style.width="100%",l.style.height="150px",l.style.padding="5px",l.style.borderRadius="4px",l.style.backgroundColor="#3d3d3f",l.style.color="#fff",l.readOnly=!0,n.appendChild(l);let i=document.createElement("button");i.textContent="Edit",i.style.marginTop="10px",i.style.padding="5px 10px",i.style.borderRadius="4px",i.style.backgroundColor="#fffd01",i.style.color="#191919",i.style.border="none",i.style.cursor="pointer",i.addEventListener("click",(()=>{l.readOnly=!1,l.focus()})),n.appendChild(i);let a=document.createElement("button");a.textContent="Save",a.style.marginLeft="10px",a.style.padding="5px 10px",a.style.borderRadius="4px",a.style.backgroundColor="#fffd01",a.style.color="#191919",a.style.border="none",a.style.cursor="pointer",a.addEventListener("click",(async()=>{await this.savePluginRequirements(e,l.value)})),n.appendChild(a);let d=document.createElement("button");d.textContent="Install",d.style.marginLeft="10px",d.style.padding="5px 10px",d.style.borderRadius="4px",d.style.backgroundColor="#3d3d3f",d.style.color="#fff",d.style.border="none",d.style.cursor="pointer",d.addEventListener("click",(async()=>{await this.installPluginRequirements(e,c)})),n.appendChild(d);let c=document.createElement("textarea");c.style.width="100%",c.style.height="150px",c.style.padding="5px",c.style.marginTop="13px",c.style.borderRadius="4px",c.style.backgroundColor="#3d3d3f",c.style.color="#fff",c.style.readOnly=!0,c.style.overflowY="scroll",n.appendChild(c);const p=this.initialRequirements[e]||"";c.value=p,document.body.appendChild(n)},async savePluginRequirements(e,t){try{const n=await fetch(`http://localhost:8080/edit_plugin_requirements?plugin_name=${e}`,{method:"POST",body:t});if(n.ok)console.log(`Saved requirements for plugin: ${e}`),await this.fetchPlugins(),this.showPluginsTab();else{const e=await n.json();console.error("Error saving plugin requirements:",e.error),alert(`Error: ${e.error}`)}}catch(e){console.error("Error saving plugin requirements:",e),alert(`Error: ${e.message}`)}},async editPluginRequirements(e,t){try{const n=await fetch(`http://localhost:8080/edit_plugin_requirements?plugin_name=${e}`,{method:"POST",body:t});if(n.ok)console.log(`Edited requirements for plugin: ${e}`),await this.fetchPlugins(),this.showPluginsTab();else{const e=await n.json();console.error("Error editing plugin requirements:",e.error),alert(`Error: ${e.error}`)}}catch(e){console.error("Error editing plugin requirements:",e),alert(`Error: ${e.message}`)}}};
