import{app}from"../../../scripts/app.js";import{$el}from"../../../scripts/ui.js";let pb_cache={};async function getStyles(e){if(pb_cache[e])return pb_cache[e];const t=await fetch(`http://localhost:8080/mjstyle/${e}.json`);if(200===t.status){let s=await t.json();return pb_cache[e]=s,s}}function createTagElement(e,t,s){return $el("label.Comfly_style-model-tag.comfy-btn",{dataset:{tag:e.name,name:e.name,negativePrompt:e.negative_prompt},style:{margin:"5px",display:"inline-flex",alignItems:"center",justifyContent:"space-between",fontSize:"16px"},onclick:t=>{t.preventDefault(),t.stopPropagation();let o=t.currentTarget.querySelector("input[type='checkbox']");o.checked=!o.checked,t.currentTarget.classList.toggle("Comfly_style-model-tag--selected",o.checked),s(e,o.checked)}},[$el("span",{textContent:e.name}),$el("input",{type:"checkbox",checked:t,style:{accentColor:"var(--comfy-menu-bg)"}})])}app.registerExtension({name:"Comfly_mjstyle",async beforeRegisterNodeDef(e,t,s){if(["Comfly_mjstyle"].indexOf(t.name)>=0){const t=e.prototype.onNodeCreated;e.prototype.onNodeCreated=function(){const e=t?.apply(this,arguments);this.properties.values=this.properties.values||[],this.properties.currentStyleType="";const s=this.widgets.find((e=>"styles_type"===e.name)),o=$el("div",{style:{display:"none"}},[$el("div",{textContent:"Selected Styles:",style:{marginBottom:"5px",fontWeight:"bold",fontSize:"18px"}}),$el("div.Comfly_selected-tags-list",{style:{marginBottom:"10px",padding:"5px",border:"1px solid var(--border-color)",borderRadius:"5px",maxHeight:"100px",overflowY:"auto"}})]),l=$el("div.Comfly_style-model-tags-list",{style:{height:"200px",overflowY:"auto",backgroundColor:"var(--comfy-menu-bg)",color:"var(--fg-color)",border:"1px solid var(--border-color)",borderRadius:"5px",padding:"5px",display:"none"},onwheel:e=>{e.stopPropagation()}}),i=$el("button.comfy-btn",{textContent:"Clear all",style:{marginTop:"10px",alignSelf:"flex-end",fontSize:"16px",padding:"4px 10px"},onclick:()=>{this.properties.values=[],n(),p()}}),r=$el("div.Comfly_style-preview",{style:{display:"flex",flexDirection:"column",alignItems:"stretch",position:"relative",height:"100%"}},[o,$el("div",{textContent:"Available Styles:",style:{marginTop:"10px",marginBottom:"5px",fontWeight:"bold",fontSize:"18px"}}),l,$el("div",{style:{display:"flex",justifyContent:"flex-end"}},[i])]),n=()=>{const e=o.querySelector(".Comfly_selected-tags-list");e.innerHTML="",this.properties.values.length>0?(o.style.display="block",this.properties.values.forEach((t=>{e.appendChild(createTagElement({name:t,negative_prompt:""},!0,((e,t)=>{t||(this.properties.values=this.properties.values.filter((t=>t!==e.name)),n(),p())})))}))):o.style.display="none"},p=()=>{pb_cache[this.properties.currentStyleType]&&(l.innerHTML="",pb_cache[this.properties.currentStyleType].forEach((e=>{const t=this.properties.values.includes(e.name);l.appendChild(createTagElement(e,t,((e,t)=>{t&&!this.properties.values.includes(e.name)?this.properties.values.push(e.name):t||(this.properties.values=this.properties.values.filter((t=>t!==e.name))),n()})))})))};if(s){const e=s.callback;s.callback=t=>{e&&e(t),this.properties.currentStyleType=t,t?getStyles(t).then((e=>{e&&(pb_cache[t]=e,p(),n(),l.style.display="block")})):(l.innerHTML="",l.style.display="none")}}return this.addDOMWidget("button","btn",r).getValue=()=>{const e=this.properties.values,t=e.join(",");this.properties.style_positive=e.join(", ");let s=e.map((e=>{const t=pb_cache[this.properties.currentStyleType]?.find((t=>t.name===e));return t?.negative_prompt||""})).filter((e=>e)).join(", ");return this.properties.style_negative=s,t},this.setSize([500,550]),e}}}});
