import{app}from"../../../scripts/app.js";import{api}from"../../../scripts/api.js";import{ComfyApp}from"../../../scripts/app.js";async function uploadFile(e){try{const t=await api.fetchApi("/upload/image",{method:"POST",body:e});if(200===t.status){const e=await t.json();ComfyApp.clipspace&&ComfyApp.clipspace.imgs&&void 0!==ComfyApp.clipspace.selectedIndex&&(ComfyApp.clipspace.imgs[ComfyApp.clipspace.selectedIndex]=new Image,ComfyApp.clipspace.imgs[ComfyApp.clipspace.selectedIndex].src=`view?filename=${e.name}&subfolder=${e.subfolder}&type=${e.type}`)}else alert(t.status+" - "+t.statusText)}catch(e){console.error("Error:",e)}}async function loadApiConfig(){try{const e=await fetch("http://localhost:8080/api/get_config");if(e.ok){return await e.json()}return console.error("Failed to load API config"),{}}catch(e){return console.error("Error:",e),{}}}ComfyApp.init=async function(){const e=await loadApiConfig();this.apiKey=e.api_key||"",this.apiUrl="https://ai.comfly.chat/v1/chat/completions",this.midjourney.apiUrl.turbo="https://ai.comfly.chat/mj-turbo",this.midjourney.apiUrl.fast="https://ai.comfly.chat/mj-fast",this.midjourney.apiUrl.relax="https://ai.comfly.chat/mj-relax"};export const chatButton={button:null,chatWindow:null,popupDisplayed:!1,chatHistory:[],currentChatHistory:[],customModels:[],apiKey:"",settingsPopup:null,helpInfoEnabled:!0,sidebarDisplayed:!1,selectedModel:"gpt-4o-mini",localModels:[],midjourney:{apiKey:"",apiUrl:{turbo:"https://ai.comfly.chat/mj-turbo",fast:"https://ai.comfly.chat/mj-fast",relax:"https://ai.comfly.chat/mj-relax"},mode:"fast",validateApiUrl(e){if(!["https://ai.comfly.chat/v1/chat/completions","https://ai.comfly.chat/mj-turbo","https://ai.comfly.chat/mj-fast","https://ai.comfly.chat/mj-relax"].includes(e))throw new Error(`Invalid API URL: ${e}`)},async submitImagineTask(e){this.validateApiUrl(this.apiUrl[this.mode]);const t={method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+this.apiKey},body:JSON.stringify({base64Array:[],instanceId:"",modes:[],notifyHook:"",prompt:e,remix:!0,state:""})},n=await fetch(`${this.apiUrl[this.mode]}/mj/submit/imagine`,t);return(await n.json()).result},async fetchTaskResult(e){this.validateApiUrl(this.apiUrl[this.mode]);const t={method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer "+this.apiKey}};try{const n=await fetch(`${this.apiUrl[this.mode]}/mj/task/${e}/fetch`,t);if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);return await n.json()}catch(e){throw console.error("Error fetching task result:",e),e}}},async init(){console.log("Initializing chat button"),this.loadChatHistory();const e=await loadApiConfig();this.apiKey=e.api_key||"",this.apiUrl="https://ai.comfly.chat/v1/chat/completions",this.midjourney.apiKey=e.api_key||"",this.midjourney.apiUrl.turbo="https://ai.comfly.chat/mj-turbo",this.midjourney.apiUrl.fast="https://ai.comfly.chat/mj-fast",this.midjourney.apiUrl.relax="https://ai.comfly.chat/mj-relax";const t=localStorage.getItem("apiKey");t&&(this.apiKey=t);const n=localStorage.getItem("midjourneyApiKey");n&&(this.midjourney.apiKey=n);const s=localStorage.getItem("midjourneyMode");s&&(this.midjourney.mode=s),this.helpInfoEnabled=!1!==app.ui.settings.getSettingValue("AiHelper.helpPopup");const o=localStorage.getItem("customModels");o&&(this.customModels=JSON.parse(o))},addCustomModel(e){if(!this.customModels.includes(e)&&(this.customModels.push(e),this.selectedModel=e,this.updateModelSelects(),localStorage.setItem("customModels",JSON.stringify(this.customModels)),this.settingsPopup)){const t=this.settingsPopup.querySelector("select");if(t){const n=document.createElement("option");n.value=e,n.textContent=e,n.selected=!0,t.appendChild(n)}}},updateModelSelects(){document.querySelectorAll("select").forEach((e=>{if(e.parentElement.classList.contains("model-select-container")){const t=Array.from(e.options).map((e=>e.value));this.customModels.forEach((n=>{if(!t.includes(n)){const t=document.createElement("option");t.value=n,t.textContent=n,e.appendChild(t)}}))}e.value=this.selectedModel}));const e=document.querySelector(".upload-button");e&&(e.style.display="midjourney"===this.selectedModel?"inline-block":"none")},generateUUID:()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})),generateHash(e,t){const n=crypto.createHash("md5");return n.update(e+t),n.digest("hex")},async submit(e,t,n,s={}){const o=this.generateHash(t,n);let i;if("upsample_v6_2x_subtle"===e||"upsample_v6_2x_creative"===e||"low_variation"===e||"high_variation"===e||"pan_left"===e||"pan_right"===e||"pan_up"===e||"pan_down"===e||"reroll"===e)i=`MJ::JOB::${e}::${n}::${o}`;else if(e.startsWith("Outpaint")){const[,t]=e.split("::");i=`MJ::Outpaint::${t}::${n}::${o}::SOLO`}else i="Inpaint"===e?`MJ::${e}::1::${n}::${o}::SOLO`:"CustomZoom"===e?`MJ::CustomZoom::${n}::${o}`:`MJ::JOB::${e}::${n}::${o}`;const a={method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+this.midjourney.apiKey},body:JSON.stringify({customId:i,taskId:t,...s})};try{const e=await fetch(`${this.midjourney.apiUrl[this.midjourney.mode]}/mj/submit/action`,a);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return await e.json()}catch(t){throw console.error(`Error executing action "${e}":`,t),t}},createButton(e){const t=document.createElement("button");return t.classList.add("ai-helper-btn"),t.innerHTML='\n            <svg t="1719405208459" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="13158" width="36" height="36">\n                <path d="M611.384889 615.082667L527.075556 371.313778a22.414222 22.414222 0 0 0-8.419556-11.548445 34.816 34.816 0 0 0-36.067556 0 22.414222 22.414222 0 0 0-8.419555 11.548445L390.826667 614.058667c-3.811556 11.150222-3.128889 18.887111 1.877333 23.495111a27.704889 27.704889 0 0 0 19.911111 6.940444 27.363556 27.363556 0 0 0 19.114667-5.916444 39.822222 39.822222 0 0 0 10.012444-15.473778l17.863111-46.364444h81.863111l19.285334 48.469333a38.286222 38.286222 0 0 0 9.272889 13.824c5.233778 4.209778 11.946667 6.200889 18.716444 5.461333a28.558222 28.558222 0 0 0 19.911111-7.168c5.006222-4.664889 5.859556-11.946667 2.673778-22.243555zM469.845333 531.228444l31.288889-100.295111 31.004445 100.295111z m225.848889 87.608889a26.396444 26.396444 0 0 1-6.257778 19.569778 26.965333 26.965333 0 0 1-20.366222 6.485333 25.258667 25.258667 0 0 1-19.911111-6.485333 27.363556 27.363556 0 0 1-5.916444-19.057778V380.757333c0-17.180444 8.533333-25.770667 25.770666-25.770666a29.809778 29.809778 0 0 1 19.968 5.290666 24.120889 24.120889 0 0 1 6.940445 19.740445z" fill="#fffd01" p-id="13159"></path>\n                <path d="M550.912 107.463111a364.487111 364.487111 0 0 0-363.918222 368.298667c-25.258667 26.055111-78.848 85.617778-78.848 127.488 0 46.364444 43.804444 64.284444 75.093333 65.251555l35.612445 7.964445 6.769777 175.217778a65.592889 65.592889 0 0 0 65.877334 64.853333h133.632a26.055111 26.055111 0 1 0 0-51.996445H291.498667a13.312 13.312 0 0 1-13.198223-13.255111l-8.419555-216.632889-77.368889-16.896-2.730667-0.568888h-2.958222a57.742222 57.742222 0 0 1-17.635555-4.039112c-8.476444-3.413333-8.476444-6.485333-8.476445-9.443555 0-15.075556 33.109333-60.586667 70.712889-97.507556a26.055111 26.055111 0 0 0 6.485333-26.453333 25.258667 25.258667 0 0 0 1.251556-8.021333 311.808 311.808 0 1 1 623.672889 0c0 14.506667 26.055111 26.055111 26.055111 26.055111s26.055111-11.548444 26.055111-26.055111a364.430222 364.430222 0 0 0-364.032-364.259556z" fill="#fffd01" p-id="13160"></path>\n                <path d="M821.987556 315.790222s130.048 220.216889-72.817778 431.502222c0 0-10.012444 45.112889 42.097778 32.142223 0 0 145.408-119.580444 121.742222-348.842667z" fill="#fffd01" p-id="13161"></path>\n            </svg>',t.style.backgroundSize="cover",t.style.backgroundRepeat="no-repeat",t.style.backgroundPosition="center",t.style.padding="0px",t.style.margin="5px",t.style.borderRadius="5px",t.style.backgroundColor="rgba(255, 253, 1, 0.0)",t.style.color="white",t.style.border="none",t.style.cursor="pointer",t.addEventListener("click",(()=>{this.popupDisplayed?(this.chatWindow.remove(),this.popupDisplayed=!1,this.chatWindow=null):(this.openChatPopup(app,e),this.popupDisplayed=!0)})),this.button=t,t},createNewChatButton(){const e=document.createElement("button");return e.innerHTML='\n            <svg t="1719406359722" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="20651" width="20" height="20">\n                <path d="M916.115386 467.228307 557.971519 467.228307 557.971519 109.085464c0-24.714891-20.056801-44.771693-44.770669-44.771693-24.715915 0-44.772716 20.056801-44.772716 44.771693l0 358.142843L110.285291 467.228307c-24.715915 0-44.771693 20.056801-44.771693 44.771693s20.056801 44.772716 44.771693 44.772716l358.142843 0 0 358.143866c0 24.761963 20.056801 44.770669 44.772716 44.770669 24.713868 0 44.770669-20.008706 44.770669-44.770669L557.971519 556.772716l358.143866 0c24.762987 0 44.771693-20.057825 44.771693-44.772716S940.878372 467.228307 916.115386 467.228307L916.115386 467.228307zM916.115386 467.228307" fill="#fffd01" p-id="20652"></path>\n            </svg>',e.style.backgroundSize="contain",e.style.backgroundRepeat="no-repeat",e.style.backgroundPosition="center",e.style.marginLeft="10px",e.style.marginRight="-36px",e.style.padding="0px",e.style.fontSize="21px",e.style.borderRadius="5px",e.style.backgroundColor="#ffffff00",e.style.color="#191919",e.style.border="none",e.style.cursor="pointer",e.style.position="relative",e.style.top="5px",e.addEventListener("click",(()=>{this.newChat()})),e},openChatPopup(e,t){if(this.chatWindow)return;const n=document.createElement("div");n.classList.add("ai-helper-documentation-popup"),n.style.position="absolute",n.style.width="400px",n.style.height="700px",n.style.background="#191919",n.style.border="none",n.style.borderRadius="10px",n.style.padding="10px",n.style.zIndex="1001",n.style.color="white",n.style.overflow="hidden",n.style.boxShadow="none",n.style.border="2px solid #fffd01",t.appendChild(n),this.chatWindow=n,this.selectedHistoryIndex=-1;const s=document.createElement("style");s.textContent="\n            .ai-helper-documentation-popup.minimized .content-wrapper,\n            .ai-helper-documentation-popup.minimized > div:last-child,\n            .ai-helper-documentation-popup.minimized > div:last-child + div {\n                display: none;\n            }\n            .ai-helper-documentation-popup.minimized > div:first-child {\n                justify-content: flex-end;\n            }\n        ",n.appendChild(s);const o=t.getBoundingClientRect(),i=n.getBoundingClientRect(),a=window.innerHeight-o.bottom,l=o.top;a>=i.height?n.style.top=`${o.bottom}px`:l>=i.height?n.style.bottom=window.innerHeight-o.top+"px":(n.style.top="50%",n.style.transform="translateY(-50%)");const r=document.createElement("div");r.classList.add("content-wrapper"),r.style.overflow="auto",r.style.maxHeight="calc(100% - 100px)",n.appendChild(r);const d=document.createElement("div");d.classList.add("chat-box"),d.style.height="100%",d.style.background="#191919",d.style.padding="20px 10px",d.style.boxSizing="border-box",d.style.display="flex",d.style.flexDirection="column",d.style.fontSize="14px",d.style.overflowY="auto",r.appendChild(d);const c=document.createElement("div");c.classList.add("model-select-container"),c.style.position="absolute",c.style.top="10px",c.style.left="50%",c.style.transform="translateX(-50%)",c.style.zIndex="1001",d.appendChild(c);const p=document.createElement("select");p.style.padding="8px",p.style.fontSize="14px",p.style.borderRadius="5px",p.style.backgroundColor="#fffd01",p.style.color="#191919 ",p.style.border="none",p.style.cursor="pointer",c.appendChild(p);const y=this.createNewChatButton();c.appendChild(y);["midjourney","gpt-4o-mini","gpt-4o","gpt-4-all","claude-3-5-sonnet-20240620","claude-3-opus-20240229","claude-3-haiku-20240307","moonshot-v1-128k","gemini-1.5-pro","qwen-plus","qwen-max","suno-v3.5","glm-4v","hunyuan",...this.customModels].forEach((e=>{const t=document.createElement("option");t.value=e,t.textContent=this.getModelName(e),e===this.selectedModel&&(t.selected=!0),p.appendChild(t)})),p.addEventListener("change",(e=>{this.selectedModel=e.target.value;const t=document.querySelector("button.upload-button");t&&(t.style.display="midjourney"===this.selectedModel?"inline-block":"none")}));const h=document.createElement("div");h.style.position="absolute",h.style.bottom="10px",h.style.left="10px",h.style.right="10px",h.style.background="#3d3d3f",h.style.padding="10px",h.style.boxSizing="border-box",h.style.borderRadius="10px",n.appendChild(h);const m=document.createElement("div");m.style.display="flex",m.style.alignItems="center",m.style.position="relative",h.appendChild(m);const u=document.createElement("input");u.classList.add("user-input"),u.type="text",u.placeholder="Type your message...",u.style.flexGrow="1",u.style.padding="10px",u.style.fontSize="14px",u.style.border="none",u.style.borderRadius="5px",u.addEventListener("keydown",(e=>{"Enter"===e.key&&this.sendUserMessage()})),m.appendChild(u);const g=document.createElement("button");g.classList.add("upload-button"),g.innerHTML='\n            <svg t="1719406325229" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="18644" style="width:35px;height:35px;fill:#fffd01;">\n                <path d="M619.52 901.12c-32.448 0-66.56-11.968-92.16-37.568-51.2-51.2-51.2-133.12 0-182.592l172.352-172.352c10.24-10.24 25.6-10.24 35.84 0 10.24 10.24 10.24 25.6 0 35.84L563.2 716.8c-30.72 30.72-30.72 80.192 0 110.912 30.72 30.72 80.192 30.72 110.912 0l204.8-204.8a42.752 42.752 0 0 0 13.696-30.72 42.752 42.752 0 0 0-13.696-30.72 43.264 43.264 0 0 0-61.44 0l-204.8 204.8c-3.392 3.456-3.392 8.576 0 13.696 3.456 3.392 8.576 3.392 13.696 0l172.352-172.416c10.24-10.24 25.6-10.24 35.84 0 10.24 10.24 10.24 25.6 0 35.84l-172.352 170.688c-22.208 22.208-63.168 22.208-85.376 0a59.776 59.776 0 0 1 0-85.312l204.8-204.8a94.72 94.72 0 0 1 134.848 0c18.752 17.024 27.328 40.96 27.328 66.56s-10.24 49.472-27.328 66.56l-204.8 204.8a125.44 125.44 0 0 1-92.16 39.232z" p-id="18645"></path>\n                <path d="M525.632 989.888h-358.4c-47.744 0-85.312-40.96-85.312-92.16V126.272c0-51.2 37.568-92.16 85.312-92.16h617.856c47.744 0 85.312 40.96 85.312 92.16v285.056a26.24 26.24 0 0 1-25.6 25.6 26.24 26.24 0 0 1-25.6-25.6V126.272c0-22.144-15.36-40.96-34.112-40.96H167.232c-18.752 0-34.112 18.816-34.112 40.96V896c0 22.208 15.36 40.96 34.112 40.96H527.36c13.632 0 25.6 11.968 25.6 25.6a28.096 28.096 0 0 1-27.328 27.328z" p-id="18646"></path>\n                <path d="M605.888 310.592h-363.52a26.24 26.24 0 0 1-25.6-25.6c0-13.632 11.904-25.6 25.6-25.6h363.52c13.632 0 25.6 11.968 25.6 25.6 0 13.696-10.24 25.6-25.6 25.6z m-148.48 203.136h-215.04a26.24 26.24 0 0 1-25.6-25.6c0-13.696 11.904-25.6 25.6-25.6H455.68c13.632 0 25.6 11.904 25.6 25.6 0 13.632-10.24 25.6-23.872 25.6z" p-id="18647"></path>\n            </svg>',g.style.backgroundSize="contain",g.style.backgroundRepeat="no-repeat",g.style.backgroundPosition="center",g.style.marginRight="4px",g.style.padding="0px",g.style.borderRadius="5px",g.style.backgroundColor="#fffd0100",g.style.color="#191919",g.style.border="none",g.style.cursor="pointer",g.style.position="relative",g.addEventListener("click",(()=>{const e=document.createElement("input");e.type="file",e.accept="image/*",e.addEventListener("change",(e=>{const t=e.target.files[0];if(t){const e=new FileReader;e.onload=e=>{const t=document.createElement("div");t.style.position="absolute",t.style.top="-40px",t.style.left="50%",t.style.transform="translateX(-50%)",t.style.width="40px",t.style.height="40px",t.style.borderRadius="8px",t.style.overflow="hidden",t.style.boxShadow="0 2px 4px rgba(0,0,0,0.2)";const n=document.createElement("img");n.src=e.target.result,n.style.width="100%",n.style.height="100%",n.style.objectFit="cover",t.appendChild(n);const s=document.createElement("button");s.innerHTML="&#x2715;",s.style.position="absolute",s.style.top="0",s.style.right="0",s.style.backgroundColor="rgba(0,0,0,0.5)",s.style.color="white",s.style.border="none",s.style.borderRadius="0 0 0 4px",s.style.padding="2px 4px",s.style.fontSize="10px",s.style.cursor="pointer",s.addEventListener("click",(e=>{e.stopPropagation(),t.remove(),delete this.attachment})),t.appendChild(s),g.appendChild(t),this.attachment=e.target.result},e.readAsDataURL(t)}})),e.click()})),m.insertBefore(g,u);const f=document.createElement("button");f.textContent="Send",f.style.marginLeft="10px",f.style.padding="10px",f.style.fontSize="14px",f.style.borderRadius="5px",f.style.backgroundColor="#fffd01",f.style.color="#191919",f.style.border="none",f.style.cursor="pointer",f.addEventListener("click",(()=>{this.sendUserMessage()})),m.appendChild(f);const x=document.createElement("div");x.style.display="flex",x.style.alignItems="center",x.style.justifyContent="space-between",x.style.marginBottom="10px",x.style.cursor="move",n.insertBefore(x,r);const b=document.createElement("div");b.style.display="flex",b.style.alignItems="center",x.appendChild(b);const v=document.createElement("button");v.innerHTML='\n            <svg t="1719405777872" class="icon" viewBox="0 0 1126 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="655" width="35" height="35">\n                <path d="M742.4 0h-358.4C199.68 0 51.2 148.48 51.2 332.8v358.4C51.2 875.52 199.68 1024 384 1024h358.4C926.72 1024 1075.2 875.52 1075.2 691.2v-358.4C1075.2 148.48 926.72 0 742.4 0z m126.293333 826.026667H257.706667c-15.36 0-27.306667-11.946667-27.306667-27.306667 0-15.36 11.946667-27.306667 27.306667-27.306667h610.986666c15.36 0 27.306667 11.946667 27.306667 27.306667 0 15.36-11.946667 27.306667-27.306667 27.306667z m0-259.413334H257.706667c-15.36 0-27.306667-11.946667-27.306667-27.306666 0-15.36 11.946667-27.306667 27.306667-27.306667h610.986666c15.36 0 27.306667 11.946667 27.306667 27.306667 0 15.36-11.946667 27.306667-27.306667 27.306666z m0-276.48H257.706667c-15.36 0-27.306667-11.946667-27.306667-27.306666 0-15.36 11.946667-27.306667 27.306667-27.306667h610.986666c15.36 0 27.306667 11.946667 27.306667 27.306667 0 13.653333-11.946667 27.306667-27.306667 27.306666z" fill="#fffd01" p-id="656"></path>\n            </svg>',v.style.backgroundSize="contain",v.style.backgroundRepeat="no-repeat",v.style.backgroundPosition="center",v.style.marginRight="6px",v.style.padding="0px",v.style.fontSize="14px",v.style.borderRadius="5px",v.style.backgroundColor="#fffd0100",v.style.color="#191919 ",v.style.border="none",v.style.cursor="pointer",v.addEventListener("click",(()=>{this.sidebarDisplayed?this.closeSidebar():this.openSidebar()})),b.appendChild(v);const w=document.createElement("button");w.innerHTML='\n        <svg t="1719406230787" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="12197" width="36" height="36">\n            <path d="M538.24 196.906667a26.24 26.24 0 1 0-52.48 0v396.501333a131.328 131.328 0 1 0 52.48 0V380.714667h78.805333a26.24 26.24 0 0 0 0-52.48h-78.805333V275.669333h78.805333a26.24 26.24 0 0 0 0-52.522666h-78.805333v-26.282667z m-105.002667 525.141333a78.762667 78.762667 0 1 1 157.525334 0 78.762667 78.762667 0 0 1-157.525334 0z" fill="#fffd01" p-id="12198"></path>\n        </svg>',w.style.backgroundSize="contain",w.style.backgroundRepeat="no-repeat",w.style.marginTop="0px",w.style.marginRight="0px",w.style.marginLeft="2px",w.style.padding="0px",w.style.borderRadius="5px",w.style.backgroundColor="transparent",w.style.cursor="pointer",w.style.outline="none",w.style.boxShadow="none",w.style.border="none",w.addEventListener("click",(()=>{this.settingsPopup?(this.settingsPopup.remove(),this.settingsPopup=null):this.openSettingsPopup()})),b.appendChild(w);const C=document.createElement("button");C.innerHTML='\n        <svg t="1719406277858" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="14182" width="32" height="32">\n            <path d="M445.4 771c18.8 0 34.1-15.2 34.1-34.1l-34.1-340.4c0-18.8-15.2-34.1-34.1-34.1s-34.1 15.2-34.1 34.1l34.1 340.4c0.1 18.8 15.3 34.1 34.1 34.1z m408.5-578.8H615.7v-17c0-37.6-30.5-68.1-68.1-68.1h-68.1c-37.6 0-68.1 30.5-68.1 68.1v17H173.1c-18.8 0-34.1 15.2-34.1 34.1 0 18.8 15.2 34.1 34.1 34.1H854c18.8 0 34.1-15.2 34.1-34.1s-15.3-34.1-34.2-34.1z m-306.3 0h-68.1v-17h68.1v17z m241.8 102.7c-19.8 0-36 15.6-36.9 35.2l-75.5 509H350.3l-75.8-510.6h-0.4c-1.8-18.8-17.6-33.6-36.7-33.6-19.3 0-35.1 14.7-36.7 33.6h-1.3l69.8 530.7c0.3-2.8 0.1-5.9-0.5-9.3 5.1 32.5 33.3 57.3 67.2 57.3h356.2c34.1 0 62.3-25 67.2-57.5-0.4 2.2-0.5 4.2-0.5 6.3L828 328.4h-1.8c-1.9-18.8-17.6-33.5-36.8-33.5z m-173.7 442l34.1-340.4c0-18.8-15.2-34.1-34.1-34.1s-34.1 15.2-34.1 34.1l-34.1 340.4c0 18.8 15.2 34.1 34.1 34.1 18.8 0 34.1-15.3 34.1-34.1z" fill="#fffd01" p-id="14183"></path>\n        </svg>',C.style.backgroundSize="contain",C.style.backgroundRepeat="no-repeat",C.style.backgroundPosition="center",C.style.padding="0x",C.style.borderRadius="5px",C.style.backgroundColor="transparent",C.style.color="white",C.style.border="none",C.style.cursor="pointer",C.addEventListener("click",(()=>{if(confirm("Are you sure you want to clear the current chat history?")){this.selectedHistoryIndex>=0&&(this.chatHistory.splice(this.selectedHistoryIndex,1),localStorage.setItem("chatHistory",JSON.stringify(this.chatHistory)),this.selectedHistoryIndex=-1),this.currentChatHistory=[];document.querySelector(".chat-box").querySelectorAll(".message").forEach((e=>e.remove())),this.sidebarDisplayed&&(this.sidebar.remove(),this.openSidebar())}})),b.appendChild(C);const E=document.createElement("div");E.style.display="flex",E.style.alignItems="center",x.appendChild(E);const S=document.createElement("button");S.innerHTML='\n        <svg t="1719406595475" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="49548" width="20" height="20" style="fill:#fffd01;">\n            <path d="M240.512 180.181333l271.530667 271.488 271.530666-271.488a42.666667 42.666667 0 0 1 56.32-3.541333l4.010667 3.541333a42.666667 42.666667 0 0 1 0 60.330667l-271.530667 271.530667 271.530667 271.530666a42.666667 42.666667 0 0 1-56.32 63.872l-4.010667-3.541333-271.530666-271.530667-271.530667 271.530667-4.010667 3.541333a42.666667 42.666667 0 0 1-56.32-63.872l271.488-271.530666-271.488-271.530667a42.666667 42.666667 0 0 1 60.330667-60.330667z" fill="#fffd01" p-id="49549"></path>\n        </svg>',S.style.marginLeft="10px",S.style.background="none",S.style.border="none",S.style.color="white",S.style.fontSize="15px",S.style.cursor="pointer",S.addEventListener("click",(()=>{-1===this.selectedHistoryIndex&&this.currentChatHistory.length>0&&(this.chatHistory.push([...this.currentChatHistory]),localStorage.setItem("chatHistory",JSON.stringify(this.chatHistory))),this.currentChatHistory=[],n.remove(),this.popupDisplayed=!1,this.chatWindow=null,this.sidebarDisplayed&&(this.sidebar.remove(),this.openSidebar())})),E.appendChild(S);const k=localStorage.getItem("apiKey");k&&(this.apiKey=k);let M,H,L=!1;x.addEventListener("mousedown",(function(e){L=!0,M=e.clientX-n.offsetLeft,H=e.clientY-n.offsetTop})),document.addEventListener("mousemove",(function(e){L&&(n.style.left=e.clientX-M+"px",n.style.top=e.clientY-H+"px")})),document.addEventListener("mouseup",(function(){L=!1}));const I=document.createElement("div");I.style.width="0",I.style.height="0",I.style.position="absolute",I.style.bottom="0",I.style.right="0",I.style.cursor="se-resize",I.style.borderTop="10px solid transparent",I.style.borderLeft="10px solid transparent",I.style.borderBottom="10px solid #fffd01",I.style.borderRight="10px solid #fffd01",n.appendChild(I);let j,z,$,R,T=!1;I.addEventListener("mousedown",(function(e){e.preventDefault(),e.stopPropagation(),T=!0,j=e.clientX,z=e.clientY,$=parseInt(document.defaultView.getComputedStyle(n).width,10),R=parseInt(document.defaultView.getComputedStyle(n).height,10)})),document.addEventListener("mousemove",(function(e){if(!T)return;const t=$+(e.clientX-j),s=R+(e.clientY-z);n.style.width=`${t}px`,n.style.height=`${s}px`})),document.addEventListener("mouseup",(function(){T=!1}))},displayImageThumbnail(e){this.thumbnailContainer.innerHTML="",this.thumbnailContainer.style.position="relative",this.thumbnailContainer.style.display="block";const t=document.createElement("img");t.src=e,t.dataset.imageUrl=e,t.style.width="40px",t.style.height="40px",t.style.objectFit="cover",t.style.borderRadius="5px",this.thumbnailContainer.appendChild(t);const n=document.createElement("button");n.textContent="x",n.style.position="absolute",n.style.top="-10px",n.style.right="-10px",n.style.backgroundColor="#fffd01",n.style.color="#191919",n.style.border="none",n.style.borderRadius="50%",n.style.width="20px",n.style.height="20px",n.style.fontSize="12px",n.style.cursor="pointer",n.addEventListener("click",(()=>{this.thumbnailContainer.style.display="none",delete this.uploadedImage})),this.thumbnailContainer.parentElement.appendChild(n)},getBase64:async e=>new Promise(((t,n)=>{const s=new FileReader;s.readAsDataURL(e),s.onload=()=>{const e=s.result.split(",")[1];t(e)},s.onerror=e=>n(e)})),async sendMessageToAI(e){console.log("Sending to AI:",e);const t=`AI received: ${e}`;console.log("AI response:",t),this.displayMessage(t,!1,this.getModelName(this.selectedModel));const n={content:e,isUser:!0,timestamp:(new Date).toLocaleString()},s={content:t,isUser:!1,aiName:this.getModelName(this.selectedModel),timestamp:(new Date).toLocaleString(),modelName:this.selectedModel};this.selectedHistoryIndex>=0?this.chatHistory[this.selectedHistoryIndex].push(n,s):(this.currentChatHistory.push(n,s),this.chatHistory.push(this.currentChatHistory)),localStorage.setItem("chatHistory",JSON.stringify(this.chatHistory)),this.sidebarDisplayed&&(this.sidebar.remove(),this.openSidebar())},newChat(){this.selectedHistoryIndex>=0?(this.currentChatHistory=[],this.selectedHistoryIndex=-1):(this.currentChatHistory.length>0&&(this.chatHistory.push([...this.currentChatHistory]),localStorage.setItem("chatHistory",JSON.stringify(this.chatHistory))),this.currentChatHistory=[]);const e=document.querySelector(".chat-box");e.innerHTML="";const t=e.querySelector(".model-select-container");if(t)t.style.display="block";else{const t=document.createElement("div");t.classList.add("model-select-container"),t.style.position="absolute",t.style.top="10px",t.style.left="50%",t.style.transform="translateX(-50%)",t.style.zIndex="1001",e.appendChild(t);const n=document.createElement("select");n.style.padding="8px",n.style.fontSize="14px",n.style.borderRadius="5px",n.style.backgroundColor="#fffd01",n.style.color="#191919 ",n.style.border="none",n.style.cursor="pointer",t.appendChild(n);["midjourney","gpt-4o-mini","gpt-4o","gpt-4-all","claude-3-5-sonnet-20240620","claude-3-opus-20240229","claude-3-haiku-20240307","moonshot-v1-128k","gemini-1.5-pro","qwen-plus","qwen-max","suno-v3.5","glm-4v","hunyuan",...this.customModels].forEach((e=>{const t=document.createElement("option");t.value=e,t.textContent=this.getModelName(e),e===this.selectedModel&&(t.selected=!0),n.appendChild(t)})),n.addEventListener("change",(e=>{this.selectedModel=e.target.value;const t=document.querySelector(".upload-button");t&&(t.style.display="midjourney"===this.selectedModel?"inline-block":"none")}));const s=this.createNewChatButton();t.appendChild(s)}},openSettingsPopup(){if(this.settingsPopup)return;const e=document.createElement("div");e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.background="rgba(255, 255, 255, 0.1)",e.style.backdropFilter="blur(10px)",e.style.zIndex="1002",this.chatWindow.appendChild(e);const t=document.createElement("div");t.style.position="absolute",t.style.top="50%",t.style.left="50%",t.style.transform="translate(-50%, -50%)",t.style.padding="20px",t.style.borderRadius="10px",t.style.zIndex="1003",t.style.width="80%",t.style.background="#19191900",e.appendChild(t);const n=document.createElement("style");n.textContent="\n        .main {\n            display: flex;\n            justify-content: center;\n            align-items: center;\n        }\n        .card {\n            width: 600px;\n            position: relative;\n            background-color: #fffd01;\n            border: 1px solid rgba(255, 255, 255, 0.05);\n            border-radius: 0.5rem;\n            padding: 1rem;\n        }\n        .card::after {\n            content: \"\";\n            height: 70px;\n            width: 1px;\n            position: absolute;\n            left: -1px;\n            top: 65%;\n            transition: top 600ms ease, opacity 600ms ease;\n            background: linear-gradient(transparent, mediumslateblue, transparent);\n            box-shadow: 0 0 30px mediumslateblue;\n            opacity: 0;\n        }\n        .card:hover::after {\n            top: 25%;\n            opacity: 1;\n        }\n        .card-content {\n            display: flex;\n            flex-direction: column;\n            justify-content: center;\n            height: 190px;\n            align-items: center;\n            background-image: radial-gradient(#1a1a1a36 1px, transparent 1px);\n            background-position: 50% 50%;\n            background-size: 1.1rem 1.1rem;\n            padding: 2.3rem;\n            border-radius: 0.5rem;\n            overflow: hidden;\n        }\n        .card-content .h1, .h3, .p {\n            text-align: center;\n        }\n        .card-content .h1 {\n            color: #191919;\n            font-size: 2.6rem;\n        }\n        .card-content .h3 {\n            color: #191919;\n            text-transform: uppercase;\n            font-size: 1.5rem;\n        }\n        .card-content .h3 span {\n            font-weight: 800;\n            background: linear-gradient(125deg, #b663ff, #13c1ef);\n            text-transform: uppercase;\n            -webkit-background-clip: text;\n            -webkit-text-fill-color: transparent;\n        }\n        .card-content .h3::after {\n            content: '';\n            margin-top: -5px;\n            height: 3px;\n            width: 25%;\n            background: linear-gradient(125deg, #b663ff, #13c1ef);\n            display: block;\n        }\n        .card-content .p {\n            color: #191919;\n            line-height: 1.3rem;\n        }\n        @media(max-width: 600px) {\n            .card {\n                width: calc(100% - 2rem);\n                margin: 0 0rem;\n                padding: 0.75rem;\n                border-radius: 0.5rem;\n            }\n        }\n        @media(max-width: 600px) {\n            .card-content {\n                padding: 1rem;\n            }\n            .card-content .h1 {\n                font-size: 2.2rem;\n            }\n        }\n    ",document.head.appendChild(n);const s=document.createElement("div");s.className="main";const o=document.createElement("div");o.className="card";const i=document.createElement("div");i.className="card-content";const a=document.createElement("div");a.className="h3",a.innerHTML="<span>Comfly</span>ui";const l=document.createElement("div");l.className="h1",l.textContent="One of All.";const r=document.createElement("p");r.className="p",r.textContent="midjourneyï¼Œgpt-4oï¼Œclaude-sonnet 3.5ï¼Œgemini 1.5proï¼Œqwen-max,suno-v3.5 ðŸ˜‚ðŸš€ðŸ˜Š",i.appendChild(a),i.appendChild(l),i.appendChild(r);const d=document.createElement("div");d.style.position="relative",d.style.width="200px",d.style.height="10px",d.style.margin="3px auto",d.style.marginTop="25px",d.style.marginLeft="23px",d.style.display="flex",d.style.justifyContent="center",d.style.alignItems="center",["https://api.comfly.chat/wp-content/uploads/2024/07/2024051701495031.png","https://api.comfly.chat/wp-content/uploads/2024/07/ede7249fd4c26ed054473a3ae405038f-e1721394651139.jpeg","https://api.comfly.chat/wp-content/uploads/2024/07/2024051400141556.webp","https://comfly.chat/uploads/default/original/1X/8aa03ed2d17ede9f79d825c0a1d2d4c9c367497a.png","https://api.comfly.chat/wp-content/uploads/2024/07/2024062013373488.png","https://api.comfly.chat/wp-content/uploads/2024/07/2024062013373533.png","https://api.comfly.chat/wp-content/uploads/2024/07/2024062013373534.png","https://api.comfly.chat/wp-content/uploads/2024/07/2024062013373562.png","https://api.comfly.chat/wp-content/uploads/2024/07/2024062013373651.png","https://api.comfly.chat/wp-content/uploads/2024/07/2024051710414540.png"].forEach(((e,t)=>{const n=document.createElement("img");n.src=e,n.style.position="relative",n.style.width="40px",n.style.height="40px",n.style.borderRadius="50%",n.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.2)",n.style.transition="transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out",n.style.zIndex="1",n.style.marginLeft="-17px",n.addEventListener("mouseenter",(()=>{n.style.transform="scale(1.2)",n.style.boxShadow="0 0 20px 5px #fffd01",n.style.zIndex="2"})),n.addEventListener("mouseleave",(()=>{n.style.transform="scale(1)",n.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.2)",n.style.zIndex="1"})),d.appendChild(n)})),i.appendChild(d),o.appendChild(i),s.appendChild(o),t.appendChild(s);const c=document.createElement("h2");c.textContent="Settings",c.style.marginBottom="10px",c.style.color="white",t.appendChild(c);const p=document.createElement("select");p.style.width="100%",p.style.padding="10px",p.style.marginBottom="10px",p.style.borderRadius="5px",p.style.boxSizing="border-box",p.style.fontSize="14px",p.innerHTML='\n        <option value="midjourney">Midjourney</option>\n        <option value="gpt-4o-mini">gpt-4o-mini</option>\n        <option value="gpt-4o">GPT-4o</option>\n        <option value="gpt-4-all">GPT-4-all</option>\n        <option value="claude-3-opus-20240229">Claude3-opus</option>\n        <option value="claude-3-5-sonnet-20240620">Claude3.5-Sonnet</option>\n        <option value="claude-3-haiku-20240307">Claude3-haiku</option>\n        <option value="moonshot-v1-128k">moonshot-v1</option>\n        <option value="suno-v3.5">suno-v3.5</option>\n        <option value="gemini-1.5-pro">gemini-1.5-pro</option>\n        <option value="qwen-plus">qwen-plus</option>\n        <option value="qwen-max">qwen-max</option>\n        <option value="glm-4v">glm-4v</option>\n        <option value="hunyuan">hunyuan</option>\n    ',this.customModels.forEach((e=>{const t=document.createElement("option");t.value=e,t.textContent=e,p.appendChild(t)})),p.value=this.selectedModel,p.addEventListener("change",(e=>{this.selectedModel=e.target.value;const t=document.querySelector(".upload-button");t&&(t.style.display="midjourney"===this.selectedModel?"inline-block":"none")})),t.appendChild(p);const y=document.createElement("div");y.style.marginTop="10px",t.appendChild(y);const h=document.createElement("input");h.type="text",h.placeholder="Enter custom model...",h.style.width="60%",h.style.padding="5px",h.style.fontSize="14px",h.style.borderRadius="5px",h.style.border="1px solid #ccc",y.appendChild(h);const m=document.createElement("button");m.textContent="Add",m.style.marginLeft="10px",m.style.padding="5px 10px",m.style.fontSize="14px",m.style.borderRadius="5px",m.style.backgroundColor="#fffd01",m.style.color="#191919",m.style.border="none",m.style.cursor="pointer",m.addEventListener("click",(()=>{const e=h.value.trim();if(e){this.addCustomModel(e),h.value="";const n=t.querySelector("select");n&&(n.value=e)}})),y.appendChild(m);const u=document.createElement("button");u.textContent="Ref",u.style.marginLeft="10px",u.style.padding="5px 10px",u.style.fontSize="14px",u.style.borderRadius="5px",u.style.backgroundColor="#fffd01",u.style.color="#191919",u.style.border="none",u.style.cursor="pointer",u.addEventListener("click",(()=>{window.open("https://ai.comfly.chat/models","_blank")})),y.appendChild(u);const g=document.createElement("div");g.style.marginTop="10px",t.appendChild(g);const f=document.createElement("h3");f.textContent="Midjourney Settings",f.style.marginBottom="5px",g.appendChild(f);const x=document.createElement("select");x.style.width="100%",x.style.padding="10px",x.style.marginBottom="10px",x.style.borderRadius="5px",x.style.boxSizing="border-box",x.style.fontSize="14px",x.innerHTML='\n        <option value="fast">Fast Mode</option>\n        <option value="relax">Relax Mode</option>\n    ',x.value=this.midjourney.mode,x.addEventListener("change",(e=>{this.midjourney.mode=e.target.value})),g.appendChild(x);const b=document.createElement("button");b.textContent="Save",b.style.padding="10px 20px",b.style.fontSize="16px",b.style.backgroundColor="#fffd01",b.style.color="#191919 ",b.style.border="none",b.style.borderRadius="5px",b.style.cursor="pointer",b.addEventListener("click",(()=>{this.midjourney.mode=x.value,localStorage.setItem("midjourneyMode",this.midjourney.mode),this.settingsPopup.remove(),this.settingsPopup=null,e.remove()})),t.appendChild(b);const v=document.createElement("button");v.textContent="Cancel",v.style.padding="10px 20px",v.style.fontSize="16px",v.style.backgroundColor="#ccc",v.style.color="black",v.style.border="none",v.style.borderRadius="5px",v.style.marginLeft="10px",v.style.cursor="pointer",v.addEventListener("click",(()=>{this.settingsPopup.remove(),this.settingsPopup=null,e.remove()})),t.appendChild(v),this.settingsPopup=t},openSidebar(){Array.isArray(this.chatHistory)||(this.chatHistory=[]);const e=document.createElement("div");e.style.position="absolute",e.style.left="0",e.style.top="0",e.style.width="300px",e.style.height="100%",e.style.background="#3d3d3f",e.style.transition="left 0.3s",e.style.zIndex="1002",e.style.padding="20px",e.style.boxSizing="border-box",this.chatWindow.appendChild(e);const t=document.createElement("div");t.style.position="absolute",t.style.bottom="20px",t.style.left="20px",t.style.display="flex",t.style.alignItems="center",e.appendChild(t);const n=document.createElement("div");n.style.display="flex",n.style.alignItems="center",t.appendChild(n);const s=document.createElement("label");s.textContent="Help Info",s.style.color="white",s.style.marginRight="10px",n.appendChild(s);const o=document.createElement("label");o.classList.add("help-info-toggle"),o.innerHTML=`\n        <input type="checkbox" ${this.helpInfoEnabled?"checked":""}>\n        <span class="slider"></span>\n    `,o.addEventListener("change",(e=>{this.helpInfoEnabled=e.target.checked,app.ui.settings.setSettingValue("AiHelper.helpPopup",this.helpInfoEnabled)})),n.appendChild(o);const i=document.createElement("h2");i.textContent="Chat History",i.style.color="#ffffff ",i.style.marginBottom="20px",e.appendChild(i);const a=document.createElement("ul");if(a.style.listStyle="none",a.style.padding="0",a.style.margin="0",a.style.maxHeight="calc(100% - 60px)",a.style.overflowY="auto",e.appendChild(a),a.innerHTML="",0===this.chatHistory.length){const e=document.createElement("li");e.textContent="No messages",e.style.color="#fff",e.style.textAlign="center",e.style.padding="10px",a.appendChild(e)}else{const e=Math.min(this.chatHistory.length,6);for(let t=this.chatHistory.length-e;t<this.chatHistory.length;t++){const e=this.chatHistory[t];if(e.length>0){const n=document.createElement("li");n.style.position="relative",n.style.marginBottom="10px",n.style.padding="10px",n.style.paddingBottom="25px",n.style.borderRadius="5px",n.style.backgroundColor="#191919",n.style.color="#fff",n.style.cursor="pointer";const s=e[e.length-1],o=document.createElement("div");if(s.content.includes("<img")){const e=document.createElement("img");e.src=s.content.match(/<img.*?src="(.*?)".*?>/)[1],e.style.maxWidth="100%",e.style.cursor="pointer",e.style.width="50px",e.style.height="50px",e.style.objectFit="cover",e.style.borderRadius="5px",o.appendChild(e)}else o.textContent=`${s.isUser?"User":s.aiName}: ${s.content.slice(0,40)}`,o.style.overflow="hidden",o.style.textOverflow="ellipsis",o.style.display="-webkit-box",o.style.webkitLineClamp="2",o.style.webkitBoxOrient="vertical";n.appendChild(o);const i=document.createElement("div");i.textContent=s.timestamp,i.style.position="absolute",i.style.bottom="5px",i.style.left="10px",i.style.fontSize="12px",i.style.color="#888",n.appendChild(i),n.addEventListener("click",(()=>{this.displayChatSession(e,t)}));const l=document.createElement("div");l.style.position="absolute",l.style.top="0",l.style.right="10px",l.style.height="100%",l.style.display="flex",l.style.flexDirection="column",l.style.justifyContent="center",l.style.alignItems="center";const r=document.createElement("button");r.textContent="Delete",r.style.marginBottom="5px",r.style.padding="5px",r.style.fontSize="12px",r.style.backgroundColor="#fffd01",r.style.color="#191919 ",r.style.border="none",r.style.borderRadius="3px",r.style.cursor="pointer",r.addEventListener("click",(e=>{e.stopPropagation(),this.deleteHistoryItem(t)})),l.appendChild(r);const d=document.createElement("button");d.textContent="Export",d.style.padding="5px",d.style.fontSize="12px",d.style.backgroundColor="#fffd01",d.style.color="#191919 ",d.style.border="none",d.style.borderRadius="3px",d.style.cursor="pointer",d.addEventListener("click",(t=>{t.stopPropagation(),this.exportChatSession(e)})),l.appendChild(d),n.appendChild(l),a.appendChild(n)}}}this.sidebar=e,this.sidebarDisplayed=!0,e.addEventListener("click",(t=>{t.target===e&&this.closeSidebar()}));const l=document.createElement("style");l.textContent='\n        .help-info-toggle {\n            position: relative;\n            display: inline-block;\n            width: 40px;\n            height: 20px;\n        }\n\n        .help-info-toggle input {\n            opacity: 0;\n            width: 0;\n            height: 0;\n        }\n\n        .slider {\n            position: absolute;\n            cursor: pointer;\n            top: 0;\n            left: 0;\n            right: 0;\n            bottom: 0;\n            background-color: #ccc;\n            transition: .4s;\n            border-radius: 20px;\n        }\n\n        .slider:before {\n            position: absolute;\n            content: "";\n            height: 16px;\n            width: 16px;\n            left: 2px;\n            bottom: 2px;\n            background-color: #3d3d3f;\n            transition: .4s;\n            border-radius: 50%;\n        }\n\n        input:checked + .slider {\n            background-color: #fffd01;\n        }\n\n        input:checked + .slider:before {\n            transform: translateX(20px);\n        }\n    ',e.appendChild(l)},closeSidebar(){this.sidebar&&(this.sidebar.style.left="-300px",setTimeout((()=>{this.sidebar.remove(),this.sidebar=null,this.sidebarDisplayed=!1}),300))},displayChatSession(e,t){const n=document.querySelector(".chat-box");n.innerHTML="",e.forEach((e=>{this.displayMessage(e.content,e.isUser,e.aiName,e.timestamp,!0,e.modelName)})),setTimeout((()=>{n.scrollTop=n.scrollHeight}),0),this.closeSidebar(),this.selectedHistoryIndex=t,this.currentChatHistory=e;const s=n.querySelector(".model-select-container");if(s)s.style.display="block";else{const e=document.createElement("div");e.classList.add("model-select-container"),e.style.position="absolute",e.style.top="10px",e.style.left="50%",e.style.transform="translateX(-50%)",e.style.zIndex="1001",n.appendChild(e);const t=document.createElement("select");t.style.padding="8px",t.style.fontSize="14px",t.style.borderRadius="5px",t.style.backgroundColor="#fffd01",t.style.color="#191919 ",t.style.border="none",t.style.cursor="pointer",e.appendChild(t);["midjourney","gpt-4o-mini","gpt-4o","gpt-4-all","claude-3-5-sonnet-20240620","claude-3-opus-20240229","claude-3-haiku-20240307","moonshot-v1-128k","gemini-1.5-pro","qwen-plus","qwen-max","suno-v3.5","glm-4v","hunyuan",...this.customModels].forEach((e=>{const n=document.createElement("option");n.value=e,n.textContent=this.getModelName(e),e===this.selectedModel&&(n.selected=!0),t.appendChild(n)})),t.addEventListener("change",(e=>{this.selectedModel=e.target.value;const t=document.querySelector(".upload-button");t&&(t.style.display="midjourney"===this.selectedModel?"inline-block":"none")}));const s=this.createNewChatButton();e.appendChild(s)}},deleteHistoryItem(e){this.chatHistory.splice(e,1),localStorage.setItem("chatHistory",JSON.stringify(this.chatHistory)),this.sidebar.remove(),this.openSidebar()},exportChatSession(e){const t=e.map((e=>`${e.isUser?"User":e.aiName}: ${e.content}\nTimestamp: ${e.timestamp}\n\n`)).join(""),n=new Blob([t],{type:"text/plain;charset=utf-8"}),s=document.createElement("a");s.href=URL.createObjectURL(n),s.download="chat_session.txt",s.style.display="none",document.body.appendChild(s),s.click(),document.body.removeChild(s)},exportHistoryItem(e){const t=`AI: ${e.aiName}\nUser: ${e.content}\nTimestamp: ${e.timestamp}\n\n`,n=new Blob([t],{type:"text/plain;charset=utf-8"}),s=document.createElement("a");s.href=URL.createObjectURL(n),s.download="chat_history_item.txt",s.style.display="none",document.body.appendChild(s),s.click(),document.body.removeChild(s)},async sendMessageToAI(e,t=null){if("midjourney"===this.selectedModel){if(!this.midjourney.apiKey)return void this.displayMessage("Please enter your Midjourney API key in the settings.",!1,"System");try{const n=t?`<img src="${t}" alt="User uploaded image"> ${e}`:e,s=await this.midjourney.submitImagineTask(n),o=document.querySelector(".chat-box"),i=document.createElement("div");i.classList.add("message"),i.style.alignSelf="flex-start",i.style.backgroundColor="#3d3d3f",i.style.color="white",i.style.marginBottom="20px",i.style.maxWidth="80%",i.style.padding="10px",i.style.borderRadius="10px",i.style.fontSize="14px",i.style.position="relative";const a=document.createElement("div");a.style.wordWrap="break-word",a.style.overflowWrap="break-word";const l=document.createElement("img");let r;l.style.maxWidth="100%",a.appendChild(l),i.appendChild(a),o.appendChild(i);const d=document.createElement("div"),c=document.createElement("div");c.style.marginTop="5px",c.style.fontSize="12px",c.style.color="#ffffff",d.appendChild(c),i.appendChild(d);do{await new Promise((e=>setTimeout(e,1e3))),r=await this.midjourney.fetchTaskResult(s);const e=r.progress||0;c.textContent=`[Generating... ${e}]`,c.style.fontSize="14px"}while("SUCCESS"!==r.status);i.removeChild(d),l.src=r.imageUrl,l.style.cursor="pointer",l.addEventListener("click",(()=>{this.openImagePopup(r.imageUrl)}));const p=document.createElement("img");p.src=this.getAvatarByModel("midjourney"),p.style.width="30px",p.style.height="30px",p.style.borderRadius="50%",p.style.marginRight="10px",i.insertBefore(p,a);const y=document.createElement("div");y.style.marginTop="5px",y.style.fontSize="12px",y.style.color="#888",y.textContent=`Midjourney - ${(new Date).toLocaleString()}`,i.appendChild(y);const h=document.createElement("div");h.style.marginTop="10px",h.style.display="flex",h.style.flexWrap="wrap",r.buttons.forEach(((e,t)=>{const n=document.createElement("button");e.emoji&&(n.innerHTML=e.emoji),e.label&&(n.innerHTML+=` ${e.label}`),n.style.marginRight="5px",n.style.marginBottom="5px",n.style.padding="5px 10px",n.style.fontSize="12px",n.style.borderRadius="5px",n.style.backgroundColor="#fffd01",n.style.color="#191919 ",n.style.border="none",n.style.cursor="pointer",n.addEventListener("click",(async()=>{try{let t,n,s,i;e.customId.includes("::")?[,,t,n,s]=e.customId.split("::"):(t=e.action,n=e.index,s=this.generateHash(r.id,n)),i="upsample_v6_2x_subtle"===t||"upsample_v6_2x_creative"===t||"low_variation"===t||"high_variation"===t||"pan_left"===t||"pan_right"===t||"pan_up"===t||"pan_down"===t||"reroll"===t?`MJ::JOB::${t}::${n}::${s}`:t.startsWith("Outpaint")?e.customId:"Inpaint"===t?`MJ::${t}::1::${n}::${s}::SOLO`:"CustomZoom"===t?`MJ::CustomZoom::${n}::${s}`:`MJ::JOB::${t}::${n}::${s}`;const a=(await this.submit(t,r.id,n,{customId:i})).result;let l;const d=document.createElement("div");d.classList.add("message"),d.style.alignSelf="flex-start",d.style.backgroundColor="#3d3d3f",d.style.color="white",d.style.marginBottom="20px",d.style.maxWidth="80%",d.style.padding="10px",d.style.borderRadius="10px",d.style.fontSize="14px",d.style.position="relative";const c=document.createElement("div");c.style.wordWrap="break-word",c.style.overflowWrap="break-word";const p=document.createElement("img");p.style.maxWidth="100%",c.appendChild(p),d.appendChild(c),o.appendChild(d);const y=document.createElement("div"),h=document.createElement("div");h.style.marginTop="5px",h.style.fontSize="12px",h.style.color="#ffffff",y.appendChild(h),d.appendChild(y);do{await new Promise((e=>setTimeout(e,1e3))),l=await this.midjourney.fetchTaskResult(a);const e=l.progress||0;h.textContent=`[Generating... ${e}]`,h.style.fontSize="14px"}while("SUCCESS"!==l.status);p.src=l.imageUrl,d.removeChild(y),p.style.cursor="pointer",p.addEventListener("click",(()=>{this.openImagePopup(l.imageUrl)}));const m=document.createElement("img");m.src=this.getAvatarByModel("midjourney"),m.style.width="30px",m.style.height="30px",m.style.borderRadius="50%",m.style.marginRight="10px",d.insertBefore(m,c);const u=document.createElement("div");u.style.marginTop="5px",u.style.fontSize="12px",u.style.color="#888",u.textContent=`Midjourney - ${(new Date).toLocaleString()}`,d.appendChild(u);const g=document.createElement("div");g.style.marginTop="10px",g.style.display="flex",g.style.flexWrap="wrap",l.buttons.forEach(((e,t)=>{const n=document.createElement("button");e.emoji&&(n.innerHTML=e.emoji),e.label&&(n.innerHTML+=` ${e.label}`),n.style.marginRight="5px",n.style.marginBottom="5px",n.style.padding="5px 10px",n.style.fontSize="12px",n.style.borderRadius="5px",n.style.backgroundColor="#fffd01",n.style.color="#191919 ",n.style.border="none",n.style.cursor="pointer",n.addEventListener("click",(async()=>{try{let t,s,i,a;e.customId.includes("::")?[,,t,s,i]=e.customId.split("::"):(t=e.action,s=e.index,i=this.generateHash(l.id,s)),a="upsample_v6_2x_subtle"===t||"upsample_v6_2x_creative"===t||"low_variation"===t||"high_variation"===t||"pan_left"===t||"pan_right"===t||"pan_up"===t||"pan_down"===t||"reroll"===t?`MJ::JOB::${t}::${s}::${i}`:t.startsWith("Outpaint")?e.customId:"Inpaint"===t?`MJ::${t}::1::${s}::${i}::SOLO`:"CustomZoom"===t?`MJ::CustomZoom::${s}::${i}`:`MJ::JOB::${t}::${s}::${i}`;const r=(await this.submit(t,l.id,s,{customId:a})).result;let d;const c=document.createElement("div");c.classList.add("message"),c.style.alignSelf="flex-start",c.style.backgroundColor="#3d3d3f",c.style.color="white",c.style.marginBottom="20px",c.style.maxWidth="80%",c.style.padding="10px",c.style.borderRadius="10px",c.style.fontSize="14px",c.style.position="relative";const p=document.createElement("div");p.style.wordWrap="break-word",p.style.overflowWrap="break-word";const y=document.createElement("img");y.style.maxWidth="100%",p.appendChild(y),c.appendChild(p),o.appendChild(c);const h=document.createElement("div"),m=document.createElement("div");m.style.marginTop="5px",m.style.fontSize="12px",m.style.color="#ffffff",h.appendChild(m),c.appendChild(h);do{await new Promise((e=>setTimeout(e,1e3))),d=await this.midjourney.fetchTaskResult(r);const e=d.progress||0;m.textContent=`[Generating... ${e}]`,m.style.fontSize="14px"}while("SUCCESS"!==d.status);y.src=d.imageUrl,c.removeChild(h),y.style.cursor="pointer",y.addEventListener("click",(()=>{this.openImagePopup(d.imageUrl)}));const u=document.createElement("img");u.src=this.getAvatarByModel("midjourney"),u.style.width="30px",u.style.height="30px",u.style.borderRadius="50%",u.style.marginRight="10px",c.insertBefore(u,p);const g=document.createElement("div");g.style.marginTop="5px",g.style.fontSize="12px",g.style.color="#888",g.textContent=`Midjourney - ${(new Date).toLocaleString()}`,c.appendChild(g);const f=document.createElement("div");f.style.marginTop="10px",f.style.display="flex",f.style.flexWrap="wrap",d.buttons.forEach(((e,t)=>{const s=document.createElement("button");e.emoji&&(s.innerHTML=e.emoji),e.label&&(s.innerHTML+=` ${e.label}`),s.style.marginRight="5px",s.style.marginBottom="5px",s.style.padding="5px 10px",s.style.fontSize="12px",s.style.borderRadius="5px",s.style.backgroundColor="#fffd01",s.style.color="#191919 ",s.style.border="none",s.style.cursor="pointer",s.addEventListener("click",(async()=>{await n.click()})),f.appendChild(s)})),c.appendChild(f),this.selectedHistoryIndex>=0?this.chatHistory[this.selectedHistoryIndex].push({content:`<img src="${d.imageUrl}">`,isUser:!1,aiName:"Midjourney",timestamp:(new Date).toLocaleString(),modelName:"midjourney"}):this.currentChatHistory.push({content:`<img src="${d.imageUrl}">`,isUser:!1,aiName:"Midjourney",timestamp:(new Date).toLocaleString(),modelName:"midjourney"}),localStorage.setItem("chatHistory",JSON.stringify(this.chatHistory)),this.sidebarDisplayed&&(this.sidebar.remove(),this.openSidebar())}catch(t){console.error(`Error executing action "${e.label}":`,t)}})),g.appendChild(n)})),d.appendChild(g),this.selectedHistoryIndex>=0?this.chatHistory[this.selectedHistoryIndex].push({content:`<img src="${l.imageUrl}">`,isUser:!1,aiName:"Midjourney",timestamp:(new Date).toLocaleString(),modelName:"midjourney"}):this.currentChatHistory.push({content:`<img src="${l.imageUrl}">`,isUser:!1,aiName:"Midjourney",timestamp:(new Date).toLocaleString(),modelName:"midjourney"}),localStorage.setItem("chatHistory",JSON.stringify(this.chatHistory)),this.sidebarDisplayed&&(this.sidebar.remove(),this.openSidebar())}catch(t){console.error(`Error executing action "${e.label}":`,t)}})),h.appendChild(n)})),i.appendChild(h),this.selectedHistoryIndex>=0?this.chatHistory[this.selectedHistoryIndex].push({content:`<img src="${r.imageUrl}">`,isUser:!1,aiName:"Midjourney",timestamp:(new Date).toLocaleString(),modelName:"midjourney"}):(this.currentChatHistory.push({content:`<img src="${r.imageUrl}">`,isUser:!1,aiName:"Midjourney",timestamp:(new Date).toLocaleString(),modelName:"midjourney"}),this.chatHistory.push([...this.currentChatHistory])),localStorage.setItem("chatHistory",JSON.stringify(this.chatHistory)),this.sidebarDisplayed&&(this.sidebar.remove(),this.openSidebar())}catch(e){console.error("Error:",e),this.displayMessage("An error occurred while generating the image. Please check your Midjourney API key and try again.",!1,"System")}}else{if(!this.apiKey||!this.apiUrl)return void this.displayMessage("Please enter your API key and URL in the settings.",!1,"System");const n={method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+this.apiKey},body:JSON.stringify({model:this.selectedModel,messages:[{role:"system",content:"You are an AI assistant. Respond to the user's messages based on the conversation history."},...this.currentChatHistory.map((e=>({role:e.isUser?"user":"assistant",content:e.content}))),{role:"user",content:t?`<img src="${t}" alt="User uploaded image"> ${e}`:e}]})};try{const e=await fetch(this.apiUrl,n);if(e.ok){const t=(await e.json()).choices[0].message.content,n=this.getModelName(this.selectedModel);await async function(e,t){const n=document.querySelector(".chat-box"),s=document.createElement("div");s.classList.add("message"),s.style.alignSelf="flex-start",s.style.backgroundColor="#3d3d3f",s.style.color="white",s.style.marginBottom="20px",s.style.maxWidth="80%",s.style.padding="10px",s.style.borderRadius="10px",s.style.fontSize="14px",s.style.position="relative";const o=document.createElement("img");o.src=this.getAvatarByAIName(t)||this.getAvatarByModel(this.selectedModel),o.onerror=function(){this.src="https://via.placeholder.com/30x30?text=AI"},o.style.width="30px",o.style.height="30px",o.style.borderRadius="50%",o.style.marginRight="10px",s.appendChild(o);const i=document.createElement("div");i.style.wordWrap="break-word",i.style.overflowWrap="break-word",s.appendChild(i),n.appendChild(s),n.scrollTop=n.scrollHeight;const a=e.split("");for(let e=0;e<a.length;e++)i.textContent+=a[e],await new Promise((e=>setTimeout(e,20)));if(setTimeout((()=>{n.scrollTop=n.scrollHeight}),0),e.includes("```")){const t=e.split("```");i.innerHTML="",t.forEach(((e,t)=>{if(t%2==1){const t=document.createElement("pre");t.textContent=e,t.style.backgroundColor="#191919",t.style.color="#fff",t.style.padding="10px",t.style.borderRadius="5px",t.style.overflowX="auto",t.style.fontFamily="monospace",i.appendChild(t)}else{e.split("\n").map((e=>e.trim())).filter((e=>""!==e)).forEach((e=>{const t=document.createElement("span");t.textContent=e,t.style.display="block",t.style.marginBottom="5px",i.appendChild(t)}))}}))}const l=document.createElement("div");l.textContent=(new Date).toLocaleString(),l.style.fontSize="12px",l.style.color="#888",s.appendChild(l);const r=document.createElement("div");r.style.display="none",r.style.position="absolute",r.style.top="5px",r.style.right="5px",r.style.padding="5px";const d=document.createElement("button");d.textContent="Copy",d.style.marginRight="5px",d.style.padding="2px 5px",d.style.fontSize="12px",d.style.borderRadius="3px",d.style.backgroundColor="#fffd01",d.style.color="#191919 ",d.style.border="none",d.style.cursor="pointer",d.addEventListener("click",(()=>{navigator.clipboard.writeText(e)})),r.appendChild(d);const c=document.createElement("button");c.textContent="Send",c.style.padding="2px 5px",c.style.fontSize="12px",c.style.borderRadius="3px",c.style.backgroundColor="#fffd01",c.style.color="#191919",c.style.border="none",c.style.cursor="pointer",c.addEventListener("click",(()=>{if(!e.includes("<img")){const t=document.querySelector(".user-input");t.value=e,t.focus()}})),r.appendChild(c),s.appendChild(r),s.addEventListener("mouseenter",(()=>{r.style.display="block"})),s.addEventListener("mouseleave",(()=>{r.style.display="none"}))}.call(this,t,n),this.selectedHistoryIndex>=0?this.chatHistory[this.selectedHistoryIndex].push({content:t,isUser:!1,aiName:n,timestamp:(new Date).toLocaleString(),modelName:this.selectedModel}):(this.currentChatHistory.push({content:t,isUser:!1,aiName:n,timestamp:(new Date).toLocaleString(),modelName:this.selectedModel}),this.chatHistory.push([...this.currentChatHistory])),localStorage.setItem("chatHistory",JSON.stringify(this.chatHistory)),this.sidebarDisplayed&&(this.sidebar.remove(),this.openSidebar())}else this.displayMessage("Error communicating with the AI. Please check your API key and try again.",!1,"System")}catch(e){console.error("Error:",e),this.displayMessage("An error occurred while communicating with the AI. Please check your internet connection and try again.",!1,"System")}}},openImagePopup(e){const t=document.createElement("div");t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.background="rgba(0, 0, 0, 0.8)",t.style.zIndex="9999",document.body.appendChild(t);const n=document.createElement("div");n.style.position="fixed",n.style.top="0",n.style.left="0",n.style.width="100%",n.style.height="100%",n.style.display="flex",n.style.justifyContent="center",n.style.alignItems="center",n.style.zIndex="10000",t.appendChild(n);const s=document.createElement("img");s.src=e,s.style.maxWidth="100%",s.style.maxHeight="100%",s.style.cursor="move",n.appendChild(s);const o=document.createElement("button");o.textContent="x",o.style.position="fixed",o.style.top="10px",o.style.right="10px",o.style.backgroundColor="#fffd01",o.style.color="#191919 ",o.style.border="none",o.style.borderRadius="50%",o.style.width="30px",o.style.height="30px",o.style.display="flex",o.style.justifyContent="center",o.style.alignItems="center",o.style.fontSize="20px",o.style.fontWeight="bold",o.style.cursor="pointer",o.style.zIndex="100001",t.appendChild(o),o.addEventListener("click",(()=>{t.remove()}));let i=1;t.addEventListener("wheel",(e=>{e.preventDefault(),e.deltaY<0?i+=.1:i>.1&&(i-=.1),s.style.transform=`scale(${i})`}));let a,l,r,d,c=!1;function p(){c=!1}s.addEventListener("mousedown",(function(e){c=!0,a=e.clientX,l=e.clientY,r=s.offsetLeft,d=s.offsetTop})),t.addEventListener("mousemove",(function(e){if(!c)return;const t=e.clientX-a,n=e.clientY-l;s.style.left=`${r+t}px`,s.style.top=`${d+n}px`})),t.addEventListener("mouseup",p),t.addEventListener("mouseleave",p)},async sendUserMessage(){const e=document.querySelector(".user-input"),t=e.value.trim();if(""!==t||this.attachment){if(this.attachment)try{const e={base64Array:[this.attachment]},t=await fetch(`${this.midjourney.apiUrl[this.midjourney.mode]}/mj/submit/upload-discord-images`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+this.midjourney.apiKey},body:JSON.stringify(e)});if(200!==t.status)throw new Error(`Error uploading image to Midjourney: ${t.status}`);{const e=await t.json();if(!(e.result&&e.result.length>0))throw new Error(`Unexpected response from Midjourney API: ${JSON.stringify(e)}`);{const t=e.result[0];this.displayMessage(`<img src="${t}">`,!0)}}delete this.attachment;const n=document.querySelector(".upload-button div");n&&n.remove()}catch(e){return console.error("Error uploading image:",e),void alert(e.message)}if(""!==t){this.displayMessage(t,!0);try{await this.sendMessageToAI(t)}catch(e){console.error("Error sending message to AI:",e),this.displayMessage("Error: Unable to get response from AI.",!1,"System")}}e.value="",this.selectedHistoryIndex>=0&&(localStorage.setItem("chatHistory",JSON.stringify(this.chatHistory)),this.sidebarDisplayed&&(this.sidebar.remove(),this.openSidebar()))}},displayMessage(e,t,n=null,s=null,o=!1){const i=document.querySelector(".chat-box"),a=document.createElement("div");a.classList.add("message"),a.style.marginBottom="20px",a.style.maxWidth="80%",a.style.padding="10px",a.style.borderRadius="10px",a.style.fontSize="14px",a.style.position="relative";const l=document.createElement("div");if(l.style.wordWrap="break-word",l.style.overflowWrap="break-word",e.includes("<img")){const t=document.createElement("img");t.src=e.match(/<img.*?src="(.*?)".*?>/)[1],t.style.maxWidth="100%",t.style.cursor="pointer",t.addEventListener("click",(()=>{this.openImagePopup(t.src)})),l.innerHTML="",l.appendChild(t)}else if(e.includes("```")){e.split("```").forEach(((e,t)=>{if(t%2==1){const t=document.createElement("pre");t.textContent=e,t.style.backgroundColor="#060415",t.style.color="#fff",t.style.padding="10px",t.style.borderRadius="5px",t.style.overflowX="auto",t.style.fontFamily="monospace",l.appendChild(t)}else{e.split("\n").map((e=>e.trim())).filter((e=>""!==e)).forEach((e=>{const t=document.createElement("span");t.textContent=e,t.style.display="block",t.style.marginBottom="5px",l.appendChild(t)}))}}))}else l.textContent=e;a.appendChild(l);const r=document.createElement("div");if(r.style.marginTop="5px",r.style.fontSize="12px",r.style.color="#888",t)a.style.alignSelf="flex-end",a.style.backgroundColor="#fffd01",a.style.color="#191919",o||this.currentChatHistory.push({content:e,isUser:!0});else{a.style.alignSelf="flex-start",a.style.backgroundColor="#3d3d3f",a.style.color="white",o||(this.selectedHistoryIndex>=0?this.chatHistory[this.selectedHistoryIndex].push({content:a.innerHTML,isUser:!1,aiName:n,timestamp:s||(new Date).toLocaleString(),modelName:this.selectedModel}):this.currentChatHistory.push({content:a.innerHTML,isUser:!1,aiName:n,timestamp:s||(new Date).toLocaleString(),modelName:this.selectedModel}));const t=document.createElement("img");t.src=this.getAvatarByAIName(n)||this.getAvatarByModel(modelName),t.onerror=function(){this.src="https://via.placeholder.com/30x30?text=AI"},t.style.width="30px",t.style.height="30px",t.style.borderRadius="50%",t.style.marginRight="10px",a.insertBefore(t,l);const i=document.createElement("div");i.style.display="none",i.style.position="absolute",i.style.top="5px",i.style.right="5px",i.style.padding="5px";const d=document.createElement("button");d.textContent="Copy",d.style.marginRight="5px",d.style.padding="2px 5px",d.style.fontSize="12px",d.style.borderRadius="3px",d.style.backgroundColor="#fffd01",d.style.color="#191919",d.style.border="none",d.style.cursor="pointer",d.addEventListener("click",(()=>{navigator.clipboard.writeText(e)})),i.appendChild(d);const c=document.createElement("button");c.textContent="Send",c.style.padding="2px 5px",c.style.fontSize="12px",c.style.borderRadius="3px",c.style.backgroundColor="#fffd01",c.style.color="#191919",c.style.border="none",c.style.cursor="pointer",c.addEventListener("click",(async()=>{if(e.includes("<img")){const t=e.match(/<img.*?src="(.*?)".*?>/)[1],n=await fetch(t),s=await n.blob(),o=`image-${Date.now()}.png`,i=new FormData;i.append("image",s,o),i.append("subfolder","pasted");try{if(await uploadFile(i),ComfyApp.clipspace&&ComfyApp.clipspace.widgets){const e=ComfyApp.clipspace.widgets.findIndex((e=>"image"===e.name));e>=0&&(ComfyApp.clipspace.widgets[e].value=`pasted/${o} [input]`)}ComfyApp.clipspace&&ComfyApp.clipspace.imgs&&void 0!==ComfyApp.clipspace.selectedIndex&&(ComfyApp.clipspace.imgs[ComfyApp.clipspace.selectedIndex]=new Image,ComfyApp.clipspace.imgs[ComfyApp.clipspace.selectedIndex].src=`view?filename=${o}&subfolder=pasted&type=input`),ComfyApp.onClipspaceEditorSave()}catch(e){console.error("Error uploading image:",e),alert("An error occurred while uploading the image. Please try again.")}}else{const t=document.querySelector(".user-input");t.value=e,t.focus()}})),i.appendChild(c),a.appendChild(i),a.addEventListener("mouseenter",(()=>{i.style.display="block"})),a.addEventListener("mouseleave",(()=>{i.style.display="none"})),r.textContent=`${n||this.getModelName(modelName)} - ${s||(new Date).toLocaleString()}`}a.appendChild(r),i.appendChild(a),setTimeout((()=>{i.scrollTop=i.scrollHeight}),0),o||localStorage.setItem("chatHistory",JSON.stringify(this.chatHistory))},async upsampleV6_2x_subtle(e){return await this.midjourney.submit("upsample_v6_2x_subtle",e,1)},async upsampleV6_2x_creative(e){return await this.midjourney.submit("upsample_v6_2x_creative",e,1)},async lowVariation(e){return await this.midjourney.submit("low_variation",e,1)},async highVariation(e){return await this.midjourney.submit("high_variation",e,1)},async Inpaint(e){return await this.midjourney.submit("Inpaint",e,1)},async Outpaint(e,t){return await this.midjourney.submit("Outpaint",e,1,{zoomLevel:t})},async CustomZoom(e){return await this.midjourney.submit("CustomZoom",e,1)},async panLeft(e){return await this.midjourney.submit("pan_left",e,1)},async panRight(e){return await this.midjourney.submit("pan_right",e,1)},async panUp(e){return await this.midjourney.submit("pan_up",e,1)},async panDown(e){return await this.midjourney.submit("pan_down",e,1)},async BOOKMARK(e){},getAvatarByAIName(e){if(this.customModels.includes(e)){return`https://via.placeholder.com/30x30?text=${e.split(" ").slice(0,2).map((e=>e.charAt(0))).join("")}`}switch(e){case"Midjourney":return"https://api.comfly.chat/wp-content/uploads/2024/07/2024051701495031.png";case"gpt-4o-mini":return"https://api.comfly.chat/wp-content/uploads/2024/07/ede7249fd4c26ed054473a3ae405038f-e1721394651139.jpeg";case"GPT-4o":case"GPT-4-all":return"https://api.comfly.chat/wp-content/uploads/2024/07/2024051400141556.webp";case"Claude3-opus":case"Claude3-Sonnet":case"Claude3-haiku":return"https://api.comfly.chat/wp-content/uploads/2024/07/2024051710414540.png";case"moonshot-v1":return"https://api.comfly.chat/wp-content/uploads/2024/07/2024062013373651.png";case"gemini-1.5-pro":return"https://api.comfly.chat/wp-content/uploads/2024/07/2024062013373534.png";case"qwen-plus":case"qwen-max":return"https://api.comfly.chat/wp-content/uploads/2024/07/2024062013373562.png";case"suno-v3.5":return"https://api.comfly.chat/wp-content/uploads/2024/07/2024051710414743.png";case"glm-4v":return"https://api.comfly.chat/wp-content/uploads/2024/07/2024062013373533.png";case"hunyuan":return"https://api.comfly.chat/wp-content/uploads/2024/07/2024062013373488.png";default:return"https://via.placeholder.com/30x30?text=AI"}},getAvatarByModel(e){if(this.customModels.includes(e)){return`https://via.placeholder.com/30x30?text=${e.split(" ").slice(0,2).map((e=>e.charAt(0))).join("")}`}switch(e){case"midjourney":return"https://api.comfly.chat/wp-content/uploads/2024/07/2024051701495031.png";case"gpt-4o-mini":return"https://api.comfly.chat/wp-content/uploads/2024/07/ede7249fd4c26ed054473a3ae405038f-e1721394651139.jpeg";case"gpt-4o":case"gpt-4-all":return"https://api.comfly.chat/wp-content/uploads/2024/07/2024051400141556.webp";case"claude-3-5-sonnet-20240620":case"claude-3-opus-20240229":case"claude-3-haiku-20240307":return"https://api.comfly.chat/wp-content/uploads/2024/07/2024051710414540.png";case"moonshot-v1-128k":return"https://api.comfly.chat/wp-content/uploads/2024/07/2024062013373651.png";case"gemini-1.5-pro":return"https://api.comfly.chat/wp-content/uploads/2024/07/2024062013373534.png";case"qwen-plus":case"qwen-max":return"https://api.comfly.chat/wp-content/uploads/2024/07/2024062013373562.png";case"suno-v3.5":return"https://api.comfly.chat/wp-content/uploads/2024/07/2024051710414743.png";case"glm-4v":return"https://api.comfly.chat/wp-content/uploads/2024/07/2024062013373533.png";case"hunyuan":return"https://api.comfly.chat/wp-content/uploads/2024/07/2024062013373488.png";default:return"path/to/default-avatar.png"}},getModelName(e){if(this.customModels.includes(e))return e;switch(e){case"midjourney":return"Midjourney";case"gpt-4o-mini":return"gpt-4o-mini";case"gpt-4o":return"GPT-4o";case"gpt-4-all":return"GPT-4-all";case"claude-3-opus-20240229":return"Claude3-opus";case"claude-3-5-sonnet-20240620":return"Claude3.5-Sonnet";case"claude-3-haiku-20240307":return"Claude-3-haiku";case"moonshot-v1-128k":return"moonshot-v1";case"gemini-1.5-pro":return"gemini-1.5-pro";case"qwen-plus":return"qwen-plus";case"qwen-max":return"qwen-max";case"suno-v3.5":return"suno-v3.5";case"glm-4v":return"glm-4v";case"hunyuan":return"hunyuan";default:return"AI"}},loadChatHistory(){const e=localStorage.getItem("chatHistory");e&&(this.chatHistory=JSON.parse(e))}};chatButton.init();
