import{app}from"../../../scripts/app.js";import{api}from"../../../scripts/api.js";import{ComfyApp}from"../../../scripts/app.js";async function uploadFile(e){try{const t=await api.fetchApi("/upload/image",{method:"POST",body:e});if(200===t.status){const e=await t.json();ComfyApp.clipspace&&ComfyApp.clipspace.imgs&&void 0!==ComfyApp.clipspace.selectedIndex&&(ComfyApp.clipspace.imgs[ComfyApp.clipspace.selectedIndex]=new Image,ComfyApp.clipspace.imgs[ComfyApp.clipspace.selectedIndex].src=`view?filename=${e.name}&subfolder=${e.subfolder}&type=${e.type}`)}else alert(t.status+" - "+t.statusText)}catch(e){console.error("Error:",e)}}async function loadApiConfig(){try{const e=await fetch("http://localhost:8080/api/get_config");if(e.ok){return await e.json()}return console.error("Failed to load API config"),{}}catch(e){return console.error("Error:",e),{}}}ComfyApp.init=async function(){const e=await loadApiConfig();this.apiKey=e.api_key||"",this.apiUrl="https://ai.comfly.chat/v1/chat/completions",this.midjourney.apiUrl.turbo="https://ai.comfly.chat/mj-turbo",this.midjourney.apiUrl.fast="https://ai.comfly.chat/mj-fast",this.midjourney.apiUrl.relax="https://ai.comfly.chat/mj-relax"};export const chatButton={button:null,chatWindow:null,popupDisplayed:!1,chatHistory:[],currentChatHistory:[],customModels:[],apiKey:"",settingsPopup:null,helpInfoEnabled:!0,sidebarDisplayed:!1,selectedModel:"midjourney",localModels:[],midjourney:{apiKey:"",apiUrl:{turbo:"https://ai.comfly.chat/mj-turbo",fast:"https://ai.comfly.chat/mj-fast",relax:"https://ai.comfly.chat/mj-relax"},mode:"fast",validateApiUrl(e){if(!["https://ai.comfly.chat/v1/chat/completions","https://ai.comfly.chat/mj-turbo","https://ai.comfly.chat/mj-fast","https://ai.comfly.chat/mj-relax"].includes(e))throw new Error(`Invalid API URL: ${e}`)},async submitImagineTask(e){this.validateApiUrl(this.apiUrl[this.mode]);const t={method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+this.apiKey},body:JSON.stringify({base64Array:[],instanceId:"",modes:[],notifyHook:"",prompt:e,remix:!0,state:""})},n=await fetch(`${this.apiUrl[this.mode]}/mj/submit/imagine`,t);return(await n.json()).result},async fetchTaskResult(e){this.validateApiUrl(this.apiUrl[this.mode]);const t={method:"GET",headers:{"Content-Type":"application/json",Authorization:"Bearer "+this.apiKey}};try{const n=await fetch(`${this.apiUrl[this.mode]}/mj/task/${e}/fetch`,t);if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);return await n.json()}catch(e){throw console.error("Error fetching task result:",e),e}}},setupModelSelect(e){e.addEventListener("change",(()=>{this.selectedModel=e.value})),e.addEventListener("dblclick",(()=>{const t=document.createElement("input");t.type="text",t.value=e.value,t.style.width=e.offsetWidth+"px",t.style.padding="8px",t.style.fontSize="14px",t.style.borderRadius="5px",t.style.border="1px solid #ccc";const n=document.createElement("div");n.style.position="absolute",n.style.width=e.offsetWidth+"px",n.style.maxHeight="200px",n.style.overflowY="auto",n.style.background="#191919",n.style.border="1px solid #ccc",n.style.borderRadius="5px",n.style.marginTop="2px",n.style.display="none",n.style.zIndex="1002",e.parentNode.replaceChild(t,e),t.parentNode.appendChild(n),t.focus();const s=["midjourney","gpt-4o-mini","gpt-4o","o1","claude-3-5-sonnet-20241022","claude-3-opus-20240229","deepseek-r1","moonshot-v1-128k","gemini-1.5-pro","qwen-plus","qwen-max","glm-4v",...this.customModels],o=o=>{const i=s.filter((e=>this.getModelName(e).toLowerCase().includes(o.toLowerCase())));n.innerHTML="",n.style.display=i.length>0?"block":"none",i.forEach((s=>{const o=document.createElement("div");o.textContent=this.getModelName(s),o.style.padding="8px",o.style.cursor="pointer",o.style.color="#fff",o.style.transition="background-color 0.2s",o.addEventListener("mouseover",(()=>{o.style.backgroundColor="#fffd01",o.style.color="#191919"})),o.addEventListener("mouseout",(()=>{o.style.backgroundColor="transparent",o.style.color="#fff"})),o.addEventListener("click",(()=>{this.selectedModel=s,t.parentNode.replaceChild(e,t),e.value=s,n.remove()})),n.appendChild(o)}))};t.addEventListener("input",(()=>{o(t.value)})),t.addEventListener("blur",(()=>{setTimeout((()=>{t.parentNode.replaceChild(e,t),n.remove(),e.value=this.selectedModel}),200)})),o("")}))},async init(){console.log("Initializing chat button");const e=document.createElement("style");e.textContent="\n            @keyframes loadingBlink {\n                0%, 80%, 100% { transform: scale(0.5); opacity: 0.3; }\n                40% { transform: scale(1); opacity: 1; }\n            }\n            \n            .loading-animation {\n                display: flex;\n                align-items: center;\n                margin-top: 5px;\n            }\n            \n            .loading-dot {\n                width: 8px;\n                height: 8px;\n                margin-right: 4px;\n                background-color: #fffd01;\n                border-radius: 50%;\n                display: inline-block;\n                animation: loadingBlink 1.4s infinite ease-in-out both;\n            }\n            \n            .loading-dot:nth-child(1) {\n                animation-delay: 0s;\n            }\n            \n            .loading-dot:nth-child(2) {\n                animation-delay: 0.2s;\n            }\n            \n            .loading-dot:nth-child(3) {\n                animation-delay: 0.4s;\n            }\n        ",document.head.appendChild(e),this.loadChatHistory();const t=await loadApiConfig();this.apiKey=t.api_key||localStorage.getItem("apiKey")||"",this.apiUrl="https://ai.comfly.chat/v1/chat/completions",this.midjourney.apiKey=t.api_key||"",this.midjourney.apiUrl.turbo="https://ai.comfly.chat/mj-turbo",this.midjourney.apiUrl.fast="https://ai.comfly.chat/mj-fast",this.midjourney.apiUrl.relax="https://ai.comfly.chat/mj-relax";const n=localStorage.getItem("apiKey");n&&(this.apiKey=n);const s=localStorage.getItem("midjourneyApiKey");s&&(this.midjourney.apiKey=s);const o=localStorage.getItem("midjourneyMode");o&&(this.midjourney.mode=o),this.helpInfoEnabled=!1!==app.ui.settings.getSettingValue("AiHelper.helpPopup");const i=localStorage.getItem("customModels");i&&(this.customModels=JSON.parse(i))},addCustomModel(e){if(!this.customModels.includes(e)&&(this.customModels.push(e),this.selectedModel=e,this.updateModelSelects(),localStorage.setItem("customModels",JSON.stringify(this.customModels)),this.settingsPopup)){const t=this.settingsPopup.querySelector("select");if(t){const n=document.createElement("option");n.value=e,n.textContent=e,n.selected=!0,t.appendChild(n)}}},updateModelSelects(){document.querySelectorAll("select").forEach((e=>{if(e.parentElement.classList.contains("model-select-container")){const t=Array.from(e.options).map((e=>e.value));this.customModels.forEach((n=>{if(!t.includes(n)){const t=document.createElement("option");t.value=n,t.textContent=n,e.appendChild(t)}}))}e.value=this.selectedModel}))},generateUUID:()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})),generateHash(e,t){const n=e+t,s=(new TextEncoder).encode(n);return crypto.subtle.digest("SHA-256",s).then((e=>Array.from(new Uint8Array(e)).map((e=>e.toString(16).padStart(2,"0"))).join("").substring(0,32)))},async submit(e,t,n,s={}){const o=await this.generateHash(t,n);let i;if("upsample_v6_2x_subtle"===e||"upsample_v6_2x_creative"===e||"low_variation"===e||"high_variation"===e||"pan_left"===e||"pan_right"===e||"pan_up"===e||"pan_down"===e||"reroll"===e)i=`MJ::JOB::${e}::${n}::${o}`;else if(e.startsWith("Outpaint")){const[,t]=e.split("::");i=`MJ::Outpaint::${t}::${n}::${o}::SOLO`}else i="Inpaint"===e?`MJ::${e}::1::${n}::${o}::SOLO`:"CustomZoom"===e?`MJ::CustomZoom::${n}::${o}`:`MJ::JOB::${e}::${n}::${o}`;const a={method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+this.midjourney.apiKey},body:JSON.stringify({customId:i,taskId:t,...s})};try{const e=await fetch(`${this.midjourney.apiUrl[this.midjourney.mode]}/mj/submit/action`,a);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return await e.json()}catch(t){throw console.error(`Error executing action "${e}":`,t),t}},createButton(e){const t=document.createElement("button");return t.classList.add("ai-helper-btn"),t.innerHTML='\n            <svg t="1719405208459" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="13158" width="36" height="36">\n                <path d="M611.384889 615.082667L527.075556 371.313778a22.414222 22.414222 0 0 0-8.419556-11.548445 34.816 34.816 0 0 0-36.067556 0 22.414222 22.414222 0 0 0-8.419555 11.548445L390.826667 614.058667c-3.811556 11.150222-3.128889 18.887111 1.877333 23.495111a27.704889 27.704889 0 0 0 19.911111 6.940444 27.363556 27.363556 0 0 0 19.114667-5.916444 39.822222 39.822222 0 0 0 10.012444-15.473778l17.863111-46.364444h81.863111l19.285334 48.469333a38.286222 38.286222 0 0 0 9.272889 13.824c5.233778 4.209778 11.946667 6.200889 18.716444 5.461333a28.558222 28.558222 0 0 0 19.911111-7.168c5.006222-4.664889 5.859556-11.946667 2.673778-22.243555zM469.845333 531.228444l31.288889-100.295111 31.004445 100.295111z m225.848889 87.608889a26.396444 26.396444 0 0 1-6.257778 19.569778 26.965333 26.965333 0 0 1-20.366222 6.485333 25.258667 25.258667 0 0 1-19.911111-6.485333 27.363556 27.363556 0 0 1-5.916444-19.057778V380.757333c0-17.180444 8.533333-25.770667 25.770666-25.770666a29.809778 29.809778 0 0 1 19.968 5.290666 24.120889 24.120889 0 0 1 6.940445 19.740445z" fill="#fffd01" p-id="13159"></path>\n                <path d="M550.912 107.463111a364.487111 364.487111 0 0 0-363.918222 368.298667c-25.258667 26.055111-78.848 85.617778-78.848 127.488 0 46.364444 43.804444 64.284444 75.093333 65.251555l35.612445 7.964445 6.769777 175.217778a65.592889 65.592889 0 0 0 65.877334 64.853333h133.632a26.055111 26.055111 0 1 0 0-51.996445H291.498667a13.312 13.312 0 0 1-13.198223-13.255111l-8.419555-216.632889-77.368889-16.896-2.730667-0.568888h-2.958222a57.742222 57.742222 0 0 1-17.635555-4.039112c-8.476444-3.413333-8.476444-6.485333-8.476445-9.443555 0-15.075556 33.109333-60.586667 70.712889-97.507556a26.055111 26.055111 0 0 0 6.485333-26.453333 25.258667 25.258667 0 0 0 1.251556-8.021333 311.808 311.808 0 1 1 623.672889 0c0 14.506667 26.055111 26.055111 26.055111 26.055111s26.055111-11.548444 26.055111-26.055111a364.430222 364.430222 0 0 0-364.032-364.259556z" fill="#fffd01" p-id="13160"></path>\n                <path d="M821.987556 315.790222s130.048 220.216889-72.817778 431.502222c0 0-10.012444 45.112889 42.097778 32.142223 0 0 145.408-119.580444 121.742222-348.842667z" fill="#fffd01" p-id="13161"></path>\n            </svg>',t.style.backgroundSize="cover",t.style.backgroundRepeat="no-repeat",t.style.backgroundPosition="center",t.style.padding="0px",t.style.margin="5px",t.style.borderRadius="5px",t.style.backgroundColor="rgba(255, 253, 1, 0.0)",t.style.color="white",t.style.border="none",t.style.cursor="pointer",t.addEventListener("click",(()=>{this.popupDisplayed?(this.chatWindow.remove(),this.popupDisplayed=!1,this.chatWindow=null):(this.openChatPopup(app,e),this.popupDisplayed=!0)})),this.button=t,t},openChatPopup(e,t){if(this.chatWindow)return;const n=document.createElement("div");n.classList.add("ai-helper-documentation-popup"),n.style.position="absolute",n.style.width="400px",n.style.height="700px",n.style.background="#191919",n.style.border="none",n.style.borderRadius="10px",n.style.padding="10px",n.style.zIndex="1001",n.style.color="white",n.style.overflow="hidden",n.style.boxShadow="none",n.style.border="2px solid #fffd01",t.appendChild(n),this.chatWindow=n,this.selectedHistoryIndex=-1;const s=document.createElement("style");s.textContent="\n            .ai-helper-documentation-popup.minimized .content-wrapper,\n            .ai-helper-documentation-popup.minimized > div:last-child,\n            .ai-helper-documentation-popup.minimized > div:last-child + div {\n                display: none;\n            }\n            .ai-helper-documentation-popup.minimized > div:first-child {\n                justify-content: flex-end;\n            }\n        ",n.appendChild(s);const o=t.getBoundingClientRect(),i=n.getBoundingClientRect(),a=window.innerHeight-o.bottom,l=o.top;a>=i.height?n.style.top=`${o.bottom}px`:l>=i.height?n.style.bottom=window.innerHeight-o.top+"px":(n.style.top="50%",n.style.transform="translateY(-50%)");const r=document.createElement("div");r.classList.add("content-wrapper"),r.style.overflow="auto",r.style.maxHeight="calc(100% - 120px)",r.style.paddingBottom="20px",n.appendChild(r);const d=document.createElement("div");d.classList.add("chat-box"),d.style.height="100%",d.style.background="#191919",d.style.padding="20px 10px",d.style.boxSizing="border-box",d.style.display="flex",d.style.flexDirection="column",d.style.fontSize="14px",d.style.overflowY="auto",r.appendChild(d);const c=document.createElement("div");c.classList.add("model-select-container"),c.style.position="absolute",c.style.top="10px",c.style.left="50%",c.style.transform="translateX(-50%)",c.style.zIndex="1001",d.appendChild(c);const p=document.createElement("select");p.style.padding="8px",p.style.fontSize="14px",p.style.borderRadius="5px",p.style.backgroundColor="#fffd01",p.style.color="#191919 ",p.style.border="none",p.style.cursor="pointer",c.appendChild(p);["midjourney","gpt-4o-mini","gpt-4o","o1","claude-3-5-sonnet-20241022","claude-3-opus-20240229","deepseek-r1","moonshot-v1-128k","gemini-1.5-pro","qwen-plus","qwen-max","glm-4v",...this.customModels].forEach((e=>{const t=document.createElement("option");t.value=e,t.textContent=this.getModelName(e),e===this.selectedModel&&(t.selected=!0),p.appendChild(t)})),this.setupModelSelect(p);const h=document.createElement("div");h.style.position="absolute",h.style.bottom="10px",h.style.left="10px",h.style.right="10px",h.style.background="#3d3d3f",h.style.padding="10px",h.style.boxSizing="border-box",h.style.borderRadius="10px",h.style.zIndex="1002",n.appendChild(h);const m=document.createElement("div");m.style.display="flex",m.style.justifyContent="space-between",m.style.alignItems="center",m.style.marginBottom="10px",h.appendChild(m);const y=document.createElement("div");y.style.display="flex",y.style.gap="8px",m.appendChild(y);const u=document.createElement("button");u.id="attachment-button",u.classList.add("upload-button"),u.title="Upload attachment",u.innerHTML='\n            <svg t="1744249799109" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="1437" width="38" height="38">\n                <path d="M370.16 738.45c-9.97 0-18.12-9.37-18.12-20.83V496.61c0-11.46 8.16-20.83 18.12-20.83 9.97 0 18.12 9.37 18.12 20.83v221.02c0 11.45-8.15 20.82-18.12 20.82z" p-id="1438" fill="#fffd01"></path>\n                <path d="M370.16 740.75c-11.26 0-20.42-10.37-20.42-23.12V496.61c0-12.75 9.16-23.12 20.42-23.12s20.42 10.37 20.42 23.12v221.02c-0.01 12.74-9.16 23.12-20.42 23.12z m0-262.68c-8.73 0-15.83 8.32-15.83 18.54v221.02c0 10.22 7.1 18.54 15.83 18.54 4.15 0 8.08-1.89 11.07-5.33 3.07-3.53 4.76-8.22 4.76-13.21V496.61c0-10.22-7.1-18.54-15.83-18.54z" p-id="1439" fill="#fffd01"></path>\n                <path d="M447.73 589.6c-4.71 0-9.24-1.81-12.87-5.26l-77.57-77.57c-7.07-7.07-7.07-18.49 0-25.56s18.49-7.07 25.56 0l77.75 77.57c7.07 7.07 7.07 18.49 0 25.56-3.63 3.62-8.16 5.26-12.87 5.26z" p-id="1440" fill="#fffd01"></path>\n                <path d="M447.73 591.89c-5.32 0-10.45-2.09-14.45-5.89l-77.61-77.61c-7.94-7.94-7.94-20.86 0-28.8 7.94-7.94 20.86-7.94 28.8 0l77.75 77.57c3.85 3.85 5.97 8.97 5.97 14.4s-2.12 10.55-5.97 14.4c-3.88 3.88-8.89 5.93-14.49 5.93z m-77.66-113.67c-4.04 0-8.08 1.54-11.16 4.61-6.15 6.15-6.15 16.16 0 22.31l77.57 77.57c3.14 2.99 7.05 4.58 11.25 4.58 4.36 0 8.25-1.59 11.25-4.58 2.99-2.99 4.63-6.95 4.63-11.16s-1.64-8.17-4.63-11.16l-77.75-77.57c-3.08-3.06-7.12-4.6-11.16-4.6z" p-id="1441" fill="#fffd01"></path>\n                <path d="M292.4 589.6c-4.71 0-9.24-1.81-12.87-5.26-7.07-7.07-7.07-18.49 0-25.56l77.75-77.75c7.07-7.07 18.49-7.07 25.56 0s7.07 18.49 0 25.56l-77.75 77.75c-3.44 3.62-7.97 5.26-12.69 5.26z" p-id="1442" fill="#fffd01"></path>\n                <path d="M292.4 591.89c-5.32 0-10.45-2.09-14.45-5.89-3.89-3.89-6.01-9.01-6.01-14.44s2.12-10.55 5.97-14.4l77.75-77.75c3.85-3.85 8.96-5.97 14.4-5.97 5.43 0 10.55 2.12 14.4 5.97 3.85 3.85 5.97 8.97 5.97 14.4s-2.12 10.55-5.97 14.4l-77.75 77.75c-3.67 3.86-8.63 5.93-14.31 5.93z m77.67-113.87c-4.21 0-8.17 1.64-11.16 4.63l-77.75 77.75a15.674 15.674 0 0 0-4.63 11.16c0 4.21 1.64 8.17 4.63 11.16 3.14 2.99 7.05 4.58 11.25 4.58 4.39 0 8.2-1.57 11.03-4.54l77.79-77.8c2.99-2.99 4.63-6.95 4.63-11.16s-1.64-8.17-4.63-11.16c-2.99-2.97-6.96-4.62-11.16-4.62z" p-id="1443" fill="#fffd01"></path>\n                <path d="M888.7 354.68l-0.07-4.51c-2.44-82.68-70.17-148.44-152.88-148.44H511.76a100.496 100.496 0 0 0-76.21-34.96h-147.3c-84.47 0-152.95 68.48-152.95 152.95v384.57c0 84.47 68.48 152.95 152.95 152.95h447.5c84.47 0 152.95-68.48 152.95-152.95V372.94c0-1.22-0.07-2.41-0.21-3.58h0.21v-14.68zM735.75 262.9l3.78 0.07c44.45 1.83 81.19 35.28 87.17 79.36l-230.27 0.02-2.92-0.1a39.343 39.343 0 0 1-34.16-26.15l-18.77-53.19h195.17z m91.77 441.38c0 50.69-41.08 91.77-91.77 91.77h-447.5c-50.69 0-91.77-41.08-91.77-91.77V319.72c0-50.68 41.09-91.77 91.77-91.77h147.29a39.32 39.32 0 0 1 37.09 26.24l29.02 82.28 1.5 3.97c15.29 38.11 52.22 63.08 93.28 63.09h231.09v300.75z" p-id="1444" fill="#fffd01"></path>\n            </svg>',u.style.padding="6px",u.style.backgroundColor="transparent",u.style.color="#191919",u.style.border="none",u.style.borderRadius="5px",u.style.cursor="pointer",u.style.display="flex",u.style.alignItems="center",u.style.justifyContent="center",u.style.width="39px",u.style.height="39px",u.addEventListener("click",(()=>{const e=document.createElement("input");e.type="file",e.accept="*/*",e.multiple=!0,e.addEventListener("change",(e=>{const t=e.target.files;if(t&&t.length>0)for(let e=0;e<t.length;e++){const n=t[e],s=new FileReader;s.onload=e=>{this.thumbnailContainer||(this.thumbnailContainer=document.createElement("div"),this.thumbnailContainer.style.position="absolute",this.thumbnailContainer.style.top="-50px",this.thumbnailContainer.style.left="10px",this.thumbnailContainer.style.display="flex",this.thumbnailContainer.style.flexWrap="wrap",this.thumbnailContainer.style.alignItems="center",this.thumbnailContainer.style.zIndex="1003",h.appendChild(this.thumbnailContainer)),this.displayImageThumbnail(e.target.result,n)},s.readAsDataURL(n)}})),e.click()})),y.appendChild(u);const g=document.createElement("button");g.innerHTML='\n            <svg t="1744687460816" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2020" width="35" height="35"><path d="M923.221333 178.304a33.024 33.024 0 0 1 2.56 2.389333l0.981334 0.981334a42.666667 42.666667 0 0 1 3.285333 55.594666c-23.381333 30.592-45.141333 53.973333-65.28 70.101334-12.629333 10.154667-25.984 20.608-40.021333 31.36 54.058667 36.224 99.2 73.472 113.493333 90.965333 33.706667 41.045333-25.6 307.669333-349.824 471.168-245.632 23.637333-636.245333-394.026667-545.749333-407.466667 50.346667-7.509333 182.528-19.84 297.429333-75.861333 121.344-59.178667 225.408-162.218667 271.274667-168.021333 34.602667-4.437333 86.528 15.530667 139.093333 44.032l-0.597333 0.512a34.730667 34.730667 0 0 1 5.162666-4.010667c21.76-13.653333 39.722667-25.984 53.888-36.906667 16.938667-13.056 39.552-36.565333 67.84-70.570666a33.024 33.024 0 0 1 46.464-4.266667zM501.76 412.757333l-5.290667 3.84c-82.474667 60.672-198.229333 132.693333-349.909333 132.693334 10.154667 29.312 40.533333 63.914667 80.938667 98.645333a36.864 36.864 0 0 1 23.466666-24.917333 1941.034667 1941.034667 0 0 0 96.682667-35.712c23.893333-9.813333 58.496-29.738667 103.893333-59.690667a33.706667 33.706667 0 0 1 48.256 12.16l0.170667 0.298667a42.666667 42.666667 0 0 1-12.757333 54.912c-38.186667 27.349333-71.594667 47.189333-100.224 59.562666-26.922667 11.605333-59.434667 25.429333-97.536 41.472 25.173333 18.005333 51.882667 35.285333 78.464 51.2a35.413333 35.413333 0 0 1 18.005333-15.104 1378.261333 1378.261333 0 0 0 76.672-31.402666c19.413333-8.96 46.762667-26.752 81.92-53.546667a33.024 33.024 0 0 1 48.256 9.216l0.725333 1.194667a42.666667 42.666667 0 0 1-9.344 54.869333c-29.653333 24.576-56.064 42.453333-79.317333 53.674667-15.829333 7.637333-34.005333 16.256-54.442667 25.941333 48.725333 23.68 90.581333 38.570667 113.493334 38.570667 114.901333-53.632 203.349333-141.226667 255.317333-217.002667l8.96 4.266667c-78.677333-37.12-141.525333-71.04-188.458667-101.802667a1580.8 1580.8 0 0 1-130.944-96.085333 42.709333 42.709333 0 0 1-6.997333-7.253334z m125.866667-78.506666l-6.656 0.426666c-13.568 1.749333-31.146667 12.458667-52.906667 28.16l-12.629333-11.093333c44.032 39.381333 83.370667 70.698667 117.973333 93.866667 36.821333 24.704 97.962667 58.709333 183.381333 102.058666 16.64-37.461333 19.669333-65.92 7.168-76.288-37.845333-31.274667-160.981333-130.56-229.248-136.832l-7.125333-0.341333z" fill="#fffd01" p-id="2021"></path></svg>',g.style.padding="6px",g.style.backgroundColor="transparent",g.style.color="#191919",g.style.border="none",g.style.borderRadius="5px",g.style.cursor="pointer",g.style.display="flex",g.style.alignItems="center",g.style.justifyContent="center",g.style.width="37px",g.style.height="37px",g.addEventListener("click",(()=>{if(confirm("Are you sure you want to clear the current chat history?")){this.selectedHistoryIndex>=0&&(this.chatHistory.splice(this.selectedHistoryIndex,1),localStorage.setItem("chatHistory",JSON.stringify(this.chatHistory)),this.selectedHistoryIndex=-1),this.currentChatHistory=[];document.querySelector(".chat-box").querySelectorAll(".message").forEach((e=>e.remove())),this.sidebarDisplayed&&(this.sidebar.remove(),this.openSidebar())}})),y.appendChild(g);const f=document.createElement("button");f.innerHTML='\n            <svg t="1744687656410" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4439" width="35" height="35"><path d="M511.744 88.832c24.32 0 48.1792 2.048 71.424 5.9392l-0.1536 0.6656c21.4528 5.7856 34.2016 27.8528 28.416 49.3056s-27.8528 34.2016-49.3056 28.416l-1.0752-0.3072 3.7888 0.512-8.4992-1.1776c-14.7968-1.8944-29.6448-2.816-44.544-2.816-192.6144 0-348.7232 156.1088-348.7232 348.7232a347.18208 347.18208 0 0 0 59.5968 195.072 40.27392 40.27392 0 0 1 9.6768 40.448l-0.768 2.2016-42.752 111.1552h304.4352c1.7408 0 3.4816 0.1024 5.1712 0.3072l0.2048-0.4096-0.6656-0.3584c4.608 0.1536 9.216 0.256 13.824 0.256 192.6144 0 348.7232-156.1088 348.7232-348.7232 0-15.0528-0.9728-29.9008-2.816-44.4928h0.3584c-1.3312-22.272 15.5648-41.3184 37.7344-42.6496 19.968-1.2288 37.8368 12.4416 41.8304 32.0512v1.8944l0.4096 2.9184c1.9456 16.4864 2.9184 33.28 2.9184 50.3296 0 237.056-192.1536 429.2096-429.2096 429.2096-4.352 0-8.704-0.0512-13.056-0.2048a30.72 30.72 0 0 1-3.1232 0.3072h-2.3552l-363.008 0.0512c-27.4432 0-46.592-26.7776-38.3488-52.48l0.768-2.2016 56.0128-145.7152a426.9312 426.9312 0 0 1-66.0992-228.9664c0-237.056 192.1536-429.2096 429.2096-429.2096z m128 466.176c22.2208 0 40.2432 17.9712 40.2944 40.192 0 21.3504-16.5888 39.0144-37.9392 40.2432h-2.3552l-274.4832 0.0512c-22.2208 0-40.2432-17.9712-40.2944-40.192 0-21.3504 16.5888-39.0144 37.9392-40.2432h2.3552l274.4832-0.0512zM469.8624 386.6112c22.2208 0 40.2432 17.9712 40.2944 40.192 0 21.3504-16.5888 39.0144-37.9392 40.2432h-2.3552l-104.6016 0.0512c-22.2208 0-40.2432-17.9712-40.2944-40.192a40.2432 40.2432 0 0 1 37.9392-40.192h2.3552l104.6016-0.0512z m294.0416-310.016c21.2992 0 38.912 16.5888 40.192 37.888v2.3552l0.0512 97.024h97.024c22.2208 0 40.2432 17.9712 40.2944 40.192a40.2432 40.2432 0 0 1-37.9392 40.192h-2.3552l-97.024 0.0512v97.024a40.20736 40.20736 0 0 1-40.3968 40.0384c-21.1456-0.1024-38.656-16.5888-39.9872-37.6832v-2.3552l-0.1024-97.024h-97.024c-22.2208 0-40.2432-17.9712-40.2944-40.192a40.2432 40.2432 0 0 1 37.9392-40.192h2.3552l97.024-0.0512V116.8384c0-22.2208 18.0224-40.2432 40.2432-40.2432z" p-id="4440" fill="#fffd01"></path></svg>',f.style.padding="6px",f.style.backgroundColor="transparent",f.style.color="#191919",f.style.border="none",f.style.borderRadius="5px",f.style.cursor="pointer",f.style.display="flex",f.style.alignItems="center",f.style.justifyContent="center",f.style.width="35px",f.style.height="35px",f.addEventListener("click",(()=>{this.newChat()})),y.appendChild(f);const x=document.createElement("button");x.innerHTML='\n            <svg t="1744687501700" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2401" width="34" height="34"><path d="M669.866667 994.133333c-8.533333 0-14.933333-2.133333-19.2-8.533333-36.266667-38.4-85.333333-59.733333-138.666667-59.733333s-102.4 21.333333-136.533333 59.733333c-4.266667 6.4-12.8 8.533333-19.2 8.533333-2.133333 0-6.4 0-8.533334-2.133333-61.866667-21.333333-115.2-53.333333-164.266666-96-8.533333-6.4-10.666667-19.2-8.533334-27.733333 14.933333-51.2 8.533333-104.533333-17.066666-149.333334-25.6-44.8-68.266667-76.8-121.6-89.6-10.666667-2.133333-19.2-10.666667-21.333334-21.333333-6.4-32-8.533333-64-8.533333-96s2.133333-64 8.533333-96c2.133333-10.666667 10.666667-19.2 21.333334-21.333333 51.2-12.8 93.866667-44.8 121.6-89.6 25.6-46.933333 32-100.266667 17.066666-149.333334-2.133333-10.666667 0-21.333333 8.533334-27.733333 49.066667-42.666667 104.533333-74.666667 164.266666-96 2.133333 0 6.4-2.133333 8.533334-2.133333 8.533333 0 14.933333 2.133333 19.2 8.533333 36.266667 38.4 85.333333 59.733333 136.533333 59.733333 53.333333 0 102.4-21.333333 138.666667-59.733333 4.266667-6.4 12.8-8.533333 19.2-8.533333 2.133333 0 6.4 0 8.533333 2.133333 59.733333 21.333333 115.2 53.333333 164.266667 96 8.533333 6.4 10.666667 19.2 8.533333 27.733333-14.933333 51.2-8.533333 104.533333 17.066667 149.333334 25.6 46.933333 68.266667 76.8 121.6 89.6 10.666667 2.133333 19.2 10.666667 21.333333 21.333333 6.4 32 8.533333 64 8.533333 96s-2.133333 64-8.533333 96c-2.133333 10.666667-10.666667 19.2-21.333333 21.333333-51.2 12.8-93.866667 44.8-121.6 89.6-25.6 46.933333-32 100.266667-17.066667 149.333334 2.133333 10.666667 0 21.333333-8.533333 27.733333-49.066667 42.666667-104.533333 74.666667-164.266667 96-2.133333 2.133333-6.4 2.133333-8.533333 2.133333z m-441.6-128c36.266667 29.866667 74.666667 51.2 117.333333 68.266667 44.8-42.666667 102.4-64 164.266667-64 61.866667 0 119.466667 23.466667 164.266666 64 42.666667-17.066667 83.2-40.533333 117.333334-68.266667-12.8-59.733333-4.266667-123.733333 25.6-174.933333 29.866667-53.333333 78.933333-91.733333 138.666666-110.933333 4.266667-23.466667 6.4-46.933333 6.4-68.266667s-2.133333-44.8-6.4-68.266667c-57.6-19.2-106.666667-57.6-138.666666-110.933333-29.866667-53.333333-40.533333-115.2-25.6-174.933333C755.2 128 716.8 106.666667 672 89.6c-44.8 42.666667-102.4 64-164.266667 64-61.866667 0-119.466667-23.466667-164.266666-64-42.666667 17.066667-83.2 40.533333-117.333334 68.266667 12.8 59.733333 4.266667 121.6-25.6 174.933333-29.866667 53.333333-78.933333 91.733333-138.666666 110.933333 0 23.466667-2.133333 46.933333-2.133334 68.266667s2.133333 44.8 6.4 68.266667c57.6 19.2 106.666667 57.6 138.666667 110.933333 27.733333 53.333333 38.4 115.2 23.466667 174.933333zM512 684.8c-93.866667 0-170.666667-76.8-170.666667-172.8 0-93.866667 76.8-172.8 170.666667-172.8s170.666667 76.8 170.666667 172.8c0 10.666667 0 19.2-2.133334 29.866667-2.133333 12.8-12.8 21.333333-25.6 21.333333h-4.266666c-14.933333-2.133333-23.466667-17.066667-21.333334-32 2.133333-8.533333 2.133333-14.933333 2.133334-21.333333 0-64-53.333333-117.333333-117.333334-117.333334s-117.333333 53.333333-117.333333 117.333334 53.333333 117.333333 117.333333 117.333333c6.4 0 12.8 0 21.333334-2.133333h4.266666c12.8 0 23.466667 8.533333 25.6 23.466666 2.133333 14.933333-6.4 29.866667-21.333333 32-12.8 2.133333-23.466667 4.266667-32 4.266667z" p-id="2402" fill="#fffd01"></path><path d="M669.866667 1000.533333c-8.533333 0-17.066667-4.266667-23.466667-10.666666-34.133333-38.4-83.2-59.733333-134.4-59.733334s-98.133333 21.333333-134.4 59.733334c-8.533333 8.533333-23.466667 12.8-34.133333 8.533333-61.866667-21.333333-117.333333-53.333333-166.4-96-10.666667-8.533333-12.8-21.333333-10.666667-34.133333 14.933333-49.066667 8.533333-102.4-17.066667-145.066667-25.6-44.8-68.266667-74.666667-117.333333-87.466667-12.8-2.133333-21.333333-12.8-25.6-25.6C2.133333 576 0 544 0 512s2.133333-64 8.533333-96c2.133333-12.8 12.8-23.466667 25.6-25.6 51.2-10.666667 91.733333-42.666667 117.333334-87.466667 25.6-44.8 32-96 17.066666-145.066666-4.266667-12.8 0-25.6 10.666667-34.133334 49.066667-42.666667 104.533333-74.666667 166.4-96 12.8-4.266667 25.6 0 34.133333 8.533334 34.133333 38.4 83.2 59.733333 134.4 59.733333s98.133333-21.333333 134.4-59.733333c8.533333-8.533333 21.333333-12.8 34.133334-8.533334 61.866667 21.333333 117.333333 53.333333 166.4 96 10.666667 8.533333 12.8 21.333333 10.666666 34.133334-14.933333 49.066667-8.533333 102.4 17.066667 145.066666 25.6 44.8 68.266667 74.666667 117.333333 87.466667 12.8 2.133333 21.333333 12.8 25.6 25.6 2.133333 32 4.266667 64 4.266667 96s-2.133333 64-8.533333 96c-2.133333 12.8-12.8 23.466667-25.6 25.6-51.2 10.666667-91.733333 42.666667-117.333334 87.466667-25.6 44.8-32 96-17.066666 145.066666 4.266667 12.8 0 25.6-10.666667 34.133334-49.066667 42.666667-104.533333 74.666667-166.4 96-2.133333 2.133333-6.4 4.266667-8.533333 4.266666zM512 919.466667c53.333333 0 104.533333 21.333333 140.8 61.866666 6.4 6.4 14.933333 8.533333 23.466667 6.4 59.733333-21.333333 115.2-53.333333 162.133333-93.866666 6.4-6.4 8.533333-14.933333 6.4-23.466667-14.933333-53.333333-10.666667-106.666667 17.066667-153.6s70.4-81.066667 123.733333-91.733333c8.533333-2.133333 14.933333-8.533333 17.066667-17.066667 6.4-32 8.533333-64 8.533333-93.866667 0-29.866667-2.133333-61.866667-8.533333-93.866666-2.133333-8.533333-8.533333-14.933333-17.066667-17.066667-53.333333-12.8-98.133333-44.8-123.733333-91.733333-27.733333-46.933333-34.133333-102.4-17.066667-153.6 2.133333-8.533333 0-17.066667-6.4-23.466667-49.066667-42.666667-102.4-74.666667-162.133333-93.866667-8.533333-2.133333-17.066667 0-23.466667 6.4-36.266667 40.533333-87.466667 61.866667-140.8 61.866667s-104.533333-21.333333-140.8-61.866667c-6.4-6.4-14.933333-8.533333-23.466667-6.4-59.733333 21.333333-115.2 53.333333-162.133333 93.866667-8.533333 2.133333-10.666667 10.666667-8.533333 19.2 14.933333 53.333333 10.666667 106.666667-17.066667 153.6s-70.4 78.933333-123.733333 91.733333c-8.533333 2.133333-14.933333 8.533333-17.066667 17.066667-6.4 32-8.533333 64-8.533333 93.866667 0 29.866667 2.133333 61.866667 8.533333 93.866666 2.133333 8.533333 8.533333 14.933333 17.066667 17.066667 53.333333 12.8 98.133333 44.8 123.733333 91.733333 27.733333 46.933333 34.133333 102.4 17.066667 153.6-2.133333 8.533333 0 17.066667 6.4 23.466667 46.933333 42.666667 102.4 74.666667 162.133333 93.866667 8.533333 2.133333 17.066667 0 23.466667-6.4 38.4-34.133333 89.6-57.6 142.933333-57.6z m162.133333 23.466666l-2.133333-2.133333c-44.8-40.533333-100.266667-64-160-64s-117.333333 23.466667-160 64l-2.133333 2.133333-2.133334-2.133333c-42.666667-17.066667-83.2-40.533333-119.466666-70.4l-2.133334-2.133333v-4.266667c12.8-57.6 4.266667-119.466667-25.6-170.666667-29.866667-51.2-76.8-89.6-134.4-108.8H64v-4.266666c-4.266667-23.466667-6.4-46.933333-6.4-70.4 0-23.466667 2.133333-46.933333 6.4-70.4v-4.266667h2.133333c57.6-17.066667 104.533333-55.466667 134.4-108.8 29.866667-51.2 38.4-113.066667 25.6-170.666667v-4.266666l2.133334-2.133334c36.266667-29.866667 76.8-53.333333 119.466666-70.4l2.133334-2.133333 2.133333 2.133333c44.8 40.533333 100.266667 64 160 64s117.333333-23.466667 160-64l2.133333-2.133333 2.133334 2.133333c42.666667 17.066667 83.2 40.533333 119.466666 70.4l2.133334 2.133334v4.266666c-12.8 59.733333-4.266667 119.466667 25.6 170.666667 29.866667 51.2 76.8 89.6 134.4 108.8h2.133333v4.266667c4.266667 23.466667 6.4 46.933333 6.4 70.4 0 23.466667-2.133333 44.8-6.4 70.4v4.266666h-2.133333c-57.6 17.066667-104.533333 55.466667-134.4 108.8-29.866667 51.2-38.4 113.066667-25.6 170.666667v4.266667l-2.133334 2.133333c-36.266667 29.866667-76.8 53.333333-119.466666 70.4l-2.133334 2.133333zM234.666667 864c34.133333 27.733333 70.4 49.066667 110.933333 64 44.8-40.533333 104.533333-64 166.4-64 61.866667 0 119.466667 23.466667 166.4 64 40.533333-17.066667 76.8-38.4 110.933333-64-12.8-59.733333-2.133333-123.733333 27.733334-177.066667 29.866667-53.333333 78.933333-93.866667 138.666666-113.066666 4.266667-21.333333 4.266667-44.8 4.266667-64 0-21.333333-2.133333-42.666667-4.266667-64-57.6-19.2-106.666667-59.733333-138.666666-113.066667-29.866667-53.333333-40.533333-115.2-27.733334-177.066667-34.133333-27.733333-70.4-49.066667-110.933333-64-44.8 40.533333-104.533333 64-166.4 64-61.866667 0-119.466667-23.466667-166.4-64-40.533333 17.066667-76.8 38.4-110.933333 64 12.8 59.733333 2.133333 123.733333-27.733334 177.066667-29.866667 53.333333-78.933333 91.733333-138.666666 113.066667-4.266667 21.333333-6.4 44.8-6.4 64 0 21.333333 2.133333 42.666667 4.266666 64 57.6 19.2 106.666667 59.733333 138.666667 113.066667 29.866667 51.2 38.4 115.2 27.733333 174.933333z m277.333333-174.933333c-98.133333 0-177.066667-78.933333-177.066667-177.066667 0-98.133333 78.933333-177.066667 177.066667-177.066667 98.133333 0 177.066667 78.933333 177.066667 177.066667 0 10.666667 0 19.2-2.133334 32-2.133333 17.066667-19.2 29.866667-38.4 25.6-17.066667-4.266667-29.866667-19.2-25.6-38.4 2.133333-8.533333 2.133333-14.933333 2.133334-19.2 0-61.866667-49.066667-110.933333-110.933334-110.933333-61.866667 0-110.933333 51.2-110.933333 110.933333 0 61.866667 49.066667 110.933333 110.933333 110.933333 6.4 0 12.8 0 19.2-2.133333 17.066667-2.133333 34.133333 8.533333 38.4 25.6 4.266667 17.066667-8.533333 34.133333-25.6 38.4-14.933333 4.266667-23.466667 4.266667-34.133333 4.266667z m0-343.466667c-91.733333 0-166.4 74.666667-166.4 166.4s74.666667 166.4 166.4 166.4c8.533333 0 19.2 0 29.866667-2.133333 12.8-2.133333 19.2-12.8 17.066666-25.6-2.133333-12.8-12.8-19.2-25.6-17.066667-8.533333 2.133333-14.933333 2.133333-21.333333 2.133333-66.133333 0-121.6-55.466667-121.6-121.6 0-68.266667 55.466667-121.6 121.6-121.6 68.266667 0 121.6 55.466667 121.6 121.6 0 6.4 0 12.8-2.133333 21.333334-2.133333 12.8 6.4 23.466667 17.066666 25.6 12.8 2.133333 23.466667-6.4 25.6-17.066667 2.133333-10.666667 2.133333-21.333333 2.133334-29.866667 2.133333-93.866667-72.533333-168.533333-164.266667-168.533333z" p-id="2403" fill="#fffd01"></path></svg>',x.style.backgroundSize="contain",x.style.backgroundRepeat="no-repeat",x.style.marginTop="0px",x.style.marginRight="0px",x.style.marginLeft="2px",x.style.padding="6px",x.style.borderRadius="5px",x.style.backgroundColor="transparent",x.style.cursor="pointer",x.style.outline="none",x.style.boxShadow="none",x.style.border="none",x.style.display="flex",x.style.alignItems="center",x.style.justifyContent="center",x.style.width="34px",x.style.height="34px",x.addEventListener("click",(()=>{this.settingsPopup?(this.settingsPopup.remove(),this.settingsPopup=null):this.openSettingsPopup()})),y.appendChild(x);const b=document.createElement("div");b.style.display="flex",b.style.alignItems="center",b.style.gap="5px";const w=document.createElement("span");w.textContent="Web",w.style.color="#fff",w.style.fontSize="12px";const v=document.createElement("label");v.style.position="relative",v.style.display="inline-block",v.style.width="40px",v.style.height="20px",v.innerHTML='\n            <input type="checkbox" style="opacity:0;width:0;height:0;">\n            <span style="position:absolute;cursor:pointer;top:0;left:0;right:0;bottom:0;background-color:#ccc;transition:.4s;border-radius:34px;">\n                <span style="position:absolute;content:\'\';height:16px;width:16px;left:2px;bottom:2px;background-color:#fff;transition:.4s;border-radius:50%;"></span>\n            </span>';const C=v.querySelector("input"),E=v.querySelector("span");C.addEventListener("change",(function(){this.checked?(E.style.backgroundColor="#fffd01",E.querySelector("span").style.transform="translateX(20px)"):(E.style.backgroundColor="#ccc",E.querySelector("span").style.transform="translateX(0)")})),b.appendChild(w),b.appendChild(v),m.appendChild(b);const S=document.createElement("div");S.style.display="flex",S.style.alignItems="center",S.style.position="relative",h.appendChild(S);const k=document.createElement("input");k.classList.add("user-input"),k.type="text",k.placeholder="Type your message...",k.style.flexGrow="1",k.style.padding="10px",k.style.fontSize="14px",k.style.border="none",k.style.borderRadius="5px",k.style.backgroundColor="#191919",k.style.color="white",k.addEventListener("keydown",(e=>{"Enter"===e.key&&this.sendUserMessage()})),S.appendChild(k);const M=document.createElement("button");M.id="send-button",M.classList.add("send-button"),M.innerHTML='\n        <div class="send-button-container">\n            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="none" class="send-icon" height="16" width="16">\n            <path d="M.5 1.163A1 1 0 0 1 1.97.28l12.868 6.837a1 1 0 0 1 0 1.766L1.969 15.72A1 1 0 0 1 .5 14.836V10.33a1 1 0 0 1 .816-.983L8.5 8 1.316 6.653A1 1 0 0 1 .5 5.67V1.163Z" fill="currentColor"></path>\n            </svg>\n        </div>\n        ',M.style.marginLeft="10px",M.style.padding="10px",M.style.fontSize="14px",M.style.borderRadius="5px",M.style.backgroundColor="#fffd01",M.style.color="#191919",M.style.border="none",M.style.cursor="pointer",M.addEventListener("click",(()=>{this.sendUserMessage()})),S.appendChild(M);const H=document.createElement("div");H.style.display="flex",H.style.alignItems="center",H.style.justifyContent="space-between",H.style.marginBottom="10px",H.style.cursor="move",n.insertBefore(H,r);const L=document.createElement("div");L.style.display="flex",L.style.alignItems="center",H.appendChild(L);const j=document.createElement("button");j.innerHTML='\n            <svg t="1719405777872" class="icon" viewBox="0 0 1126 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="655" width="35" height="35">\n                <path d="M742.4 0h-358.4C199.68 0 51.2 148.48 51.2 332.8v358.4C51.2 875.52 199.68 1024 384 1024h358.4C926.72 1024 1075.2 875.52 1075.2 691.2v-358.4C1075.2 148.48 926.72 0 742.4 0z m126.293333 826.026667H257.706667c-15.36 0-27.306667-11.946667-27.306667-27.306667 0-15.36 11.946667-27.306667 27.306667-27.306667h610.986666c15.36 0 27.306667 11.946667 27.306667 27.306667 0 15.36-11.946667 27.306667-27.306667 27.306667z m0-259.413334H257.706667c-15.36 0-27.306667-11.946667-27.306667-27.306666 0-15.36 11.946667-27.306667 27.306667-27.306667h610.986666c15.36 0 27.306667 11.946667 27.306667 27.306667 0 15.36-11.946667 27.306667-27.306667 27.306666z m0-276.48H257.706667c-15.36 0-27.306667-11.946667-27.306667-27.306666 0-15.36 11.946667-27.306667 27.306667-27.306667h610.986666c15.36 0 27.306667 11.946667 27.306667 27.306667 0 13.653333-11.946667 27.306667-27.306667 27.306666z" fill="#fffd01" p-id="656"></path>\n            </svg>',j.style.backgroundSize="contain",j.style.backgroundRepeat="no-repeat",j.style.backgroundPosition="center",j.style.marginRight="6px",j.style.padding="0px",j.style.fontSize="14px",j.style.borderRadius="5px",j.style.backgroundColor="#fffd0100",j.style.color="#191919 ",j.style.border="none",j.style.cursor="pointer",j.addEventListener("click",(()=>{this.sidebarDisplayed?this.closeSidebar():this.openSidebar()})),L.appendChild(j);const I=document.createElement("div");I.style.display="flex",I.style.alignItems="center",H.appendChild(I);const z=document.createElement("button");z.innerHTML='\n        <svg t="1719406595475" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="49548" width="20" height="20" style="fill:#fffd01;">\n            <path d="M240.512 180.181333l271.530667 271.488 271.530666-271.488a42.666667 42.666667 0 0 1 56.32-3.541333l4.010667 3.541333a42.666667 42.666667 0 0 1 0 60.330667l-271.530667 271.530667 271.530667 271.530666a42.666667 42.666667 0 0 1-56.32 63.872l-4.010667-3.541333-271.530666-271.530667-271.530667 271.530667-4.010667 3.541333a42.666667 42.666667 0 0 1-56.32-63.872l271.488-271.530666-271.488-271.530667a42.666667 42.666667 0 0 1 60.330667-60.330667z" fill="#fffd01" p-id="49549"></path>\n        </svg>',z.style.marginLeft="10px",z.style.background="none",z.style.border="none",z.style.color="white",z.style.fontSize="15px",z.style.cursor="pointer",z.addEventListener("click",(()=>{-1===this.selectedHistoryIndex&&this.currentChatHistory.length>0&&(this.chatHistory.push([...this.currentChatHistory]),localStorage.setItem("chatHistory",JSON.stringify(this.chatHistory))),this.currentChatHistory=[],n.remove(),this.popupDisplayed=!1,this.chatWindow=null,this.sidebarDisplayed&&(this.sidebar.remove(),this.openSidebar())})),I.appendChild(z);const $=localStorage.getItem("apiKey");$&&(this.apiKey=$);let T,A,R=!1;H.addEventListener("mousedown",(function(e){R=!0,T=e.clientX-n.offsetLeft,A=e.clientY-n.offsetTop})),document.addEventListener("mousemove",(function(e){R&&(n.style.left=e.clientX-T+"px",n.style.top=e.clientY-A+"px")})),document.addEventListener("mouseup",(function(){R=!1}));const B=document.createElement("div");B.style.width="10px",B.style.height="10px",B.style.position="absolute",B.style.bottom="0",B.style.right="0",B.style.cursor="se-resize",B.style.background="transparent",n.appendChild(B);let N,U,P,_,W=!1;B.addEventListener("mousedown",(function(e){e.preventDefault(),e.stopPropagation(),W=!0,N=e.clientX,U=e.clientY,P=parseInt(document.defaultView.getComputedStyle(n).width,10),_=parseInt(document.defaultView.getComputedStyle(n).height,10)})),document.addEventListener("mousemove",(function(e){if(!W)return;const t=P+(e.clientX-N),s=_+(e.clientY-U);n.style.width=`${Math.max(t,300)}px`,n.style.height=`${Math.max(s,400)}px`})),document.addEventListener("mouseup",(function(){W=!1}))},async displayImageThumbnail(e,t=null){if(this.thumbnailContainer&&"none"===this.thumbnailContainer.style.display&&(this.thumbnailContainer.remove(),this.thumbnailContainer=null),!this.thumbnailContainer){this.thumbnailContainer=document.createElement("div"),this.thumbnailContainer.style.position="absolute",this.thumbnailContainer.style.display="flex",this.thumbnailContainer.style.flexDirection="row",this.thumbnailContainer.style.flexWrap="wrap",this.thumbnailContainer.style.gap="5px",this.thumbnailContainer.style.top="-50px",this.thumbnailContainer.style.left="10px",this.thumbnailContainer.style.zIndex="1003";const e=document.querySelector(".ai-helper-documentation-popup > div:last-child");e&&e.appendChild(this.thumbnailContainer)}if("midjourney"===this.selectedModel&&t&&!t.type.startsWith("image/"))return void alert("Midjourney only supports image files");const n=document.createElement("div");let s;if(n.style.position="relative",n.style.width="40px",n.style.height="40px",n.style.marginRight="5px",n.style.marginBottom="5px",this.thumbnailContainer.appendChild(n),t&&!t.type.startsWith("image/")){s=document.createElement("div"),s.style.width="100%",s.style.height="100%",s.style.display="flex",s.style.justifyContent="center",s.style.alignItems="center",s.style.backgroundColor="#fffd01",s.style.borderRadius="5px",s.style.color="#191919",s.style.fontWeight="bold",s.style.fontSize="12px";const e=t.name.split(".").pop().toUpperCase();s.textContent=e,s.dataset.fileName=t.name,s.dataset.fileType=t.type;const n=await this.readFileContent(t);s.dataset.fileContent=n}else s=document.createElement("img"),s.src=e,s.dataset.imageUrl=e,s.style.width="100%",s.style.height="100%",s.style.objectFit="cover",s.style.borderRadius="5px",s.style.border="2px solid #fffd01";n.appendChild(s);const o=document.createElement("button");o.textContent="×",o.style.position="absolute",o.style.top="-10px",o.style.right="-10px",o.style.backgroundColor="#fffd01",o.style.color="#191919",o.style.border="none",o.style.borderRadius="50%",o.style.width="20px",o.style.height="20px",o.style.fontSize="12px",o.style.cursor="pointer",o.style.display="flex",o.style.justifyContent="center",o.style.alignItems="center",o.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),n.remove(),0===this.thumbnailContainer.children.length&&(this.thumbnailContainer.remove(),this.thumbnailContainer=null,delete this.attachments)})),n.appendChild(o),this.attachments||(this.attachments=[]),this.attachments.push({type:t?t.type:"image",name:t?t.name:"image.jpg",content:e,file:t})},async readFileContent(e){return new Promise(((t,n)=>{const s=new FileReader;if(e.type.startsWith("text/")||"application/json"===e.type||"application/javascript"===e.type||"application/xml"===e.type||"application/csv"===e.type||e.name.endsWith(".js")||e.name.endsWith(".html")||e.name.endsWith(".css")||e.name.endsWith(".md")||e.name.endsWith(".txt")||e.name.endsWith(".csv")||e.name.endsWith(".xml")||e.name.endsWith(".yml")||e.name.endsWith(".yaml")||e.name.endsWith(".json")||e.name.endsWith(".config")||e.name.endsWith(".ini"))s.readAsText(e);else{if("application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"===e.type||e.name.endsWith(".xlsx"))return"undefined"==typeof XLSX?void this.loadExternalLibrary("https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js").then((()=>this.processXLSXFile(e,t,n))).catch((n=>{console.error("Error loading XLSX library:",n),t(`[Excel file: ${e.name} - Content extraction not available]`)})):void this.processXLSXFile(e,t,n);if("application/vnd.openxmlformats-officedocument.wordprocessingml.document"===e.type||e.name.endsWith(".docx"))return"undefined"==typeof mammoth?void this.loadExternalLibrary("https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.4.21/mammoth.browser.min.js").then((()=>this.processDOCXFile(e,t,n))).catch((n=>{console.error("Error loading Mammoth library:",n),t(`[Word document: ${e.name} - Content extraction not available]`)})):void this.processDOCXFile(e,t,n);if("application/pdf"===e.type||e.name.endsWith(".pdf"))return"undefined"==typeof pdfjsLib?void Promise.all([this.loadExternalLibrary("https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"),this.loadExternalLibrary("https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js")]).then((()=>{window.pdfjsLib.GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js",this.processPDFFile(e,t,n)})).catch((n=>{console.error("Error loading PDF.js library:",n),t(`[PDF file: ${e.name} - Content extraction not available]`)})):void this.processPDFFile(e,t,n);s.readAsDataURL(e)}s.onload=()=>t(s.result),s.onerror=e=>n(e)}))},loadExternalLibrary:e=>new Promise(((t,n)=>{const s=document.createElement("script");s.src=e,s.onload=t,s.onerror=n,document.head.appendChild(s)})),processXLSXFile(e,t,n){const s=new FileReader;s.onload=function(n){try{const s=new Uint8Array(n.target.result),o=XLSX.read(s,{type:"array"});let i=`Excel file: ${e.name}\n\n`;o.SheetNames.forEach((e=>{const t=o.Sheets[e];i+=`Sheet: ${e}\n`,i+=XLSX.utils.sheet_to_csv(t)+"\n\n"})),t(i)}catch(n){console.error("XLSX processing error:",n),t(`[Could not parse Excel file: ${e.name}]`)}},s.onerror=n,s.readAsArrayBuffer(e)},processDOCXFile(e,t,n){const s=new FileReader;s.onload=function(n){try{mammoth.extractRawText({arrayBuffer:n.target.result}).then((n=>{t(`Word document: ${e.name}\n\n${n.value}`)})).catch((n=>{console.error("DOCX processing error:",n),t(`[Could not parse Word document: ${e.name}]`)}))}catch(n){console.error("DOCX reading error:",n),t(`[Error reading Word document: ${e.name}]`)}},s.onerror=n,s.readAsArrayBuffer(e)},processPDFFile(e,t,n){const s=new FileReader;s.onload=function(n){try{pdfjsLib.getDocument({data:new Uint8Array(n.target.result)}).promise.then((n=>{let s=`PDF document: ${e.name} (${n.numPages} pages)\n\n`,o=[];for(let e=1;e<=n.numPages;e++){const t=n.getPage(e).then((t=>t.getTextContent().then((t=>({pageNum:e,text:t.items.map((e=>e.str)).join(" ")})))));o.push(t)}Promise.all(o).then((e=>{e.sort(((e,t)=>e.pageNum-t.pageNum)),e.forEach((e=>{s+=`Page ${e.pageNum}:\n${e.text}\n\n`})),t(s)}))})).catch((n=>{console.error("PDF processing error:",n),t(`[Could not parse PDF: ${e.name}]`)}))}catch(n){console.error("PDF reading error:",n),t(`[Error reading PDF: ${e.name}]`)}},s.onerror=n,s.readAsArrayBuffer(e)},getBase64:async e=>new Promise(((t,n)=>{const s=new FileReader;s.readAsDataURL(e),s.onload=()=>{try{t(s.result)}catch(e){console.error("Error processing image:",e),n(e)}},s.onerror=e=>{console.error("Error reading file:",e),n(e)}})),async sendMessageToAI(e){console.log("Sending to AI:",e);const t=`AI received: ${e}`;console.log("AI response:",t),await typeMessage.call(this,t,aiName);const n={content:e,isUser:!0,timestamp:(new Date).toLocaleString()},s={content:t,isUser:!1,aiName:this.getModelName(this.selectedModel),timestamp:(new Date).toLocaleString(),modelName:this.selectedModel};this.selectedHistoryIndex>=0?this.chatHistory[this.selectedHistoryIndex].push(n,s):(this.currentChatHistory.push(n,s),this.chatHistory.push(this.currentChatHistory)),localStorage.setItem("chatHistory",JSON.stringify(this.chatHistory)),this.sidebarDisplayed&&(this.sidebar.remove(),this.openSidebar())},newChat(){this.selectedHistoryIndex>=0?(this.currentChatHistory=[],this.selectedHistoryIndex=-1):(this.currentChatHistory.length>0&&(this.chatHistory.push([...this.currentChatHistory]),localStorage.setItem("chatHistory",JSON.stringify(this.chatHistory))),this.currentChatHistory=[]);const e=document.querySelector(".chat-box");e.innerHTML="";const t=e.querySelector(".model-select-container");if(t)t.style.display="block";else{const t=document.createElement("div");t.classList.add("model-select-container"),t.style.position="absolute",t.style.top="10px",t.style.left="50%",t.style.transform="translateX(-50%)",t.style.zIndex="1001",e.appendChild(t);const n=document.createElement("select");n.style.padding="8px",n.style.fontSize="14px",n.style.borderRadius="5px",n.style.backgroundColor="#fffd01",n.style.color="#191919 ",n.style.border="none",n.style.cursor="pointer",t.appendChild(n);["midjourney","gpt-4o-mini","gpt-4o","o1","claude-3-5-sonnet-20241022","claude-3-opus-20240229","deepseek-r1","moonshot-v1-128k","gemini-1.5-pro","qwen-plus","qwen-max","glm-4v",...this.customModels].forEach((e=>{const t=document.createElement("option");t.value=e,t.textContent=this.getModelName(e),e===this.selectedModel&&(t.selected=!0),n.appendChild(t)})),this.setupModelSelect(n)}},openSettingsPopup(){if(this.settingsPopup)return;const e=document.createElement("div");e.style.position="absolute",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.background="rgba(255, 255, 255, 0.1)",e.style.backdropFilter="blur(10px)",e.style.zIndex="1002",this.chatWindow.appendChild(e);const t=document.createElement("div");t.style.position="absolute",t.style.top="50%",t.style.left="50%",t.style.transform="translate(-50%, -50%)",t.style.padding="20px",t.style.borderRadius="10px",t.style.zIndex="1003",t.style.width="80%",t.style.maxHeight="80%",t.style.overflow="auto",t.style.background="#19191900",e.appendChild(t);const n=document.createElement("style");n.textContent="\n        .main {\n            display: flex;\n            justify-content: center;\n            align-items: center;\n            width: 100%;\n        }\n        .card {\n            width: 100%;\n            max-width: 600px;\n            position: relative;\n            background-color: #fffd01;\n            border: 1px solid rgba(255, 255, 255, 0.05);\n            border-radius: 0.5rem;\n            padding: 1rem;\n            box-sizing: border-box;\n        }\n        .card::after {\n            content: \"\";\n            height: 70px;\n            width: 1px;\n            position: absolute;\n            left: -1px;\n            top: 65%;\n            transition: top 600ms ease, opacity 600ms ease;\n            background: linear-gradient(transparent, mediumslateblue, transparent);\n            box-shadow: 0 0 30px mediumslateblue;\n            opacity: 0;\n        }\n        .card:hover::after {\n            top: 25%;\n            opacity: 1;\n        }\n        .card-content {\n            display: flex;\n            flex-direction: column;\n            justify-content: center;\n            height: auto;\n            min-height: 200px;\n            align-items: center;\n            background-image: radial-gradient(#1a1a1a36 1px, transparent 1px);\n            background-position: 50% 50%;\n            background-size: 1.1rem 1.1rem;\n            padding: 2.3rem;\n            border-radius: 0.5rem;\n            overflow: hidden;\n            box-sizing: border-box;\n        }\n        .card-content .h1, .h3, .p {\n            text-align: center;\n        }\n        .card-content .h1 {\n            color: #191919;\n            font-size: 2.6rem;\n        }\n        .card-content .h3 {\n            color: #191919;\n            text-transform: uppercase;\n            font-size: 1.5rem;\n        }\n        .card-content .h3 span {\n            font-weight: 800;\n            background: linear-gradient(125deg, #b663ff, #13c1ef);\n            text-transform: uppercase;\n            -webkit-background-clip: text;\n            -webkit-text-fill-color: transparent;\n        }\n        .card-content .h3::after {\n            content: '';\n            margin-top: -5px;\n            height: 3px;\n            width: 25%;\n            background: linear-gradient(125deg, #b663ff, #13c1ef);\n            display: block;\n        }\n        .card-content .p {\n            color: #191919;\n            line-height: 1.3rem;\n        }\n        .key-input-container {\n            position: relative;\n            width: 100%;\n            margin-bottom: 15px;\n        }\n        .key-input {\n            width: 100%;\n            padding: 12px 40px 12px 15px;\n            border-radius: 5px;\n            border: none;\n            box-sizing: border-box;\n            font-size: 14px;\n        }\n        .toggle-visibility-btn {\n            position: absolute;\n            right: 10px;\n            top: 50%;\n            transform: translateY(-50%);\n            background: none;\n            border: none;\n            cursor: pointer;\n            padding: 0;\n            height: 24px;\n            width: 24px;\n            display: flex;\n            align-items: center;\n            justify-content: center;\n            color: #555;\n        }\n        .toggle-visibility-btn:hover {\n            color: #000;\n        }\n        .settings-buttons {\n            display: flex;\n            flex-wrap: wrap;\n            justify-content: center;\n            gap: 10px;\n            margin-top: 15px;\n        }\n        .logo-container {\n            display: flex;\n            flex-wrap: wrap;\n            justify-content: center;\n            gap: 5px;\n            margin: 3px auto;\n            margin-top: 25px;\n            width: 100%;\n        }\n        .logo-img {\n            width: 40px;\n            height: 40px;\n            border-radius: 50%;\n            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);\n            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;\n            z-index: 1;\n            margin-left: -17px;\n        }\n        .logo-img:hover {\n            transform: scale(1.2);\n            box-shadow: 0 0 20px 5px #fffd01;\n            z-index: 2;\n        }\n        @media (max-width: 768px) {\n            .card-content .h1 {\n                font-size: 2rem;\n            }\n            .card-content .h3 {\n                font-size: 1.2rem;\n            }\n            .logo-img {\n                width: 30px;\n                height: 30px;\n            }\n        }\n        @media (max-width: 480px) {\n            .card-content {\n                padding: 1.5rem;\n                min-height: 150px;\n            }\n            .card-content .h1 {\n                font-size: 1.5rem;\n            }\n            .card-content .h3 {\n                font-size: 1rem;\n            }\n            .logo-img {\n                width: 25px;\n                height: 25px;\n                margin-left: -10px;\n            }\n        }\n    ",document.head.appendChild(n);const s=document.createElement("div");s.className="main";const o=document.createElement("div");o.className="card";const i=document.createElement("div");i.className="card-content";const a=document.createElement("div");a.className="h3",a.innerHTML="<span>Comfly</span>ui";const l=document.createElement("div");l.className="h1",l.textContent="One of All.";const r=document.createElement("p");r.className="p",r.textContent="midjourney，gpt-4o，claude-sonnet 3.5，gemini 1.5pro，qwen-max,suno-v3.5 😂🚀😊",i.appendChild(a),i.appendChild(l),i.appendChild(r);const d=document.createElement("div");d.className="logo-container",["https://api.comfly.chat/wp-content/uploads/2024/07/2024051710414540.png","https://api.comfly.chat/wp-content/uploads/2024/07/2024051400141556.webp","https://api.comfly.chat/wp-content/uploads/2024/07/2024062013373562.png","https://api.comfly.chat/wp-content/uploads/2024/07/2024051701495031.png","https://api.comfly.chat/wp-content/uploads/2024/07/GABpc2sXIAAI_Xy.png","https://api.comfly.chat/wp-content/uploads/2024/07/2024062013373488.png","https://api.comfly.chat/wp-content/uploads/2024/07/2024051710414743.png","https://api.comfly.chat/wp-content/uploads/2025/02/1910778b44462303fb8176fb.jpg800-e1739939312535.jpg","https://api.comfly.chat/wp-content/uploads/2024/07/2024062013373651.png","https://api.comfly.chat/wp-content/uploads/2025/02/u30873412593672443986fm253fmtautoapp120fJPEG.webp"].forEach(((e,t)=>{const n=document.createElement("img");n.src=e,n.className="logo-img",d.appendChild(n)})),i.appendChild(d),o.appendChild(i),s.appendChild(o),t.appendChild(s);const c=document.createElement("h2");c.textContent="Settings",c.style.marginBottom="10px",c.style.color="white",c.style.textAlign="center",t.appendChild(c);const p=document.createElement("div");p.className="key-input-container",t.appendChild(p);const h=document.createElement("input");h.className="key-input",h.type="password",h.value=this.apiKey||"",h.placeholder="Enter your API key",p.appendChild(h);const m=document.createElement("button");m.className="toggle-visibility-btn",m.type="button",m.innerHTML='\n        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n            <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>\n            <line x1="1" y1="1" x2="23" y2="23"></line>\n        </svg>\n    ',m.title="Show API Key",m.addEventListener("click",(()=>{"password"===h.type?(h.type="text",m.innerHTML='\n                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>\n                    <circle cx="12" cy="12" r="3"></circle>\n                </svg>\n            ',m.title="Hide API Key"):(h.type="password",m.innerHTML='\n                <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n                    <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path>\n                    <line x1="1" y1="1" x2="23" y2="23"></line>\n                </svg>\n            ',m.title="Show API Key")})),p.appendChild(m);const y=document.createElement("div");y.style.marginTop="10px",y.style.display="flex",y.style.flexWrap="wrap",y.style.gap="10px",y.style.alignItems="center",y.style.justifyContent="center",t.appendChild(y);const u=document.createElement("input");u.type="text",u.placeholder="Enter custom model...",u.style.flex="1",u.style.minWidth="150px",u.style.padding="5px",u.style.fontSize="14px",u.style.borderRadius="5px",u.style.border="1px solid #ccc",y.appendChild(u);const g=document.createElement("button");g.textContent="Add",g.style.padding="5px 10px",g.style.fontSize="14px",g.style.borderRadius="5px",g.style.backgroundColor="#fffd01",g.style.color="#191919",g.style.border="none",g.style.cursor="pointer",g.addEventListener("click",(()=>{const e=u.value.trim();e&&(this.addCustomModel(e),u.value="")})),y.appendChild(g);const f=document.createElement("button");f.textContent="Ref",f.style.padding="5px 10px",f.style.fontSize="14px",f.style.borderRadius="5px",f.style.backgroundColor="#fffd01",f.style.color="#191919",f.style.border="none",f.style.cursor="pointer",f.addEventListener("click",(()=>{window.open("https://ai.comfly.chat/models","_blank")})),y.appendChild(f);const x=document.createElement("div");x.style.marginTop="10px",t.appendChild(x);const b=document.createElement("h3");b.textContent="Midjourney Settings",b.style.marginBottom="5px",b.style.textAlign="center",x.appendChild(b);const w=document.createElement("select");w.style.width="100%",w.style.padding="10px",w.style.marginBottom="10px",w.style.borderRadius="5px",w.style.boxSizing="border-box",w.style.fontSize="14px",w.innerHTML='\n        <option value="fast">Fast Mode</option>\n        <option value="relax">Relax Mode</option>\n    ',w.value=this.midjourney.mode,w.addEventListener("change",(e=>{this.midjourney.mode=e.target.value})),x.appendChild(w);const v=document.createElement("div");v.className="settings-buttons",t.appendChild(v);const C=document.createElement("button");C.textContent="Save",C.style.padding="10px 20px",C.style.fontSize="16px",C.style.backgroundColor="#fffd01",C.style.color="#191919",C.style.border="none",C.style.borderRadius="5px",C.style.cursor="pointer",C.addEventListener("click",(()=>{const t=h.value.trim();this.apiKey=t,this.midjourney.apiKey=t,localStorage.setItem("apiKey",t),localStorage.setItem("midjourneyApiKey",t),this.midjourney.mode=w.value,localStorage.setItem("midjourneyMode",this.midjourney.mode),this.settingsPopup.remove(),this.settingsPopup=null,e.remove()})),v.appendChild(C);const E=document.createElement("button");E.textContent="Cancel",E.style.padding="10px 20px",E.style.fontSize="16px",E.style.backgroundColor="#ccc",E.style.color="black",E.style.border="none",E.style.borderRadius="5px",E.style.cursor="pointer",E.addEventListener("click",(()=>{this.settingsPopup.remove(),this.settingsPopup=null,e.remove()})),v.appendChild(E),this.settingsPopup=t;const S=()=>{const e=this.chatWindow.offsetWidth;this.chatWindow.offsetHeight;e<500?(t.style.width="95%",t.style.maxHeight="95%",i.style.minHeight="150px"):(t.style.width="80%",t.style.maxHeight="80%",i.style.minHeight="200px")};S(),window.addEventListener("resize",S),C.addEventListener("click",(()=>{window.removeEventListener("resize",S)})),E.addEventListener("click",(()=>{window.removeEventListener("resize",S)}))},openSidebar(){Array.isArray(this.chatHistory)||(this.chatHistory=[]);const e=document.createElement("div");e.style.position="absolute",e.style.left="0",e.style.top="0",e.style.width="300px",e.style.height="100%",e.style.background="#3d3d3f",e.style.transition="left 0.3s",e.style.zIndex="1002",e.style.padding="20px",e.style.boxSizing="border-box",this.chatWindow.appendChild(e);const t=document.createElement("div");t.style.position="absolute",t.style.bottom="20px",t.style.left="20px",t.style.display="flex",t.style.alignItems="center",e.appendChild(t);const n=document.createElement("h2");n.textContent="Chat History",n.style.color="#ffffff ",n.style.marginBottom="20px",e.appendChild(n);const s=document.createElement("ul");if(s.style.listStyle="none",s.style.padding="0",s.style.margin="0",s.style.maxHeight="calc(100% - 60px)",s.style.overflowY="auto",e.appendChild(s),s.innerHTML="",0===this.chatHistory.length){const e=document.createElement("li");e.textContent="No messages",e.style.color="#fff",e.style.textAlign="center",e.style.padding="10px",s.appendChild(e)}else{const e=Math.min(this.chatHistory.length,6);for(let t=this.chatHistory.length-e;t<this.chatHistory.length;t++){const e=this.chatHistory[t];if(e.length>0){const n=document.createElement("li");n.style.position="relative",n.style.marginBottom="10px",n.style.padding="10px",n.style.paddingBottom="25px",n.style.borderRadius="5px",n.style.backgroundColor="#191919",n.style.color="#fff",n.style.cursor="pointer";const o=e[e.length-1],i=document.createElement("div");if(o.content.includes("<img")){const e=o.content.match(/<img[^>]+>/g);if(e&&e.length>0){const t=document.createElement("div");t.style.display="flex",t.style.flexWrap="wrap",t.style.gap="5px",e.forEach((e=>{const n=e.match(/src="([^"]+)"/);if(n&&n[1]){const e=document.createElement("img");e.src=n[1],e.style.width="40px",e.style.height="40px",e.style.objectFit="cover",e.style.borderRadius="5px",t.appendChild(e)}}));const n=o.content.replace(/<img[^>]+>/g,"").trim();if(n){const e=document.createElement("div");e.textContent=n.length>30?n.substring(0,27)+"...":n,e.style.marginTop="5px",e.style.overflow="hidden",e.style.textOverflow="ellipsis",e.style.whiteSpace="nowrap",i.appendChild(t),i.appendChild(e)}else i.appendChild(t)}}else i.textContent=`${o.isUser?"User":o.aiName}: ${o.content.slice(0,40)}`,i.style.overflow="hidden",i.style.textOverflow="ellipsis",i.style.display="-webkit-box",i.style.webkitLineClamp="2",i.style.webkitBoxOrient="vertical";n.appendChild(i);const a=document.createElement("div");a.textContent=o.timestamp,a.style.position="absolute",a.style.bottom="5px",a.style.left="10px",a.style.fontSize="12px",a.style.color="#888",n.appendChild(a),n.addEventListener("click",(()=>{this.displayChatSession(e,t)}));const l=document.createElement("div");l.style.position="absolute",l.style.top="0",l.style.right="10px",l.style.height="100%",l.style.display="flex",l.style.flexDirection="column",l.style.justifyContent="center",l.style.alignItems="center";const r=document.createElement("button");r.textContent="Delete",r.style.marginBottom="5px",r.style.padding="5px",r.style.fontSize="12px",r.style.backgroundColor="#fffd01",r.style.color="#191919 ",r.style.border="none",r.style.borderRadius="3px",r.style.cursor="pointer",r.addEventListener("click",(e=>{e.stopPropagation(),this.deleteHistoryItem(t)})),l.appendChild(r);const d=document.createElement("button");d.textContent="Export",d.style.padding="5px",d.style.fontSize="12px",d.style.backgroundColor="#fffd01",d.style.color="#191919 ",d.style.border="none",d.style.borderRadius="3px",d.style.cursor="pointer",d.addEventListener("click",(t=>{t.stopPropagation(),this.exportChatSession(e)})),l.appendChild(d),n.appendChild(l),s.appendChild(n)}}}this.sidebar=e,this.sidebarDisplayed=!0,e.addEventListener("click",(t=>{t.target===e&&this.closeSidebar()}));const o=document.createElement("style");o.textContent='\n        .help-info-toggle {\n            position: relative;\n            display: inline-block;\n            width: 40px;\n            height: 20px;\n        }\n\n        .help-info-toggle input {\n            opacity: 0;\n            width: 0;\n            height: 0;\n        }\n\n        .slider {\n            position: absolute;\n            cursor: pointer;\n            top: 0;\n            left: 0;\n            right: 0;\n            bottom: 0;\n            background-color: #ccc;\n            transition: .4s;\n            border-radius: 20px;\n        }\n\n        .slider:before {\n            position: absolute;\n            content: "";\n            height: 16px;\n            width: 16px;\n            left: 2px;\n            bottom: 2px;\n            background-color: #3d3d3f;\n            transition: .4s;\n            border-radius: 50%;\n        }\n\n        input:checked + .slider {\n            background-color: #fffd01;\n        }\n\n        input:checked + .slider:before {\n            transform: translateX(20px);\n        }\n    ',e.appendChild(o)},closeSidebar(){this.sidebar&&(this.sidebar.style.left="-300px",setTimeout((()=>{this.sidebar.remove(),this.sidebar=null,this.sidebarDisplayed=!1}),300))},displayChatSession(e,t){const n=document.querySelector(".chat-box");n.innerHTML="",e.forEach((e=>{this.displayMessage(e.content,e.isUser,e.aiName,e.timestamp,!0,e.modelName)})),setTimeout((()=>{n.scrollTop=n.scrollHeight}),0),this.closeSidebar(),this.selectedHistoryIndex=t,this.currentChatHistory=[...e];const s=n.querySelector(".model-select-container");if(s)s.style.display="block";else{const e=document.createElement("div");e.classList.add("model-select-container"),e.style.position="absolute",e.style.top="10px",e.style.left="50%",e.style.transform="translateX(-50%)",e.style.zIndex="1001",n.appendChild(e);const t=document.createElement("select");t.style.padding="8px",t.style.fontSize="14px",t.style.borderRadius="5px",t.style.backgroundColor="#fffd01",t.style.color="#191919 ",t.style.border="none",t.style.cursor="pointer",e.appendChild(t);["midjourney","gpt-4o-mini","gpt-4o","o1","claude-3-5-sonnet-20241022","claude-3-opus-20240229","deepseek-r1","moonshot-v1-128k","gemini-1.5-pro","qwen-plus","qwen-max","glm-4v",...this.customModels].forEach((e=>{const n=document.createElement("option");n.value=e,n.textContent=this.getModelName(e),e===this.selectedModel&&(n.selected=!0),t.appendChild(n)})),this.setupModelSelect(t)}},deleteHistoryItem(e){this.chatHistory.splice(e,1),localStorage.setItem("chatHistory",JSON.stringify(this.chatHistory)),this.sidebar.remove(),this.openSidebar()},exportChatSession(e){const t=e.map((e=>`${e.isUser?"User":e.aiName}: ${e.content}\nTimestamp: ${e.timestamp}\n\n`)).join(""),n=new Blob([t],{type:"text/plain;charset=utf-8"}),s=document.createElement("a");s.href=URL.createObjectURL(n),s.download="chat_session.txt",s.style.display="none",document.body.appendChild(s),s.click(),document.body.removeChild(s)},exportHistoryItem(e){const t=`AI: ${e.aiName}\nUser: ${e.content}\nTimestamp: ${e.timestamp}\n\n`,n=new Blob([t],{type:"text/plain;charset=utf-8"}),s=document.createElement("a");s.href=URL.createObjectURL(n),s.download="chat_history_item.txt",s.style.display="none",document.body.appendChild(s),s.click(),document.body.removeChild(s)},async sendMessageToAI(e,t=[],n=null){if("midjourney"===this.selectedModel){if(!this.midjourney.apiKey)return void this.displayMessage("Please enter your Midjourney API key in the settings.",!1,"System");try{let t=[];const n=e.match(/<img\s+src=["']([^"']+)["']/g);n&&(t=n.map((e=>{const t=e.match(/src=["']([^"']+)["']/);return t?t[1]:null})).filter((e=>e)));const s=await this.midjourney.submitImagineTask(e),o=document.querySelector(".chat-box"),i=document.createElement("div");i.classList.add("message"),i.style.alignSelf="flex-start",i.style.backgroundColor="#3d3d3f",i.style.color="white",i.style.marginBottom="20px",i.style.maxWidth="80%",i.style.padding="10px",i.style.borderRadius="10px",i.style.fontSize="14px",i.style.position="relative";const a=document.createElement("div");a.style.wordWrap="break-word",a.style.overflowWrap="break-word";const l=document.createElement("img");let r;l.style.maxWidth="100%",l.style.borderRadius="5px",a.appendChild(l),i.appendChild(a),o.appendChild(i);const d=document.createElement("div"),c=document.createElement("div");c.style.marginTop="5px",c.style.fontSize="12px",c.style.color="#ffffff",d.appendChild(c),i.appendChild(d);do{await new Promise((e=>setTimeout(e,1e3))),r=await this.midjourney.fetchTaskResult(s),c.innerHTML='\n                    <div class="loading-animation" style="display: inline-flex;">\n                        <span class="loading-dot"></span>\n                        <span class="loading-dot"></span>\n                        <span class="loading-dot"></span>\n                    </div>\n                '}while("SUCCESS"!==r.status);i.removeChild(d),l.src=r.imageUrl,l.style.cursor="pointer",l.addEventListener("click",(()=>{this.openImagePopup(r.imageUrl)}));const p=document.createElement("img");p.src=this.getAvatarByModel("midjourney"),p.style.width="30px",p.style.height="30px",p.style.borderRadius="50%",p.style.marginRight="10px",i.insertBefore(p,a);const h=document.createElement("div");h.style.marginTop="5px",h.style.fontSize="12px",h.style.color="#888",h.textContent=`Midjourney - ${(new Date).toLocaleString()}`,i.appendChild(h);const m=document.createElement("div");m.style.marginTop="10px",m.style.display="flex",m.style.flexWrap="wrap",r.buttons.forEach(((e,t)=>{const n=document.createElement("button");e.emoji&&(n.innerHTML=e.emoji),e.label&&(n.innerHTML+=` ${e.label}`),n.style.marginRight="5px",n.style.marginBottom="5px",n.style.padding="5px 10px",n.style.fontSize="12px",n.style.borderRadius="5px",n.style.backgroundColor="#fffd01",n.style.color="#191919 ",n.style.border="none",n.style.cursor="pointer",n.addEventListener("click",(async()=>{try{let t,n,s,i;e.customId.includes("::")?[,,t,n,s]=e.customId.split("::"):(t=e.action,n=e.index,s=this.generateHash(r.id,n)),i="upsample_v6_2x_subtle"===t||"upsample_v6_2x_creative"===t||"low_variation"===t||"high_variation"===t||"pan_left"===t||"pan_right"===t||"pan_up"===t||"pan_down"===t||"reroll"===t?`MJ::JOB::${t}::${n}::${s}`:t.startsWith("Outpaint")?e.customId:"Inpaint"===t?`MJ::${t}::1::${n}::${s}::SOLO`:"CustomZoom"===t?`MJ::CustomZoom::${n}::${s}`:`MJ::JOB::${t}::${n}::${s}`;const a=(await this.submit(t,r.id,n,{customId:i})).result;let l;const d=document.createElement("div");d.classList.add("message"),d.style.alignSelf="flex-start",d.style.backgroundColor="#3d3d3f",d.style.color="white",d.style.marginBottom="20px",d.style.maxWidth="80%",d.style.padding="10px",d.style.borderRadius="10px",d.style.fontSize="14px",d.style.position="relative";const c=document.createElement("div");c.style.wordWrap="break-word",c.style.overflowWrap="break-word";const p=document.createElement("img");p.style.maxWidth="100%",c.appendChild(p),d.appendChild(c),o.appendChild(d);const h=document.createElement("div"),m=document.createElement("div");m.style.marginTop="5px",m.style.fontSize="12px",m.style.color="#ffffff",h.appendChild(m);do{await new Promise((e=>setTimeout(e,1e3))),l=await this.midjourney.fetchTaskResult(a);l.progress;m.innerHTML='\n                                <div class="loading-animation" style="display: inline-flex;">\n                                    <span class="loading-dot"></span>\n                                    <span class="loading-dot"></span>\n                                    <span class="loading-dot"></span>\n                                </div>\n                            ',m.style.fontSize="14px"}while("SUCCESS"!==l.status);p.src=l.imageUrl,d.removeChild(h),p.style.cursor="pointer",p.addEventListener("click",(()=>{this.openImagePopup(l.imageUrl)}));const y=document.createElement("img");y.src=this.getAvatarByModel("midjourney"),y.style.width="30px",y.style.height="30px",y.style.borderRadius="50%",y.style.marginRight="10px",d.insertBefore(y,c);const u=document.createElement("div");u.style.marginTop="5px",u.style.fontSize="12px",u.style.color="#888",u.textContent=`Midjourney - ${(new Date).toLocaleString()}`,d.appendChild(u);const g=document.createElement("div");g.style.marginTop="10px",g.style.display="flex",g.style.flexWrap="wrap",l.buttons.forEach(((e,t)=>{const n=document.createElement("button");e.emoji&&(n.innerHTML=e.emoji),e.label&&(n.innerHTML+=` ${e.label}`),n.style.marginRight="5px",n.style.marginBottom="5px",n.style.padding="5px 10px",n.style.fontSize="12px",n.style.borderRadius="5px",n.style.backgroundColor="#fffd01",n.style.color="#191919 ",n.style.border="none",n.style.cursor="pointer",n.addEventListener("click",(async()=>{try{let t,s,i,a;e.customId.includes("::")?[,,t,s,i]=e.customId.split("::"):(t=e.action,s=e.index,i=this.generateHash(l.id,s)),a="upsample_v6_2x_subtle"===t||"upsample_v6_2x_creative"===t||"low_variation"===t||"high_variation"===t||"pan_left"===t||"pan_right"===t||"pan_up"===t||"pan_down"===t||"reroll"===t?`MJ::JOB::${t}::${s}::${i}`:t.startsWith("Outpaint")?e.customId:"Inpaint"===t?`MJ::${t}::1::${s}::${i}::SOLO`:"CustomZoom"===t?`MJ::CustomZoom::${s}::${i}`:`MJ::JOB::${t}::${s}::${i}`;const r=(await this.submit(t,l.id,s,{customId:a})).result;let d;const c=document.createElement("div");c.classList.add("message"),c.style.alignSelf="flex-start",c.style.backgroundColor="#3d3d3f",c.style.color="white",c.style.marginBottom="20px",c.style.maxWidth="80%",c.style.padding="10px",c.style.borderRadius="10px",c.style.fontSize="14px",c.style.position="relative";const p=document.createElement("div");p.style.wordWrap="break-word",p.style.overflowWrap="break-word";const h=document.createElement("img");h.style.maxWidth="100%",p.appendChild(h),c.appendChild(p),o.appendChild(c);const m=document.createElement("div"),y=document.createElement("div");y.style.marginTop="5px",y.style.fontSize="12px",y.style.color="#ffffff",m.appendChild(y),c.appendChild(m);do{await new Promise((e=>setTimeout(e,1e3))),d=await this.midjourney.fetchTaskResult(r);d.progress;y.textContent='\n                                            <div class="loading-animation" style="display: inline-flex;">\n                                                <span class="loading-dot"></span>\n                                                <span class="loading-dot"></span>\n                                                <span class="loading-dot"></span>\n                                            </div>\n                                            '}while("SUCCESS"!==d.status);h.src=d.imageUrl,c.removeChild(m),h.style.cursor="pointer",h.addEventListener("click",(()=>{this.openImagePopup(d.imageUrl)}));const u=document.createElement("img");u.src=this.getAvatarByModel("midjourney"),u.style.width="30px",u.style.height="30px",u.style.borderRadius="50%",u.style.marginRight="10px",c.insertBefore(u,p);const g=document.createElement("div");g.style.marginTop="5px",g.style.fontSize="12px",g.style.color="#888",g.textContent=`Midjourney - ${(new Date).toLocaleString()}`,c.appendChild(g);const f=document.createElement("div");f.style.marginTop="10px",f.style.display="flex",f.style.flexWrap="wrap",d.buttons.forEach(((e,t)=>{const s=document.createElement("button");e.emoji&&(s.innerHTML=e.emoji),e.label&&(s.innerHTML+=` ${e.label}`),s.style.marginRight="5px",s.style.marginBottom="5px",s.style.padding="5px 10px",s.style.fontSize="12px",s.style.borderRadius="5px",s.style.backgroundColor="#fffd01",s.style.color="#191919 ",s.style.border="none",s.style.cursor="pointer",s.addEventListener("click",(async()=>{await n.click()})),f.appendChild(s)})),c.appendChild(f),this.selectedHistoryIndex>=0?this.chatHistory[this.selectedHistoryIndex].push({content:`<img src="${d.imageUrl}">`,isUser:!1,aiName:"Midjourney",timestamp:(new Date).toLocaleString(),modelName:"midjourney"}):this.currentChatHistory.push({content:`<img src="${d.imageUrl}">`,isUser:!1,aiName:"Midjourney",timestamp:(new Date).toLocaleString(),modelName:"midjourney"}),localStorage.setItem("chatHistory",JSON.stringify(this.chatHistory)),this.sidebarDisplayed&&(this.sidebar.remove(),this.openSidebar())}catch(t){console.error(`Error executing action "${e.label}":`,t)}})),g.appendChild(n)})),d.appendChild(g),this.selectedHistoryIndex>=0?this.chatHistory[this.selectedHistoryIndex].push({content:`<img src="${l.imageUrl}">`,isUser:!1,aiName:"Midjourney",timestamp:(new Date).toLocaleString(),modelName:"midjourney"}):this.currentChatHistory.push({content:`<img src="${l.imageUrl}">`,isUser:!1,aiName:"Midjourney",timestamp:(new Date).toLocaleString(),modelName:"midjourney"}),localStorage.setItem("chatHistory",JSON.stringify(this.chatHistory)),this.sidebarDisplayed&&(this.sidebar.remove(),this.openSidebar())}catch(t){console.error(`Error executing action "${e.label}":`,t)}})),m.appendChild(n)})),i.appendChild(m),this.selectedHistoryIndex>=0?this.chatHistory[this.selectedHistoryIndex].push({content:`<img src="${r.imageUrl}">`,isUser:!1,aiName:"Midjourney",timestamp:(new Date).toLocaleString(),modelName:"midjourney"}):(this.currentChatHistory.push({content:`<img src="${r.imageUrl}">`,isUser:!1,aiName:"Midjourney",timestamp:(new Date).toLocaleString(),modelName:"midjourney"}),this.chatHistory.push([...this.currentChatHistory])),localStorage.setItem("chatHistory",JSON.stringify(this.chatHistory)),this.sidebarDisplayed&&(this.sidebar.remove(),this.openSidebar())}catch(e){console.error("Error:",e),this.displayMessage("An error occurred while generating the image. Please check your Midjourney API key and try again.",!1,"System")}}else{if(!this.apiKey||!this.apiUrl)return n&&n.remove(),void this.displayMessage("Please enter your API key and URL in the settings.",!1,"System");let s,o=[{role:"system",content:"You are an AI assistant. Respond to the user's messages based on the conversation history and any provided files or images."},...this.currentChatHistory.map((e=>({role:e.isUser?"user":"assistant",content:e.content})))],i=[];if(e&&i.push({type:"text",text:e}),t&&t.length>0)for(const e of t)"image_url"===e.type?i.push(e):e.type.startsWith("image/")?i.push({type:"image_url",image_url:{url:e.content}}):i.push({type:"text",text:`\n\n<ATTACHMENT_FILE>\n<FILE_INDEX>File: ${e.name}\n${e.content}`});s=1===i.length&&"text"===i[0].type?{role:"user",content:i[0].text}:{role:"user",content:i},o.push(s);const a={method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+this.apiKey},body:JSON.stringify({model:this.selectedModel,messages:o})};try{const e=await fetch(this.apiUrl,a);if(e.ok){const t=(await e.json()).choices[0].message.content,s=this.getModelName(this.selectedModel);await async function(e,t){const s=document.querySelector(".chat-box"),o=document.createElement("div");o.classList.add("message"),o.style.alignSelf="flex-start",o.style.backgroundColor="#3d3d3f",o.style.color="white",o.style.marginBottom="15px",o.style.maxWidth="80%",o.style.padding="12px",o.style.borderRadius="18px",o.style.borderBottomLeftRadius="5px",o.style.fontSize="14px",o.style.position="relative",o.style.boxShadow="0 2px 5px rgba(0,0,0,0.1)";const i=document.createElement("img");i.src=this.getAvatarByAIName(t)||this.getAvatarByModel(this.selectedModel),i.onerror=function(){this.src="https://api.comfly.chat/wp-content/uploads/2024/07/QQ图片20240730175428_美图抠图20240730.png"},i.style.width="28px",i.style.height="28px",i.style.borderRadius="50%",i.style.marginRight="8px",i.style.border="2px solid #fffd01",o.appendChild(i);const a=document.createElement("div");a.style.wordWrap="break-word",a.style.overflowWrap="break-word",o.appendChild(a),n&&n.remove();s.appendChild(o),s.scrollTop=s.scrollHeight;const l=e.includes,r=e.includes("[点击下载");if(l||r){let t=e;if(l){const e=/!\[Image\]\((https?:\/\/[^\s)]+)\)/g;t=t.replace(e,((e,t)=>`<img src="${t}" alt="AI generated image" style="max-width: 100%; border-radius: 8px; margin: 8px 0; cursor: pointer;" onclick="window.chatButton.openImagePopup('${t}')" />`))}if(r){const e=/\[点击下载\s+([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g;t=t.replace(e,((e,t,n)=>`<a href="${n}" target="_blank" style="color: #fffd01; text-decoration: underline;" download>${t}</a>`))}if(t.includes("```")){const e=t.split("```");a.innerHTML="",e.forEach(((e,t)=>{if(t%2==1){const t=document.createElement("pre");t.textContent=e,t.style.backgroundColor="#101010",t.style.color="#fff",t.style.padding="10px",t.style.borderRadius="5px",t.style.overflowX="auto",t.style.fontFamily="monospace",a.appendChild(t)}else{const t=document.createElement("div");t.innerHTML=e,a.appendChild(t)}}))}else a.innerHTML=t}else{const t=e.split("");for(let e=0;e<t.length;e++)a.textContent+=t[e],await new Promise((e=>setTimeout(e,20)));if(e.includes("```")){const t=e.split("```");a.innerHTML="",t.forEach(((e,t)=>{if(t%2==1){const t=document.createElement("pre");t.textContent=e,t.style.backgroundColor="#101010",t.style.color="#fff",t.style.padding="10px",t.style.borderRadius="5px",t.style.overflowX="auto",t.style.fontFamily="monospace",a.appendChild(t)}else{e.split("\n").map((e=>e.trim())).filter((e=>""!==e)).forEach((e=>{const t=document.createElement("span");t.textContent=e,t.style.display="block",t.style.marginBottom="5px",a.appendChild(t)}))}}))}}setTimeout((()=>{s.scrollTop=s.scrollHeight}),0);const d=document.createElement("div");d.textContent=(new Date).toLocaleString(),d.style.fontSize="11px",d.style.color="#888",d.style.marginTop="5px",o.appendChild(d);const c=document.createElement("div");c.style.display="none",c.style.position="absolute",c.style.top="8px",c.style.right="8px",c.style.gap="5px",c.style.display="flex";const p=document.createElement("button");p.innerHTML='<svg width="14" height="14" viewBox="0 0 24 24"><path fill="#191919" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>',p.style.width="22px",p.style.height="22px",p.style.padding="4px",p.style.borderRadius="50%",p.style.backgroundColor="#fffd01",p.style.border="none",p.style.cursor="pointer",p.style.display="flex",p.style.justifyContent="center",p.style.alignItems="center",p.addEventListener("click",(()=>{navigator.clipboard.writeText(e)})),c.appendChild(p);const h=document.createElement("button");h.innerHTML='<svg width="14" height="14" viewBox="0 0 24 24"><path fill="#191919" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>',h.style.width="22px",h.style.height="22px",h.style.padding="4px",h.style.borderRadius="50%",h.style.backgroundColor="#fffd01",h.style.border="none",h.style.cursor="pointer",h.style.display="flex",h.style.justifyContent="center",h.style.alignItems="center",h.style.marginLeft="5px",h.addEventListener("click",(()=>{if(confirm("Are you sure you want to delete this message?"))if(o.remove(),this.selectedHistoryIndex>=0){const t=this.chatHistory[this.selectedHistoryIndex].findIndex((t=>t.content===e&&!t.isUser));-1!==t&&(this.chatHistory[this.selectedHistoryIndex].splice(t,1),localStorage.setItem("chatHistory",JSON.stringify(this.chatHistory)))}else{const t=this.currentChatHistory.findIndex((t=>t.content===e&&!t.isUser));-1!==t&&(this.currentChatHistory.splice(t,1),localStorage.setItem("chatHistory",JSON.stringify(this.chatHistory)))}})),c.appendChild(h),o.appendChild(c),o.addEventListener("mouseenter",(()=>{c.style.display="flex"})),o.addEventListener("mouseleave",(()=>{c.style.display="none"}))}.call(this,t,s),this.selectedHistoryIndex>=0?this.chatHistory[this.selectedHistoryIndex].push({content:t,isUser:!1,aiName:s,timestamp:(new Date).toLocaleString(),modelName:this.selectedModel}):(this.currentChatHistory.push({content:t,isUser:!1,aiName:s,timestamp:(new Date).toLocaleString(),modelName:this.selectedModel}),this.chatHistory.push([...this.currentChatHistory])),localStorage.setItem("chatHistory",JSON.stringify(this.chatHistory)),this.sidebarDisplayed&&(this.sidebar.remove(),this.openSidebar())}else n&&n.remove(),this.displayMessage("Error communicating with the AI. Please check your API key and try again.",!1,"System")}catch(e){n&&n.remove(),console.error("Error:",e),this.displayMessage("An error occurred while communicating with the AI. Please check your internet connection and try again.",!1,"System")}}},openImagePopup(e){const t=document.createElement("div");t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="100%",t.style.height="100%",t.style.background="rgba(0, 0, 0, 0.8)",t.style.zIndex="9999",document.body.appendChild(t);const n=document.createElement("div");n.style.position="fixed",n.style.top="0",n.style.left="0",n.style.width="100%",n.style.height="100%",n.style.display="flex",n.style.justifyContent="center",n.style.alignItems="center",n.style.zIndex="10000",t.appendChild(n);const s=document.createElement("img");s.src=e,s.style.maxWidth="100%",s.style.maxHeight="100%",s.style.cursor="move",n.appendChild(s);const o=document.createElement("button");o.textContent="x",o.style.position="fixed",o.style.top="10px",o.style.right="10px",o.style.backgroundColor="#fffd01",o.style.color="#191919 ",o.style.border="none",o.style.borderRadius="50%",o.style.width="30px",o.style.height="30px",o.style.display="flex",o.style.justifyContent="center",o.style.alignItems="center",o.style.fontSize="20px",o.style.fontWeight="bold",o.style.cursor="pointer",o.style.zIndex="100001",t.appendChild(o),o.addEventListener("click",(()=>{t.remove()}));let i=1;t.addEventListener("wheel",(e=>{e.preventDefault(),e.deltaY<0?i+=.1:i>.1&&(i-=.1),s.style.transform=`scale(${i})`}));let a,l,r,d,c=!1;function p(){c=!1}s.addEventListener("mousedown",(function(e){c=!0,a=e.clientX,l=e.clientY,r=s.offsetLeft,d=s.offsetTop})),t.addEventListener("mousemove",(function(e){if(!c)return;const t=e.clientX-a,n=e.clientY-l;s.style.left=`${r+t}px`,s.style.top=`${d+n}px`})),t.addEventListener("mouseup",p),t.addEventListener("mouseleave",p)},async sendUserMessage(){const e=document.querySelector(".user-input"),t=e.value.trim();if(""!==t||this.attachments&&this.attachments.length>0){let n=document.querySelector(".chat-box");const s=document.createElement("div");s.classList.add("message","loading-message"),s.style.alignSelf="flex-start",s.style.backgroundColor="#3d3d3f",s.style.color="white",s.style.marginBottom="15px",s.style.maxWidth="80%",s.style.padding="12px",s.style.borderRadius="18px",s.style.borderBottomLeftRadius="5px",s.style.fontSize="14px",s.style.position="relative",s.style.boxShadow="0 2px 5px rgba(0,0,0,0.1)";const o=document.createElement("div");o.className="loading-animation";const i=document.createElement("div");if(i.style.display="flex",i.innerHTML='\n            <span class="loading-dot"></span>\n            <span class="loading-dot"></span>\n            <span class="loading-dot"></span>\n        ',o.appendChild(i),s.appendChild(o),"midjourney"===this.selectedModel&&this.attachments&&this.attachments.length>0)try{const e=this.attachments.filter((e=>e.type.startsWith("image/"))).map((e=>e.content));if(e.length>0){let o="";e.forEach((e=>{o+=`<img src="${e}" alt="User uploaded image" style="max-width: 150px; max-height: 150px; object-fit: cover; border-radius: 5px; margin-right: 5px; margin-bottom: 5px;">`})),t&&(o+=`<div style="margin-top: 5px; word-break: break-word;">${t}</div>`),this.displayMessage(o,!0),n.appendChild(s),n.scrollTop=n.scrollHeight;const i=await fetch("https://ai.comfly.chat/mj/submit/upload-discord-images",{method:"POST",headers:{"Content-Type":"application/json","Mj-Api-Secret":this.midjourney.apiKey},body:JSON.stringify({base64Array:e})});s.remove();const a=await i.json();if(!(1===a.code&&a.result.length>0))throw new Error("Failed to upload images");a.result;this.displayMessage(`Images uploaded successfully. URLs: ${a.result.join(", ")}`,!1,"System")}else""!==t&&(this.displayMessage(t,!0),n.appendChild(s),n.scrollTop=n.scrollHeight,await this.sendMessageToAI(t),s.remove())}catch(e){s.remove(),console.error("Error uploading images to Midjourney:",e),this.displayMessage("Error: Failed to upload images to Midjourney.",!1,"System")}else{let e=[];if(this.attachments&&this.attachments.length>0){let n="";for(const t of this.attachments)if(t.type.startsWith("image/"))n+=`<img src="${t.content}" alt="User uploaded image" style="max-width: 150px; max-height: 150px; object-fit: cover; border-radius: 5px; margin-right: 5px; margin-bottom: 5px;">`,e.push({type:"image_url",image_url:{url:t.content}});else{const s=t.name.length>20?t.name.substring(0,17)+"...":t.name;n+=`<div style="background-color: #fffd01; color: #191919; padding: 5px; border-radius: 5px; margin-bottom: 8px; display: inline-block; max-width: 100%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${t.name}">[File: ${s}]</div>`,e.push({type:"file",name:t.name,content:t.file?await this.readFileContent(t.file):t.content})}""!==t&&(n+=`<div style="margin-top: 5px; word-break: break-word;">${t}</div>`),this.displayMessage(n,!0)}else""!==t&&this.displayMessage(t,!0);n.appendChild(s),n.scrollTop=n.scrollHeight;try{await this.sendMessageToAI(t,e,s),s.remove()}catch(e){s.remove(),console.error("Error sending message to AI:",e),this.displayMessage("Error: Unable to get response from AI.",!1,"System")}}e.value="",this.thumbnailContainer&&(this.thumbnailContainer.remove(),this.thumbnailContainer=null),this.attachments=[]}},displayMessage(e,t,n=null,s=null,o=!1,i=null){const a=this.chatWindow.querySelector(".content-wrapper");let l=a.querySelector(".chat-box");l||(a.innerHTML="",a.style.justifyContent="flex-start",l=document.createElement("div"),l.classList.add("chat-box"),l.style.width="100%",l.style.height="100%",l.style.padding="10px",l.style.boxSizing="border-box",l.style.display="flex",l.style.flexDirection="column",l.style.fontSize="14px",l.style.overflowY="auto",a.appendChild(l));const r=document.createElement("div");r.classList.add("message"),r.style.marginBottom="15px",r.style.maxWidth="80%",r.style.padding="12px",r.style.borderRadius="18px",r.style.fontSize="14px",r.style.position="relative",r.style.boxShadow="0 2px 5px rgba(0,0,0,0.1)";const d=document.createElement("div");if(d.style.wordWrap="break-word",d.style.overflowWrap="break-word",e.includes("<img")||e.includes('<div style="background-color: #fffd01;')){d.innerHTML=e;const t=d.querySelectorAll("img");t.length>0&&t.forEach((e=>{e.style.cursor="pointer";const t=e.src;e.addEventListener("click",(()=>{this.openImagePopup(t)}))}))}else if(e.includes("<img")){const t=document.createElement("img");t.src=e.match(/<img.*?src="(.*?)".*?>/)[1],t.style.maxWidth="100%",t.style.borderRadius="8px",t.style.cursor="pointer",t.addEventListener("click",(()=>{this.openImagePopup(t.src)})),d.innerHTML="",d.appendChild(t)}else if(!t&&e.includes("![Image](")){const t=/!\[Image\]\((https?:\/\/[^\s)]+)\)/g;let n=e.replace(t,((e,t)=>`<img src="${t}" alt="AI generated image" style="max-width: 100%; border-radius: 8px; margin: 8px 0; cursor: pointer;" onclick="window.chatButton.openImagePopup('${t}')" />`));const s=/\[点击下载\s+([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g;n=n.replace(s,((e,t,n)=>`<a href="${n}" target="_blank" style="color: #fffd01; text-decoration: underline;" download>${t}</a>`)),d.innerHTML=n}else if(e.includes("```")){e.split("```").forEach(((e,n)=>{if(n%2==1){const t=document.createElement("pre");t.textContent=e,t.style.backgroundColor="#101010",t.style.color="#fff",t.style.padding="10px",t.style.borderRadius="5px",t.style.overflowX="auto",t.style.fontFamily="monospace",d.appendChild(t)}else{let n=e;if(t){n.split("\n").map((e=>e.trim())).filter((e=>""!==e)).forEach((e=>{const t=document.createElement("span");t.textContent=e,t.style.display="block",t.style.marginBottom="5px",d.appendChild(t)}))}else{const e=/!\[Image\]\((https?:\/\/[^\s)]+)\)/g;n=n.replace(e,((e,t)=>`<img src="${t}" alt="AI generated image" style="max-width: 100%; border-radius: 8px; margin: 8px 0; cursor: pointer;" onclick="window.chatButton.openImagePopup('${t}')" />`));const t=/\[点击下载\s+([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g;n=n.replace(t,((e,t,n)=>`<a href="${n}" target="_blank" style="color: #fffd01; text-decoration: underline;" download>${t}</a>`));const s=document.createElement("div");s.innerHTML=n,d.appendChild(s)}}}))}else if(t)d.textContent=e;else{const t=/!\[Image\]\((https?:\/\/[^\s)]+)\)/g;let n=e.replace(t,((e,t)=>`<img src="${t}" alt="AI generated image" style="max-width: 100%; border-radius: 8px; margin: 8px 0; cursor: pointer;" onclick="window.chatButton.openImagePopup('${t}')" />`));const s=/\[点击下载\s+([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g;n=n.replace(s,((e,t,n)=>`<a href="${n}" target="_blank" style="color: #fffd01; text-decoration: underline;" download>${t}</a>`)),d.innerHTML=n}r.appendChild(d);const c=document.createElement("div");if(c.style.marginTop="5px",c.style.fontSize="11px",c.style.color="#888",t)r.style.alignSelf="flex-end",r.style.backgroundColor="#fffd01",r.style.color="#191919",r.style.borderBottomRightRadius="5px",o||this.currentChatHistory.push({content:e,isUser:!0});else{r.style.alignSelf="flex-start",r.style.backgroundColor="#3d3d3f",r.style.color="white",r.style.borderBottomLeftRadius="5px",o||(this.selectedHistoryIndex>=0?this.chatHistory[this.selectedHistoryIndex].push({content:e,isUser:!1,aiName:n,timestamp:s||(new Date).toLocaleString(),modelName:this.selectedModel}):this.currentChatHistory.push({content:e,isUser:!1,aiName:n,timestamp:s||(new Date).toLocaleString(),modelName:this.selectedModel}));const t=document.createElement("img");t.src=this.getAvatarByAIName(n)||this.getAvatarByModel(i||this.selectedModel),t.onerror=function(){this.src="https://api.comfly.chat/wp-content/uploads/2024/07/QQ图片20240730175428_美图抠图20240730.png"},t.style.width="28px",t.style.height="28px",t.style.borderRadius="50%",t.style.marginRight="8px",t.style.border="2px solid #fffd01",r.insertBefore(t,d);const a=document.createElement("div");a.style.display="none",a.style.position="absolute",a.style.top="8px",a.style.right="8px",a.style.gap="5px",a.style.display="flex";const l=document.createElement("button");l.innerHTML='<svg width="14" height="14" viewBox="0 0 24 24"><path fill="#191919" d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>',l.style.width="22px",l.style.height="22px",l.style.padding="4px",l.style.borderRadius="50%",l.style.backgroundColor="#fffd01",l.style.border="none",l.style.cursor="pointer",l.style.display="flex",l.style.justifyContent="center",l.style.alignItems="center",l.addEventListener("click",(()=>{navigator.clipboard.writeText(e)})),a.appendChild(l);const p=document.createElement("button");p.innerHTML='<svg width="14" height="14" viewBox="0 0 24 24"><path fill="#191919" d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>',p.style.width="22px",p.style.height="22px",p.style.padding="4px",p.style.borderRadius="50%",p.style.backgroundColor="#fffd01",p.style.border="none",p.style.cursor="pointer",p.style.display="flex",p.style.justifyContent="center",p.style.alignItems="center",p.style.marginLeft="5px",p.addEventListener("click",(()=>{if(confirm("Are you sure you want to delete this message?"))if(r.remove(),this.selectedHistoryIndex>=0){const t=this.chatHistory[this.selectedHistoryIndex].findIndex((t=>t.content===e&&!t.isUser));-1!==t&&(this.chatHistory[this.selectedHistoryIndex].splice(t,1),localStorage.setItem("chatHistory",JSON.stringify(this.chatHistory)))}else{const t=this.currentChatHistory.findIndex((t=>t.content===e&&!t.isUser));-1!==t&&(this.currentChatHistory.splice(t,1),localStorage.setItem("chatHistory",JSON.stringify(this.chatHistory)))}})),a.appendChild(p),r.appendChild(a),r.addEventListener("mouseenter",(()=>{a.style.display="flex"})),r.addEventListener("mouseleave",(()=>{a.style.display="none"})),c.textContent=`${n||this.getModelName(i||this.selectedModel)} · ${s||(new Date).toLocaleTimeString()}`}r.appendChild(c),l.appendChild(r),setTimeout((()=>{l.scrollTop=l.scrollHeight}),100),o||localStorage.setItem("chatHistory",JSON.stringify(this.chatHistory))},async upsampleV6_2x_subtle(e){return await this.midjourney.submit("upsample_v6_2x_subtle",e,1)},async upsampleV6_2x_creative(e){return await this.midjourney.submit("upsample_v6_2x_creative",e,1)},async lowVariation(e){return await this.midjourney.submit("low_variation",e,1)},async highVariation(e){return await this.midjourney.submit("high_variation",e,1)},async Inpaint(e){return await this.midjourney.submit("Inpaint",e,1)},async Outpaint(e,t){return await this.midjourney.submit("Outpaint",e,1,{zoomLevel:t})},async CustomZoom(e){return await this.midjourney.submit("CustomZoom",e,1)},async panLeft(e){return await this.midjourney.submit("pan_left",e,1)},async panRight(e){return await this.midjourney.submit("pan_right",e,1)},async panUp(e){return await this.midjourney.submit("pan_up",e,1)},async panDown(e){return await this.midjourney.submit("pan_down",e,1)},async BOOKMARK(e){},getAvatarByAIName(e){if(this.customModels.includes(e)){return`https://api.comfly.chat=${e.split(" ").slice(0,2).map((e=>e.charAt(0))).join("")}`}switch(e){case"midjourney":return"https://api.comfly.chat/wp-content/uploads/2024/07/2024051701495031.png";case"gpt-4o-mini":return"https://api.comfly.chat/wp-content/uploads/2024/07/2024051400103274.png";case"gpt-4o":return"https://api.comfly.chat/wp-content/uploads/2024/07/ede7249fd4c26ed054473a3ae405038f-e1721394651139.jpeg";case"o1":return"https://api.comfly.chat/wp-content/uploads/2024/07/2024051400141556.webp";case"Claude3.5-Sonnet":case"Claude3-opus":return"https://api.comfly.chat/wp-content/uploads/2024/07/2024051710414540.png";case"deepseek-r1":return"https://api.comfly.chat/wp-content/uploads/2025/02/u30873412593672443986fm253fmtautoapp120fJPEG.webp";case"moonshot-v1":return"https://api.comfly.chat/wp-content/uploads/2024/07/2024062013373651.png";case"gemini-1.5-pro":return"https://api.comfly.chat/wp-content/uploads/2024/07/2024062013373534.png";case"qwen-plus":case"qwen-max":return"https://api.comfly.chat/wp-content/uploads/2024/07/2024062013373562.png";case"glm-4v":return"https://api.comfly.chat/wp-content/uploads/2024/07/2024062013373533.png";default:return"https://api.comfly.chat/wp-content/uploads/2024/07/QQ图片20240730175428_美图抠图20240730.png"}},getAvatarByModel(e){if(this.customModels.includes(e)){return`https://api.comfly.chat=${e.split(" ").slice(0,2).map((e=>e.charAt(0))).join("")}`}switch(e){case"midjourney":return"https://api.comfly.chat/wp-content/uploads/2024/07/2024051701495031.png";case"gpt-4o-mini":return"https://api.comfly.chat/wp-content/uploads/2024/07/2024051400103274.png";case"gpt-4o":return"https://api.comfly.chat/wp-content/uploads/2024/07/ede7249fd4c26ed054473a3ae405038f-e1721394651139.jpeg";case"o1":return"https://api.comfly.chat/wp-content/uploads/2024/07/2024051400141556.webp";case"Claude3.5-Sonnet":case"Claude3-opus":return"https://api.comfly.chat/wp-content/uploads/2024/07/2024051710414540.png";case"deepseek-r1":return"https://api.comfly.chat/wp-content/uploads/2025/02/u30873412593672443986fm253fmtautoapp120fJPEG.webp";case"moonshot-v1":return"https://api.comfly.chat/wp-content/uploads/2024/07/2024062013373651.png";case"gemini-1.5-pro":return"https://api.comfly.chat/wp-content/uploads/2024/07/2024062013373534.png";case"qwen-plus":case"qwen-max":return"https://api.comfly.chat/wp-content/uploads/2024/07/2024062013373562.png";case"glm-4v":return"https://api.comfly.chat/wp-content/uploads/2024/07/2024062013373533.png";default:return"https://api.comfly.chat/wp-content/uploads/2024/07/QQ图片20240730175428_美图抠图20240730.png"}},getModelName(e){if(this.customModels.includes(e))return e;switch(e){case"midjourney":return"Midjourney";case"gpt-4o-mini":return"gpt-4o-mini";case"gpt-4o":return"gpt-4o";case"o1":return"o1";case"claude-3-opus-20240229":return"Claude3-opus";case"claude-3-5-sonnet-20241022":return"Claude3.5-Sonnet";case"deepseek-r1":return"deepseek-r1";case"moonshot-v1-128k":return"moonshot-v1";case"gemini-1.5-pro":return"gemini-1.5-pro";case"qwen-plus":return"qwen-plus";case"qwen-max":return"qwen-max";case"glm-4v":return"glm-4v";default:return"AI"}},loadChatHistory(){const e=localStorage.getItem("chatHistory");e&&(this.chatHistory=JSON.parse(e))}};chatButton.init(),window.chatButton=chatButton;